---
import Header from '../components/layout/header.tsx';
import { Toaster } from '../lib/notifications';
import { toasterConfig } from '../lib/notifications';
import Analytics from '../components/analytics/Analytics.tsx';
import CookieConsent from '../components/analytics/CookieConsent.tsx';
import CompareBar from '../components/products/CompareBar';
import ChatWidget from '../components/support/ChatWidget';
import PromoPopupDisplay from '../components/promo/PromoPopupDisplay';
import WelcomeBonusPopup from '../components/common/WelcomeBonusPopup';
import LeadSignupPopup from '../components/common/LeadSignupPopup';
import '../styles/global.css';

interface Props {
  title: string;
  description?: string;
  ogImage?: string;
}

const {
  title,
  description = 'Especialistas en personalizaci칩n: estampado, bordado, impresi칩n 3D, corte l치ser y mucho m치s.',
  ogImage = '/og-image.jpg',
} = Astro.props;
const nonce = Astro.locals?.cspNonce;
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />

    <meta property="og:type" content="website" />
    <meta property="og:url" content={Astro.url} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={new URL(ogImage, Astro.url)} />

    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={Astro.url} />
    <meta property="twitter:title" content={title} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={new URL(ogImage, Astro.url)} />

    <link rel="icon" href="/favicon.ico" sizes="any" />
    <link rel="icon" type="image/png" href="/logoFac.png" />

    <!-- Prefetch critical routes for faster navigation -->
    <link rel="prefetch" href="/checkout" />
    <link rel="prefetch" href="/cuenta/pedidos" />
    <link rel="prefetch" href="/productos" />
    <link rel="dns-prefetch" href="https://firebasestorage.googleapis.com" />
    <link rel="dns-prefetch" href="https://www.googleapis.com" />

    <title>{title}</title>
    <script is:inline nonce={nonce}>
      (() => {
        let initialized = false;

        const setHeaderHeight = () => {
          const header = document.querySelector('header');
          if (!header) return;
          const height = Math.ceil(header.getBoundingClientRect().height);
          document.documentElement.style.setProperty('--header-height', `${height}px`);
        };

        const init = () => {
          if (initialized) return;
          const header = document.querySelector('header');
          if (!header) {
            requestAnimationFrame(init);
            return;
          }
          initialized = true;
          setHeaderHeight();

          if (typeof ResizeObserver !== 'undefined') {
            const observer = new ResizeObserver(setHeaderHeight);
            observer.observe(header);
          } else {
            window.addEventListener('resize', setHeaderHeight);
          }
        };

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', init, { once: true });
        } else {
          init();
        }
      })();
    </script>
  </head>
  <body class="bg-white min-h-screen">
    <a class="skip-link" href="#contenido-principal">Saltar al contenido principal</a>
    <Header client:load />
    <main id="contenido-principal">
      <slot />
    </main>
    <!-- Toast Notifications Container -->
    <Toaster {...toasterConfig} client:load />
    <!-- Product Comparison Bar -->
    <CompareBar client:load />
    <!-- Chat Support Widget -->
    <ChatWidget client:idle />
    <!-- Promotional Popups -->
    <PromoPopupDisplay client:idle />
    <WelcomeBonusPopup client:load />
    <LeadSignupPopup client:load />
    <!-- Cookie Consent Banner -->
    <CookieConsent client:load />
    <!-- Analytics Tracking -->
    <Analytics client:load />
  </body>
</html>
