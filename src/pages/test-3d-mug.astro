---
import BaseLayout from '../layouts/BaseLayout.astro';
import { requireAdminPage, AUTH_COOKIE_NAME } from '../lib/auth/requireAdminPage';

const guardResponse = await requireAdminPage(
  Astro.request,
  Astro.url,
  Astro.cookies.get(AUTH_COOKIE_NAME)?.value
);

if (guardResponse) {
  return guardResponse;
}
---

<BaseLayout title="Test 3D Mug Preview">
  <div class="min-h-screen bg-gray-50 py-12">
    <div class="max-w-6xl mx-auto px-4">
      <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-900 mb-2">
          üé® Vista Previa 3D - Tazas & Termos
        </h1>
        <p class="text-gray-600">
          Sube tu dise√±o y ve c√≥mo quedar√° en tu producto
        </p>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        {/* Panel izquierdo - Controles */}
        <div class="bg-white rounded-xl shadow-lg p-6">
          <h2 class="text-2xl font-bold text-gray-900 mb-6">Configuraci√≥n</h2>

          {/* Selector de tipo de producto */}
          <div class="mb-6">
            <label class="block text-sm font-bold text-gray-700 mb-2">
              Tipo de Producto
            </label>
            <div class="grid grid-cols-3 gap-3">
              <button
                id="btn-mug"
                class="product-type-btn active px-4 py-3 rounded-lg border-2 border-purple-500 bg-purple-50 font-semibold text-purple-700 transition-all hover:shadow-md"
                data-type="mug"
              >
                ‚òï Taza
              </button>
              <button
                id="btn-thermos"
                class="product-type-btn px-4 py-3 rounded-lg border-2 border-gray-300 bg-white font-semibold text-gray-700 transition-all hover:shadow-md"
                data-type="thermos"
              >
                üçµ Termo
              </button>
              <button
                id="btn-bottle"
                class="product-type-btn px-4 py-3 rounded-lg border-2 border-gray-300 bg-white font-semibold text-gray-700 transition-all hover:shadow-md"
                data-type="bottle"
              >
                üß¥ Botella
              </button>
            </div>
          </div>

          {/* Subir imagen */}
          <div class="mb-6">
            <label class="block text-sm font-bold text-gray-700 mb-2">
              Sube tu Dise√±o
            </label>
            <input
              type="file"
              id="image-upload"
              accept="image/*"
              class="block w-full text-sm text-gray-500
                file:mr-4 file:py-3 file:px-6
                file:rounded-lg file:border-0
                file:text-sm file:font-semibold
                file:bg-purple-500 file:text-white
                hover:file:bg-purple-600
                file:cursor-pointer
                cursor-pointer"
            />
            <p class="text-xs text-gray-500 mt-2">
              PNG, JPG hasta 10MB ‚Ä¢ Mejor resoluci√≥n: 2000x2000px
            </p>
          </div>

          {/* Im√°genes de ejemplo */}
          <div class="mb-6">
            <label class="block text-sm font-bold text-gray-700 mb-2">
              O prueba con ejemplos:
            </label>
            <div class="grid grid-cols-2 gap-3">
              <button
                class="example-image p-3 border-2 border-gray-300 rounded-lg hover:border-purple-500 transition-all"
                data-url="https://images.unsplash.com/photo-1579783902614-a3fb3927b6a5?w=800&q=80"
              >
                <img
                  src="https://images.unsplash.com/photo-1579783902614-a3fb3927b6a5?w=200&q=80"
                  alt="Dise√±o abstracto"
                  class="w-full h-24 object-cover rounded"
                />
                <p class="text-xs text-gray-600 mt-2">Abstracto</p>
              </button>
              <button
                class="example-image p-3 border-2 border-gray-300 rounded-lg hover:border-purple-500 transition-all"
                data-url="https://images.unsplash.com/photo-1557672172-298e090bd0f1?w=800&q=80"
              >
                <img
                  src="https://images.unsplash.com/photo-1557672172-298e090bd0f1?w=200&q=80"
                  alt="Dise√±o floral"
                  class="w-full h-24 object-cover rounded"
                />
                <p class="text-xs text-gray-600 mt-2">Floral</p>
              </button>
            </div>
          </div>

          {/* Informaci√≥n */}
          <div class="p-4 bg-blue-50 border-2 border-blue-200 rounded-lg">
            <h3 class="font-bold text-blue-900 mb-2">üí° Consejos</h3>
            <ul class="text-sm text-blue-800 space-y-1">
              <li>‚Ä¢ Usa im√°genes de alta resoluci√≥n</li>
              <li>‚Ä¢ Fondos transparentes se ven mejor</li>
              <li>‚Ä¢ El dise√±o se envuelve alrededor del producto</li>
              <li>‚Ä¢ Arrastra con el mouse para rotar</li>
            </ul>
          </div>
        </div>

        {/* Panel derecho - Vista 3D */}
        <div class="bg-white rounded-xl shadow-lg p-6">
          <h2 class="text-2xl font-bold text-gray-900 mb-6">Vista Previa 3D</h2>
          <div id="preview-container"></div>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  import { createRoot } from 'react-dom/client';
  import { createElement } from 'react';
  import ThreeDMugPreview from '../components/3d/ThreeDMugPreview';

  let currentImageUrl: string | undefined = undefined;
  let currentProductType: 'mug' | 'thermos' | 'bottle' = 'mug';
  let reactRoot: any = null;

  function renderPreview() {
    console.log('[test-3d-mug] renderPreview called with:', {
      currentImageUrl,
      currentProductType
    });

    const container = document.getElementById('preview-container');
    if (!container) {
      console.error('[test-3d-mug] Container not found!');
      return;
    }

    console.log('[test-3d-mug] Container found:', container);

    // Crear root solo la primera vez
    if (!reactRoot) {
      console.log('[test-3d-mug] Creating React root');
      reactRoot = createRoot(container);
    }

    // Renderizar (o re-renderizar) componente React
    console.log('[test-3d-mug] Rendering ThreeDMugPreview component');
    reactRoot.render(
      createElement(ThreeDMugPreview, {
        imageUrl: currentImageUrl,
        productType: currentProductType,
        backgroundColor: '#f5f5f5'
      })
    );
    console.log('[test-3d-mug] Render complete');
  }

  // Cambiar tipo de producto
  document.querySelectorAll('.product-type-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const target = e.currentTarget as HTMLElement;
      const type = target.dataset.type as 'mug' | 'thermos' | 'bottle';

      // Actualizar botones activos
      document.querySelectorAll('.product-type-btn').forEach(b => {
        b.classList.remove('active', 'border-purple-500', 'bg-purple-50', 'text-purple-700');
        b.classList.add('border-gray-300', 'bg-white', 'text-gray-700');
      });

      target.classList.add('active', 'border-purple-500', 'bg-purple-50', 'text-purple-700');
      target.classList.remove('border-gray-300', 'bg-white', 'text-gray-700');

      currentProductType = type;
      renderPreview();
    });
  });

  // Subir imagen
  const imageUpload = document.getElementById('image-upload') as HTMLInputElement;
  if (imageUpload) {
    imageUpload.addEventListener('change', (e) => {
      const target = e.target as HTMLInputElement;
      const file = target.files?.[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          currentImageUrl = event.target?.result as string;
          renderPreview();
        };
        reader.readAsDataURL(file);
      }
    });
  }

  // Im√°genes de ejemplo
  document.querySelectorAll('.example-image').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const target = e.currentTarget as HTMLElement;
      const url = target.dataset.url;
      if (url) {
        currentImageUrl = url;
        renderPreview();
      }
    });
  });

  // Renderizar inicial
  renderPreview();
</script>

<style>
  .product-type-btn {
    cursor: pointer;
  }

  .example-image {
    cursor: pointer;
  }

  .example-image:hover img {
    transform: scale(1.05);
  }

  .example-image img {
    transition: transform 0.2s;
  }
</style>
