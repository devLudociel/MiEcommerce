---
import BaseLayout from '@/layouts/BaseLayout.astro';
---

<BaseLayout title="Editor 2D Profesional - Prueba">
  <div style="padding: 20px; max-width: 1400px; margin: 0 auto;">
    <div style="margin-bottom: 30px;">
      <h1 style="font-size: 32px; font-weight: bold; color: #111827; margin-bottom: 12px;">
        üé® Editor 2D Profesional
      </h1>
      <p style="color: #6b7280; font-size: 16px;">
        Editor profesional para personalizar productos en 2D con herramientas avanzadas
      </p>
    </div>

    <!-- Controles de prueba -->
    <div style="background: white; border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
      <h2 style="font-size: 20px; font-weight: 600; color: #111827; margin-bottom: 16px;">
        Controles de Prueba
      </h2>

      <div style="display: flex; gap: 16px; flex-wrap: wrap; align-items: end;">
        <!-- Input de imagen -->
        <div>
          <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">
            Cargar Dise√±o
          </label>
          <input
            type="file"
            id="image-input"
            accept="image/*"
            style="padding: 8px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; cursor: pointer; background: white;"
          />
        </div>

        <!-- Bot√≥n para generar canvas de prueba -->
        <div>
          <button
            id="generate-test-design"
            style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;"
          >
            Generar Dise√±o de Prueba
          </button>
        </div>

        <!-- Bot√≥n de resetear -->
        <div>
          <button
            id="clear-design"
            style="padding: 10px 20px; background: #ef4444; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;"
          >
            Limpiar
          </button>
        </div>
      </div>

      <!-- Info sobre el estado actual -->
      <div id="design-info" style="margin-top: 16px; padding: 12px; background: #f3f4f6; border-radius: 8px; font-size: 13px; color: #6b7280;">
        <strong>Estado:</strong> Sin dise√±o cargado
      </div>
    </div>

    <!-- Editor Container -->
    <div style="background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden;">
      <!-- Barra de herramientas -->
      <div id="toolbar" style="background: #ffffff; border-bottom: 1px solid #e5e7eb; padding: 16px; display: flex; gap: 12px; flex-wrap: wrap; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <div style="fontSize: 14px; font-weight: 600; color: #374151; margin-right: 12px; padding-right: 12px; border-right: 1px solid #e5e7eb;">
          Taza
        </div>

        <button class="tool-btn" data-action="center">üìç Centrar</button>
        <button class="tool-btn" data-action="rotate-left">‚Ü∫ -90¬∞</button>
        <button class="tool-btn" data-action="rotate-right">‚Üª +90¬∞</button>
        <button class="tool-btn" data-action="reset-rotation">üîÑ Reset</button>

        <div style="width: 1px; background: #e5e7eb; margin: 0 8px;"></div>

        <button class="tool-btn" data-action="scale-down">üîç‚àí Reducir</button>
        <button class="tool-btn" data-action="scale-up">üîç+ Ampliar</button>
        <button class="tool-btn" data-action="reset-scale">100%</button>

        <div style="width: 1px; background: #e5e7eb; margin: 0 8px;"></div>

        <button class="tool-btn toggle" data-action="toggle-grid" data-active="true"># Grid</button>
        <button class="tool-btn toggle" data-action="toggle-guides" data-active="true">+ Gu√≠as</button>
      </div>

      <!-- Canvas √°rea -->
      <div style="padding: 24px; background: #fafafa; display: flex; align-items: center; justify-content: center; min-height: 500px;">
        <canvas
          id="editor-canvas"
          width="600"
          height="400"
          style="box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15); border-radius: 8px; cursor: grab; background: #ffffff; max-width: 100%; height: auto;"
        ></canvas>
      </div>

      <!-- Panel de informaci√≥n -->
      <div id="info-panel" style="background: #ffffff; border-top: 1px solid #e5e7eb; padding: 12px 16px; display: flex; gap: 16px; font-size: 13px; color: #6b7280; box-shadow: 0 -1px 3px rgba(0,0,0,0.1); flex-wrap: wrap;">
        <div style="color: #9ca3af;">
          üì§ Carga una imagen para empezar a dise√±ar
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<style>
  .tool-btn {
    padding: 8px 14px;
    background: #f3f4f6;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 500;
    color: #374151;
    transition: all 0.2s;
  }

  .tool-btn:hover {
    background: #e5e7eb;
  }

  .tool-btn.toggle[data-active="true"] {
    background: #3b82f6;
    color: #ffffff;
  }

  #generate-test-design:hover {
    background: #2563eb;
  }

  #clear-design:hover {
    background: #dc2626;
  }

  #editor-canvas.dragging {
    cursor: grabbing;
  }
</style>

<script>
  // Estado del editor
  let designImage: HTMLImageElement | null = null;
  let showGrid = true;
  let showGuides = true;
  let isDragging = false;

  // Configuraci√≥n del producto
  const template = {
    width: 600,
    height: 400,
    printAreaX: 150,
    printAreaY: 100,
    printAreaWidth: 300,
    printAreaHeight: 200,
    label: 'Taza'
  };

  // Estado del dise√±o
  let design = {
    x: template.printAreaX + template.printAreaWidth / 2,
    y: template.printAreaY + template.printAreaHeight / 2,
    width: 200,
    height: 200,
    rotation: 0,
    scale: 1
  };

  let dragStart = { x: 0, y: 0, designX: 0, designY: 0 };

  // Obtener canvas
  const canvas = document.getElementById('editor-canvas') as HTMLCanvasElement;
  const ctx = canvas?.getContext('2d');

  if (!canvas || !ctx) {
    console.error('[Editor] Canvas not found');
  } else {
    console.log('[Editor] Canvas initialized');
  }

  // Funci√≥n para renderizar el canvas
  function render() {
    if (!ctx || !canvas) return;

    console.log('[Editor] Rendering canvas');

    // Limpiar
    ctx.clearRect(0, 0, template.width, template.height);

    // Fondo
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, template.width, template.height);
    ctx.strokeStyle = '#d0d0d0';
    ctx.lineWidth = 2;
    ctx.strokeRect(0, 0, template.width, template.height);

    // Grid
    if (showGrid) {
      ctx.strokeStyle = '#eeeeee';
      ctx.lineWidth = 1;
      const gridSize = 20;

      for (let x = 0; x <= template.width; x += gridSize) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, template.height);
        ctx.stroke();
      }

      for (let y = 0; y <= template.height; y += gridSize) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(template.width, y);
        ctx.stroke();
      }
    }

    // √Årea de impresi√≥n
    ctx.fillStyle = 'rgba(59, 130, 246, 0.05)';
    ctx.fillRect(template.printAreaX, template.printAreaY, template.printAreaWidth, template.printAreaHeight);
    ctx.strokeStyle = '#3b82f6';
    ctx.lineWidth = 2;
    ctx.setLineDash([8, 4]);
    ctx.strokeRect(template.printAreaX, template.printAreaY, template.printAreaWidth, template.printAreaHeight);
    ctx.setLineDash([]);

    // Etiqueta
    ctx.fillStyle = '#3b82f6';
    ctx.font = 'bold 14px sans-serif';
    ctx.fillText('√Årea de impresi√≥n', template.printAreaX + 10, template.printAreaY + 25);

    // Gu√≠as
    if (showGuides) {
      ctx.strokeStyle = '#f59e0b';
      ctx.lineWidth = 1;
      ctx.setLineDash([4, 4]);

      const centerX = template.printAreaX + template.printAreaWidth / 2;
      const centerY = template.printAreaY + template.printAreaHeight / 2;

      ctx.beginPath();
      ctx.moveTo(centerX, template.printAreaY);
      ctx.lineTo(centerX, template.printAreaY + template.printAreaHeight);
      ctx.stroke();

      ctx.beginPath();
      ctx.moveTo(template.printAreaX, centerY);
      ctx.lineTo(template.printAreaX + template.printAreaWidth, centerY);
      ctx.stroke();

      ctx.setLineDash([]);
    }

    // Dibujar imagen si existe
    if (designImage) {
      ctx.save();

      ctx.translate(design.x, design.y);
      ctx.rotate((design.rotation * Math.PI) / 180);
      ctx.scale(design.scale, design.scale);

      const drawWidth = design.width;
      const drawHeight = design.height;

      ctx.drawImage(designImage, -drawWidth / 2, -drawHeight / 2, drawWidth, drawHeight);

      // Borde de selecci√≥n
      ctx.strokeStyle = '#10b981';
      ctx.lineWidth = 3;
      ctx.setLineDash([6, 3]);
      ctx.strokeRect(-drawWidth / 2, -drawHeight / 2, drawWidth, drawHeight);
      ctx.setLineDash([]);

      // Handles
      const handleSize = 10;
      ctx.fillStyle = '#10b981';

      [
        [-drawWidth / 2, -drawHeight / 2],
        [drawWidth / 2, -drawHeight / 2],
        [drawWidth / 2, drawHeight / 2],
        [-drawWidth / 2, drawHeight / 2]
      ].forEach(([x, y]) => {
        ctx.fillRect(x - handleSize / 2, y - handleSize / 2, handleSize, handleSize);
      });

      ctx.restore();
    }

    updateInfoPanel();
  }

  function updateInfoPanel() {
    const infoPanel = document.getElementById('info-panel');
    if (!infoPanel) return;

    if (designImage) {
      infoPanel.innerHTML = `
        <div><strong>Posici√≥n:</strong> X: ${Math.round(design.x)}px, Y: ${Math.round(design.y)}px</div>
        <div><strong>Tama√±o:</strong> ${Math.round(design.width * design.scale)} √ó ${Math.round(design.height * design.scale)}px</div>
        <div><strong>Rotaci√≥n:</strong> ${Math.round(design.rotation)}¬∞</div>
        <div><strong>Escala:</strong> ${Math.round(design.scale * 100)}%</div>
        <div style="margin-left: auto; color: #10b981; font-weight: 500;">üí° Arrastra para mover el dise√±o</div>
      `;
    } else {
      infoPanel.innerHTML = '<div style="color: #9ca3af;">üì§ Carga una imagen para empezar a dise√±ar</div>';
    }
  }

  // Mouse events
  if (canvas) {
    canvas.addEventListener('mousedown', (e) => {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      dragStart = { x, y, designX: design.x, designY: design.y };
      isDragging = true;
      canvas.classList.add('dragging');
    });

    canvas.addEventListener('mousemove', (e) => {
      if (!isDragging) return;

      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      const dx = x - dragStart.x;
      const dy = y - dragStart.y;

      design.x = dragStart.designX + dx;
      design.y = dragStart.designY + dy;

      render();
    });

    canvas.addEventListener('mouseup', () => {
      isDragging = false;
      canvas.classList.remove('dragging');
    });

    canvas.addEventListener('mouseleave', () => {
      isDragging = false;
      canvas.classList.remove('dragging');
    });
  }

  // Herramientas
  const toolButtons = document.querySelectorAll('.tool-btn');
  toolButtons.forEach(btn => {
    btn.addEventListener('click', (e) => {
      const action = (e.target as HTMLElement).getAttribute('data-action');
      console.log('[Editor] Tool action:', action);

      switch (action) {
        case 'center':
          design.x = template.printAreaX + template.printAreaWidth / 2;
          design.y = template.printAreaY + template.printAreaHeight / 2;
          break;
        case 'rotate-left':
          design.rotation -= 90;
          break;
        case 'rotate-right':
          design.rotation += 90;
          break;
        case 'reset-rotation':
          design.rotation = 0;
          break;
        case 'scale-down':
          design.scale = Math.max(design.scale - 0.1, 0.1);
          break;
        case 'scale-up':
          design.scale = Math.min(design.scale + 0.1, 3);
          break;
        case 'reset-scale':
          design.scale = 1;
          break;
        case 'toggle-grid':
          showGrid = !showGrid;
          (e.target as HTMLElement).setAttribute('data-active', showGrid.toString());
          break;
        case 'toggle-guides':
          showGuides = !showGuides;
          (e.target as HTMLElement).setAttribute('data-active', showGuides.toString());
          break;
      }

      render();
    });
  });

  // Cargar imagen
  const imageInput = document.getElementById('image-input') as HTMLInputElement;
  if (imageInput) {
    imageInput.addEventListener('change', (e) => {
      const file = (e.target as HTMLInputElement).files?.[0];
      if (!file) {
        console.warn('[Editor] No file selected');
        return;
      }

      console.log('[Editor] Image file selected:', file.name);

      const reader = new FileReader();
      reader.onload = (event) => {
        const img = new Image();
        img.onload = () => {
          console.log('[Editor] Image loaded:', img.width, 'x', img.height);
          designImage = img;

          const aspectRatio = img.width / img.height;
          design.width = Math.min(template.printAreaWidth * 0.6, 200);
          design.height = design.width / aspectRatio;
          design.scale = 1;
          design.rotation = 0;

          render();

          const infoDiv = document.getElementById('design-info');
          if (infoDiv) {
            infoDiv.innerHTML = '<strong>Estado:</strong> Imagen cargada correctamente ‚úÖ';
          }
        };
        img.src = event.target?.result as string;
      };
      reader.onerror = () => {
        console.error('[Editor] Error reading file');
        alert('Error al cargar la imagen');
      };
      reader.readAsDataURL(file);
    });
  }

  // Generar dise√±o de prueba
  const generateBtn = document.getElementById('generate-test-design');
  if (generateBtn) {
    generateBtn.addEventListener('click', () => {
      console.log('[Editor] Generating test design');

      const testCanvas = document.createElement('canvas');
      testCanvas.width = 400;
      testCanvas.height = 400;
      const testCtx = testCanvas.getContext('2d');

      if (!testCtx) return;

      // Fondo degradado
      const gradient = testCtx.createLinearGradient(0, 0, 400, 400);
      gradient.addColorStop(0, '#3b82f6');
      gradient.addColorStop(1, '#8b5cf6');
      testCtx.fillStyle = gradient;
      testCtx.fillRect(0, 0, 400, 400);

      // Texto
      testCtx.fillStyle = '#ffffff';
      testCtx.font = 'bold 48px sans-serif';
      testCtx.textAlign = 'center';
      testCtx.textBaseline = 'middle';
      testCtx.fillText('MI DISE√ëO', 200, 180);

      testCtx.font = '24px sans-serif';
      testCtx.fillText('Personalizado', 200, 220);

      // C√≠rculo
      testCtx.strokeStyle = '#ffffff';
      testCtx.lineWidth = 4;
      testCtx.beginPath();
      testCtx.arc(200, 200, 150, 0, Math.PI * 2);
      testCtx.stroke();

      const img = new Image();
      img.onload = () => {
        designImage = img;
        design.width = 200;
        design.height = 200;
        design.scale = 1;
        design.rotation = 0;
        render();

        const infoDiv = document.getElementById('design-info');
        if (infoDiv) {
          infoDiv.innerHTML = '<strong>Estado:</strong> Dise√±o de prueba generado ‚úÖ';
        }
      };
      img.src = testCanvas.toDataURL();
    });
  }

  // Limpiar
  const clearBtn = document.getElementById('clear-design');
  if (clearBtn) {
    clearBtn.addEventListener('click', () => {
      console.log('[Editor] Clearing design');
      designImage = null;
      design.rotation = 0;
      design.scale = 1;
      render();

      if (imageInput) {
        imageInput.value = '';
      }

      const infoDiv = document.getElementById('design-info');
      if (infoDiv) {
        infoDiv.innerHTML = '<strong>Estado:</strong> Sin dise√±o cargado';
      }
    });
  }

  // Renderizado inicial
  console.log('[Editor] Initial render');
  render();
</script>
</BaseLayout>
