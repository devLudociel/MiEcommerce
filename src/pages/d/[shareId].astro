---
import BaseLayout from '../../layouts/BaseLayout.astro';

export const prerender = false;

const { shareId } = Astro.params;
const nonce = Astro.locals?.cspNonce;

// Redirect if no shareId
if (!shareId) {
  return Astro.redirect('/');
}
---

<BaseLayout title="Diseño Compartido">
  <div class="min-h-screen bg-gradient-to-br from-purple-50 via-white to-cyan-50 py-12">
    <div class="container mx-auto px-4">
      <div id="shared-design-viewer" data-share-id={shareId}>
        {/* Loading state */}
        <div id="loading-state" class="text-center py-20">
          <div class="w-16 h-16 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p class="text-gray-600 text-lg">Cargando dise�o compartido...</p>
        </div>

        {/* Error state (hidden initially) */}
        <div id="error-state" class="hidden">
          <div class="max-w-2xl mx-auto text-center">
            <div class="bg-red-50 border-2 border-red-200 rounded-2xl p-8">
              <div class="text-6xl mb-4">L</div>
              <h2 class="text-2xl font-bold text-red-900 mb-2">Dise�o no encontrado</h2>
              <p class="text-red-700 mb-6" id="error-message">
                Este enlace puede haber expirado o no ser v�lido.
              </p>
              <a href="/" class="btn bg-gradient-to-r from-cyan-500 to-purple-600 text-white px-8 py-3 rounded-xl font-bold hover:shadow-lg transition-all inline-block">
                Volver al inicio
              </a>
            </div>
          </div>
        </div>

        {/* Content state (hidden initially) */}
        <div id="content-state" class="hidden">
          <div class="max-w-5xl mx-auto">
            {/* Header */}
            <div class="text-center mb-8">
              <h1 class="text-4xl font-bold bg-gradient-to-r from-cyan-500 to-purple-600 bg-clip-text text-transparent mb-2">
                Dise�o Compartido
              </h1>
              <p class="text-gray-600" id="product-name">Cargando...</p>
            </div>

            {/* Design Preview Card */}
            <div class="bg-white rounded-2xl shadow-2xl overflow-hidden mb-8">
              {/* Preview Image */}
              <div class="relative bg-gray-100" style="aspect-ratio: 16/9;">
                <img
                  id="preview-image"
                  src=""
                  alt="Vista previa del dise�o"
                  class="w-full h-full object-contain"
                />
              </div>

              {/* Info Section */}
              <div class="p-8">
                <div class="flex items-center gap-2 text-sm text-gray-500 mb-6">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                  </svg>
                  <span>Alguien ha compartido este dise�o contigo</span>
                </div>

                <div class="space-y-4">
                  <div>
                    <h3 class="text-sm font-semibold text-gray-700 mb-2">Personalizaci�n:</h3>
                    <div id="customization-details" class="space-y-2">
                      {/* Populated dynamically */}
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {/* Action Buttons */}
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
              <button
                id="use-design-btn"
                class="btn bg-gradient-to-r from-cyan-500 to-purple-600 text-white px-8 py-4 rounded-xl font-bold text-lg hover:shadow-lg transition-all flex items-center justify-center gap-3"
              >
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                </svg>
                Usar este dise�o
              </button>

              <a
                href="/"
                class="btn btn-outline border-2 border-gray-300 px-8 py-4 rounded-xl font-bold text-lg hover:border-cyan-500 transition-all flex items-center justify-center gap-3"
              >
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                Explorar productos
              </a>
            </div>

            {/* Social Proof */}
            <div class="text-center mt-8 text-sm text-gray-500">
              <p>=� �Te gust� este dise�o? �Personal�zalo a tu gusto o cr�alo tal cual est�!</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script nonce={nonce}>
    // Fetch and display shared design
    async function loadSharedDesign() {
      const container = document.getElementById('shared-design-viewer');
      const shareId = container?.getAttribute('data-share-id');

      if (!shareId) {
        showError('ID de dise�o no v�lido');
        return;
      }

      try {
        const response = await fetch(`/api/share/${shareId}`);

        if (!response.ok) {
          const errorData = await response.json();
          showError(errorData.error || 'Error al cargar el dise�o');
          return;
        }

        const { data } = await response.json();

        // Hide loading, show content
        document.getElementById('loading-state')?.classList.add('hidden');
        document.getElementById('content-state')?.classList.remove('hidden');

        // Populate product name
        const productNameEl = document.getElementById('product-name');
        if (productNameEl) {
          productNameEl.textContent = data.productName;
        }

        // Populate preview image
        const previewImageEl = document.getElementById('preview-image') as HTMLImageElement;
        if (previewImageEl && data.imageUrl) {
          previewImageEl.src = data.imageUrl;
        }

        // Populate customization details
        displayCustomizationDetails(data.designData);

        // Setup "Use this design" button
        const useDesignBtn = document.getElementById('use-design-btn');
        if (useDesignBtn) {
          useDesignBtn.addEventListener('click', () => {
            useSharedDesign(data.productId, data.designData);
          });
        }
      } catch (error) {
        console.error('[SharedDesign] Error loading design:', error);
        showError('Error de conexi�n. Por favor, int�ntalo de nuevo.');
      }
    }

    function displayCustomizationDetails(designData: any) {
      const container = document.getElementById('customization-details');
      if (!container || !designData || !designData.values) return;

      // Clear existing content
      container.innerHTML = '';

      // Display each customization value
      Object.entries(designData.values).forEach(([fieldId, value]: [string, any]) => {
        const detailDiv = document.createElement('div');
        detailDiv.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';

        const labelSpan = document.createElement('span');
        labelSpan.className = 'text-sm font-medium text-gray-700';
        labelSpan.textContent = value.fieldLabel || fieldId;

        const valueSpan = document.createElement('span');
        valueSpan.className = 'text-sm text-gray-600';
        valueSpan.textContent = value.displayValue || value.value || '-';

        detailDiv.appendChild(labelSpan);
        detailDiv.appendChild(valueSpan);
        container.appendChild(detailDiv);
      });
    }

    function useSharedDesign(productId: string, designData: any) {
      // Save design data to localStorage with shared_ prefix
      const sharedDesignKey = `shared_${productId}`;
      localStorage.setItem(sharedDesignKey, JSON.stringify({
        values: designData.values || {},
        layers: designData.layers || [],
        timestamp: Date.now(),
      }));

      console.log('[SharedDesign] Design data saved to localStorage');

      // Redirect to product page with shared parameter
      window.location.href = `/producto/${productId}?shared=true`;
    }

    function showError(message: string) {
      document.getElementById('loading-state')?.classList.add('hidden');
      document.getElementById('error-state')?.classList.remove('hidden');

      const errorMessageEl = document.getElementById('error-message');
      if (errorMessageEl) {
        errorMessageEl.textContent = message;
      }
    }

    // Load design on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadSharedDesign();
    });
  </script>
</BaseLayout>
