---
import BaseLayout from '../../layouts/BaseLayout.astro';
---

<BaseLayout title="Debug - Productos Digitales">
  <div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4">
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h1 class="text-2xl font-bold text-gray-900 mb-4">üîç Debug - Productos Digitales</h1>
        <p class="text-gray-600 mb-4">
          Esta herramienta te permite ver todos tus productos y verificar cu√°les tienen el campo <code class="bg-gray-100 px-2 py-1 rounded">isDigital: true</code>.
        </p>
        <button
          id="loadProducts"
          class="px-4 py-2 bg-cyan-600 text-white rounded-lg hover:bg-cyan-700"
        >
          Cargar Productos
        </button>
      </div>

      <div id="results" class="space-y-4"></div>
    </div>
  </div>
</BaseLayout>

<script>
  import { db } from '../../lib/firebase';
  import { collection, query, getDocs, doc, updateDoc } from 'firebase/firestore';

  const loadBtn = document.getElementById('loadProducts') as HTMLButtonElement;
  const resultsDiv = document.getElementById('results') as HTMLDivElement;

  loadBtn?.addEventListener('click', async () => {
    try {
      loadBtn.disabled = true;
      loadBtn.textContent = 'Cargando...';
      resultsDiv.innerHTML = '<p class="text-gray-600">Cargando productos...</p>';

      // Get all products
      const q = query(collection(db, 'products'));
      const snapshot = await getDocs(q);

      const products = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));

      console.log('Productos encontrados:', products);

      // Group products
      const digitalProducts = products.filter(p => p.isDigital === true);
      const nonDigitalProducts = products.filter(p => !p.isDigital);

      let html = `
        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
          <h3 class="font-bold text-green-900 mb-2">‚úÖ Productos Digitales (${digitalProducts.length})</h3>
          <p class="text-sm text-green-700">Estos productos tienen isDigital: true y aparecer√°n en /productos/digitales</p>
        </div>
      `;

      if (digitalProducts.length > 0) {
        html += '<div class="space-y-2 mb-6">';
        digitalProducts.forEach(product => {
          html += `
            <div class="bg-white border border-green-200 rounded-lg p-4">
              <div class="flex items-center justify-between">
                <div>
                  <h4 class="font-semibold text-gray-900">${product.name}</h4>
                  <div class="flex gap-2 text-xs text-gray-600 mt-1">
                    <span>ID: ${product.id}</span>
                    <span>‚Ä¢</span>
                    <span>Categor√≠a: ${product.category || 'N/A'}</span>
                    <span>‚Ä¢</span>
                    <span>Active: ${product.active ? '‚úÖ' : '‚ùå'}</span>
                    <span>‚Ä¢</span>
                    <span>isDigital: ‚úÖ</span>
                    ${product.digitalFiles ? `<span>‚Ä¢ ${product.digitalFiles.length} archivos</span>` : ''}
                  </div>
                </div>
              </div>
            </div>
          `;
        });
        html += '</div>';
      }

      html += `
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
          <h3 class="font-bold text-yellow-900 mb-2">‚ö†Ô∏è Productos NO Digitales (${nonDigitalProducts.length})</h3>
          <p class="text-sm text-yellow-700">Estos productos NO tienen isDigital: true. Si alguno deber√≠a ser digital, puedes actualizarlo.</p>
        </div>
      `;

      if (nonDigitalProducts.length > 0) {
        html += '<div class="space-y-2">';
        nonDigitalProducts.forEach(product => {
          html += `
            <div class="bg-white border border-gray-200 rounded-lg p-4">
              <div class="flex items-center justify-between">
                <div class="flex-1">
                  <h4 class="font-semibold text-gray-900">${product.name}</h4>
                  <div class="flex gap-2 text-xs text-gray-600 mt-1">
                    <span>ID: ${product.id}</span>
                    <span>‚Ä¢</span>
                    <span>Categor√≠a: ${product.category || 'N/A'}</span>
                    <span>‚Ä¢</span>
                    <span>Active: ${product.active ? '‚úÖ' : '‚ùå'}</span>
                    <span>‚Ä¢</span>
                    <span>isDigital: ‚ùå</span>
                  </div>
                </div>
                <button
                  class="mark-digital px-3 py-1 bg-cyan-600 text-white text-sm rounded hover:bg-cyan-700"
                  data-id="${product.id}"
                >
                  Marcar como Digital
                </button>
              </div>
            </div>
          `;
        });
        html += '</div>';
      }

      resultsDiv.innerHTML = html;

      // Add event listeners to buttons
      document.querySelectorAll('.mark-digital').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const target = e.target as HTMLButtonElement;
          const productId = target.dataset.id;
          if (!productId) return;

          try {
            target.disabled = true;
            target.textContent = 'Actualizando...';

            const productRef = doc(db, 'products', productId);
            await updateDoc(productRef, {
              isDigital: true,
              category: 'digital'
            });

            alert('‚úÖ Producto actualizado! Recarga la p√°gina para ver los cambios.');
          } catch (error) {
            console.error('Error updating product:', error);
            alert('‚ùå Error al actualizar: ' + (error instanceof Error ? error.message : 'Unknown error'));
            target.disabled = false;
            target.textContent = 'Marcar como Digital';
          }
        });
      });

    } catch (error) {
      console.error('Error loading products:', error);
      resultsDiv.innerHTML = `
        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
          <h3 class="font-bold text-red-900 mb-2">‚ùå Error</h3>
          <p class="text-red-700">${error instanceof Error ? error.message : 'Error desconocido'}</p>
        </div>
      `;
    } finally {
      loadBtn.disabled = false;
      loadBtn.textContent = 'Recargar Productos';
    }
  });
</script>
