---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="Arreglar Producto">
  <div class="min-h-screen bg-gradient-to-br from-purple-50 to-cyan-50 py-12">
    <div class="max-w-3xl mx-auto px-6">
      {/* Header */}
      <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-3">üîß Arreglar Producto</h1>
        <p class="text-gray-600">
          Verifica y arregla productos para que usen el customizer din√°mico
        </p>
      </div>

      {/* Form */}
      <div class="bg-white rounded-2xl shadow-xl p-8 mb-6">
        <label for="slug" class="block text-sm font-bold text-gray-900 mb-2">
          Slug del Producto:
        </label>
        <div class="flex gap-3">
          <input
            type="text"
            id="slug"
            placeholder="Ej: camisetauno"
            class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-lg"
          />
          <button
            id="checkBtn"
            class="px-6 py-3 bg-blue-500 text-white rounded-lg font-bold hover:bg-blue-600 transition-colors"
          >
            üîç Verificar
          </button>
          <button
            id="fixBtn"
            class="px-6 py-3 bg-green-500 text-white rounded-lg font-bold hover:bg-green-600 transition-colors"
          >
            ‚úÖ Arreglar
          </button>
        </div>
      </div>

      {/* Results */}
      <div id="results" class="hidden"></div>

      {/* Loading */}
      <div id="loading" class="hidden bg-white rounded-2xl shadow-xl p-12 text-center">
        <div class="w-16 h-16 border-4 border-purple-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
        <p class="text-gray-600 text-lg">Procesando...</p>
      </div>
    </div>
  </div>

  <script type="module">
    import { auth } from '../lib/firebase';
    import { getIdTokenResult } from 'firebase/auth';

    const slugInput = document.getElementById('slug') as HTMLInputElement;
    const checkBtn = document.getElementById('checkBtn')!;
    const fixBtn = document.getElementById('fixBtn')!;
    const results = document.getElementById('results')!;
    const loading = document.getElementById('loading')!;

    // XSS Protection: Escape HTML entities
    function escapeHtml(text: string | undefined | null): string {
      if (text == null) return '';
      const div = document.createElement('div');
      div.textContent = String(text);
      return div.innerHTML;
    }

    async function getAdminToken(): Promise<string | null> {
      const user = auth.currentUser;
      if (!user) return null;
      try {
        const tokenResult = await getIdTokenResult(user, true);
        if (!tokenResult.claims?.admin) {
          return null;
        }
        return tokenResult.token;
      } catch (e) {
        console.warn('[fix-product] Could not verify admin token:', e);
        return null;
      }
    }

    async function checkProduct() {
      const slug = slugInput.value.trim();
      if (!slug) {
        alert('Por favor ingresa un slug');
        return;
      }

      results.classList.add('hidden');
      loading.classList.remove('hidden');

      try {
        const response = await fetch(`/api/check-product?slug=${encodeURIComponent(slug)}`);
        const data = await response.json();

        loading.classList.add('hidden');
        results.classList.remove('hidden');

        if (data.error) {
          results.innerHTML = `
            <div class="bg-red-50 border-2 border-red-200 rounded-2xl p-8">
              <div class="text-4xl mb-3">‚ùå</div>
              <h3 class="text-xl font-bold text-red-900 mb-2">Error</h3>
              <p class="text-red-700">${escapeHtml(data.error)}</p>
              ${data.details ? `<p class="text-red-600 text-sm mt-2">${escapeHtml(data.details)}</p>` : ''}
            </div>
          `;
          return;
        }

        const product = data.product;
        const schema = data.schema;

        results.innerHTML = `
          <div class="space-y-6">
            {/* Product Info */}
            <div class="bg-white rounded-2xl shadow-xl p-6">
              <h3 class="text-xl font-bold text-gray-900 mb-4">üì¶ Informaci√≥n del Producto</h3>
              <div class="grid grid-cols-2 gap-4 text-sm">
                <div>
                  <span class="font-semibold text-gray-600">Nombre:</span>
                  <p class="text-gray-900">${escapeHtml(product.name)}</p>
                </div>
                <div>
                  <span class="font-semibold text-gray-600">Slug:</span>
                  <p class="text-gray-900 font-mono">${escapeHtml(product.slug)}</p>
                </div>
                <div>
                  <span class="font-semibold text-gray-600">Category ID:</span>
                  <p class="text-gray-900 font-mono">${escapeHtml(product.categoryId) || '(vac√≠o)'}</p>
                </div>
                <div>
                  <span class="font-semibold text-gray-600">Subcategory ID:</span>
                  <p class="text-gray-900 font-mono">${escapeHtml(product.subcategoryId) || '(vac√≠o)'}</p>
                </div>
                <div class="col-span-2">
                  <span class="font-semibold text-gray-600">Customization Schema ID:</span>
                  <p class="text-gray-900 font-mono">${escapeHtml(product.customizationSchemaId) || '(no configurado)'}</p>
                </div>
              </div>
            </div>

            {/* Schema Status */}
            <div class="bg-${schema.detected && schema.exists ? 'green' : 'orange'}-50 border-2 border-${schema.detected && schema.exists ? 'green' : 'orange'}-200 rounded-2xl p-6">
              <h3 class="text-xl font-bold text-gray-900 mb-3">
                ${schema.detected && schema.exists ? '‚úÖ Estado: Correcto' : '‚ö†Ô∏è Estado: Necesita Correcci√≥n'}
              </h3>

              ${schema.detected ? `
                <p class="text-gray-800 mb-2">
                  Schema detectado: <code class="bg-white px-2 py-1 rounded font-mono">${escapeHtml(schema.schemaId)}</code>
                  <span class="text-sm text-gray-600">(detectado por: ${escapeHtml(schema.detectionMethod)})</span>
                </p>
              ` : `
                <p class="text-gray-800 mb-2">‚ùå No se detect√≥ ning√∫n schema</p>
              `}

              ${schema.detected && schema.exists ? `
                <p class="text-green-800 mb-2">
                  ‚úÖ Schema encontrado en Firebase con <strong>${schema.fieldsCount} campos</strong>
                </p>
                <div class="mt-4 p-4 bg-green-100 rounded-lg">
                  <p class="text-green-900 font-semibold">
                    üéâ Este producto est√° correctamente configurado y deber√≠a usar el customizer din√°mico
                  </p>
                </div>
              ` : ''}

              ${schema.detected && !schema.exists ? `
                <p class="text-orange-800 mb-2">
                  ‚ö†Ô∏è Schema ID detectado pero no existe en Firebase
                </p>
                <div class="mt-4 p-4 bg-orange-100 rounded-lg">
                  <p class="text-orange-900 font-semibold mb-2">
                    Soluci√≥n:
                  </p>
                  <p class="text-orange-800 text-sm">
                    Ve a <a href="/admin/customization" class="underline font-bold">/admin/customization</a>
                    y crea/configura el schema para esta categor√≠a
                  </p>
                </div>
              ` : ''}

              ${!schema.detected ? `
                <div class="mt-4 p-4 bg-orange-100 rounded-lg">
                  <p class="text-orange-900 font-semibold mb-2">
                    Soluci√≥n:
                  </p>
                  <p class="text-orange-800 text-sm">
                    El subcategoryId debe contener una de estas palabras: <strong>camisetas, ropa, cuadros, resina, tazas</strong>
                    <br><br>
                    O puedes hacer click en "‚úÖ Arreglar" para agregar autom√°ticamente el campo customizationSchemaId
                  </p>
                </div>
              ` : ''}
            </div>

            {/* Actions */}
            <div class="bg-white rounded-2xl shadow-xl p-6">
              <h3 class="text-xl font-bold text-gray-900 mb-4">üõ†Ô∏è Acciones</h3>
              <div class="flex flex-wrap gap-3">
                <a
                  href="/personalizar/${encodeURIComponent(product.slug)}"
                  target="_blank"
                  class="px-5 py-3 bg-blue-500 text-white rounded-lg font-bold hover:bg-blue-600 transition-colors"
                >
                  Ver Customizer ‚Üí
                </a>
                <a
                  href="/admin/customization"
                  class="px-5 py-3 bg-purple-500 text-white rounded-lg font-bold hover:bg-purple-600 transition-colors"
                >
                  Configurar Schemas ‚Üí
                </a>
                ${!schema.detected || !schema.exists ? `
                  <button
                    onclick="window.location.reload()"
                    class="px-5 py-3 bg-gray-500 text-white rounded-lg font-bold hover:bg-gray-600 transition-colors"
                  >
                    üîÑ Volver a Verificar
                  </button>
                ` : ''}
              </div>
            </div>
          </div>
        `;

      } catch (error: unknown) {
        loading.classList.add('hidden');
        results.classList.remove('hidden');
        const errorMessage = error instanceof Error ? error.message : 'Error desconocido';
        results.innerHTML = `
          <div class="bg-red-50 border-2 border-red-200 rounded-2xl p-8">
            <div class="text-4xl mb-3">‚ùå</div>
            <h3 class="text-xl font-bold text-red-900 mb-2">Error de Conexi√≥n</h3>
            <p class="text-red-700">${escapeHtml(errorMessage)}</p>
          </div>
        `;
      }
    }

    async function fixProduct() {
      const slug = slugInput.value.trim();
      if (!slug) {
        alert('Por favor ingresa un slug');
        return;
      }

      if (!confirm('¬øEst√°s seguro de que quieres agregar el campo customizationSchemaId a este producto?')) {
        return;
      }

      results.classList.add('hidden');
      loading.classList.remove('hidden');

      try {
        const adminToken = await getAdminToken();
        if (!adminToken) {
          loading.classList.add('hidden');
          results.classList.remove('hidden');
          results.innerHTML = `
            <div class="bg-red-50 border-2 border-red-200 rounded-2xl p-8">
              <div class="text-4xl mb-3">‚ùå</div>
              <h3 class="text-xl font-bold text-red-900 mb-2">Acceso denegado</h3>
              <p class="text-red-700">Se requiere una cuenta de administrador.</p>
            </div>
          `;
          return;
        }

        const response = await fetch(
          `/api/check-product?slug=${encodeURIComponent(slug)}&action=fix`,
          {
            headers: {
              Authorization: `Bearer ${adminToken}`,
            },
          }
        );
        const data = await response.json();

        loading.classList.add('hidden');
        results.classList.remove('hidden');

        if (data.error) {
          results.innerHTML = `
            <div class="bg-red-50 border-2 border-red-200 rounded-2xl p-8">
              <div class="text-4xl mb-3">‚ùå</div>
              <h3 class="text-xl font-bold text-red-900 mb-2">Error</h3>
              <p class="text-red-700">${escapeHtml(data.error)}</p>
              ${data.details ? `<p class="text-red-600 text-sm mt-2">${escapeHtml(data.details)}</p>` : ''}
            </div>
          `;
          return;
        }

        if (data.action === 'fixed') {
          results.innerHTML = `
            <div class="bg-green-50 border-2 border-green-200 rounded-2xl p-8">
              <div class="text-5xl mb-3">üéâ</div>
              <h3 class="text-2xl font-bold text-green-900 mb-3">¬°Producto Arreglado!</h3>
              <p class="text-green-800 mb-4">
                Se agreg√≥ el campo <code class="bg-green-100 px-2 py-1 rounded font-mono">customizationSchemaId: "${escapeHtml(data.schema.schemaId)}"</code> al producto.
              </p>
              <div class="p-4 bg-green-100 rounded-lg mb-4">
                <p class="text-green-900 font-semibold mb-2">
                  ${data.schema.exists ?
                    `‚úÖ El producto ahora deber√≠a usar el customizer din√°mico con ${Number(data.schema.fieldsCount) || 0} campos` :
                    `‚ö†Ô∏è Schema detectado pero no existe en Firebase. Cr√©alo en /admin/customization`
                  }
                </p>
              </div>
              <div class="flex gap-3">
                <a
                  href="/personalizar/${encodeURIComponent(data.product.slug)}"
                  target="_blank"
                  class="px-5 py-3 bg-blue-500 text-white rounded-lg font-bold hover:bg-blue-600 transition-colors"
                >
                  Ver Customizer ‚Üí
                </a>
                <button
                  onclick="location.reload()"
                  class="px-5 py-3 bg-gray-500 text-white rounded-lg font-bold hover:bg-gray-600 transition-colors"
                >
                  üîÑ Verificar Otro
                </button>
              </div>
            </div>
          `;
        } else {
          // Si no se hizo 'fix', mostrar los resultados del check
          checkProduct();
        }

      } catch (error: unknown) {
        loading.classList.add('hidden');
        results.classList.remove('hidden');
        const errorMessage = error instanceof Error ? error.message : 'Error desconocido';
        results.innerHTML = `
          <div class="bg-red-50 border-2 border-red-200 rounded-2xl p-8">
            <div class="text-4xl mb-3">‚ùå</div>
            <h3 class="text-xl font-bold text-red-900 mb-2">Error de Conexi√≥n</h3>
            <p class="text-red-700">${escapeHtml(errorMessage)}</p>
          </div>
        `;
      }
    }

    checkBtn.addEventListener('click', checkProduct);
    fixBtn.addEventListener('click', fixProduct);

    // Allow pressing Enter to check
    slugInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        checkProduct();
      }
    });
  </script>
</BaseLayout>
