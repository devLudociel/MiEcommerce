
> ecommerce-personalizado-nuevo@0.0.1 test:security:full
> vitest run --config vitest.security.config.ts --reporter=verbose


[1m[46m RUN [49m[22m [36mv4.0.4 [39m[90mC:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo[39m

[90mstderr[2m | security-tests/unit/auth-helpers.test.ts[2m > [22m[2mAuth Helpers[2m > [22m[2mverifyAuthToken[2m > [22m[2mreturns 401 when no Authorization header is present
[22m[39m[WARN] [verifyAuthToken] Missing or invalid authorization header 

[90mstderr[2m | security-tests/unit/auth-helpers.test.ts[2m > [22m[2mAuth Helpers[2m > [22m[2mverifyAuthToken[2m > [22m[2mreturns 401 when Authorization header lacks Bearer prefix
[22m[39m[WARN] [verifyAuthToken] Missing or invalid authorization header 

[90mstderr[2m | security-tests/unit/auth-helpers.test.ts[2m > [22m[2mAuth Helpers[2m > [22m[2mverifyAuthToken[2m > [22m[2mreturns 401 when token is empty string
[22m[39m[WARN] [verifyAuthToken] Missing or invalid authorization header 

[90mstderr[2m | security-tests/unit/auth-helpers.test.ts[2m > [22m[2mAuth Helpers[2m > [22m[2mverifyAuthToken[2m > [22m[2mreturns 401 when token is invalid/expired
[22m[39m[ERROR] [verifyAuthToken] Token verification failed: Error: Firebase ID token has been revoked or is invalid
    at Object.verifyIdToken (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/unit/auth-helpers.test.ts:17:15)
    at Module.verifyAuthToken (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/auth/authHelpers.ts:46:49)
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/unit/auth-helpers.test.ts:72:28
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:157:11
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:26
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1636:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1602:10[90m)[39m
    at runTest [90m(file:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1309:12[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m

[90mstderr[2m | security-tests/unit/auth-helpers.test.ts[2m > [22m[2mAuth Helpers[2m > [22m[2mverifyAuthToken[2m > [22m[2mreturns 401 when token is malformed
[22m[39m[ERROR] [verifyAuthToken] Token verification failed: Error: Firebase ID token has been revoked or is invalid
    at Object.verifyIdToken (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/unit/auth-helpers.test.ts:17:15)
    at Module.verifyAuthToken (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/auth/authHelpers.ts:46:49)
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/unit/auth-helpers.test.ts:82:28
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:157:11
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:26
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1636:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1602:10[90m)[39m
    at runTest [90m(file:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1309:12[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m

[90mstderr[2m | security-tests/unit/auth-helpers.test.ts[2m > [22m[2mAuth Helpers[2m > [22m[2mverifyAuthToken[2m > [22m[2merror response body does not expose internal details
[22m[39m[ERROR] [verifyAuthToken] Token verification failed: Error: Firebase ID token has been revoked or is invalid
    at Object.verifyIdToken (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/unit/auth-helpers.test.ts:17:15)
    at Module.verifyAuthToken (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/auth/authHelpers.ts:46:49)
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/unit/auth-helpers.test.ts:115:28
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:157:11
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:26
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1636:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1602:10[90m)[39m
    at runTest [90m(file:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1309:12[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m

[90mstderr[2m | security-tests/unit/auth-helpers.test.ts[2m > [22m[2mAuth Helpers[2m > [22m[2mverifyAdminAuth[2m > [22m[2mreturns 401 when no auth header present
[22m[39m[WARN] [verifyAuthToken] Missing or invalid authorization header 

[90mstderr[2m | security-tests/unit/auth-helpers.test.ts[2m > [22m[2mAuth Helpers[2m > [22m[2mverifyAdminAuth[2m > [22m[2mreturns 403 when authenticated user is not admin
[22m[39m[WARN] [verifyAdminAuth] Non-admin user attempted admin action: { uid: [32m'user-123'[39m, email: [32m'user@test.com'[39m }

[90mstderr[2m | security-tests/unit/auth-helpers.test.ts[2m > [22m[2mAuth Helpers[2m > [22m[2mverifyAdminAuth[2m > [22m[2m403 error message does not expose admin list
[22m[39m[WARN] [verifyAdminAuth] Non-admin user attempted admin action: { uid: [32m'user-123'[39m, email: [32m'user@test.com'[39m }

 [32mâœ“[39m security-tests/unit/auth-helpers.test.ts[2m > [22mAuth Helpers[2m > [22mverifyAuthToken[2m > [22mreturns 401 when no Authorization header is present[32m 23[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/auth-helpers.test.ts[2m > [22mAuth Helpers[2m > [22mverifyAuthToken[2m > [22mreturns 401 when Authorization header lacks Bearer prefix[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/auth-helpers.test.ts[2m > [22mAuth Helpers[2m > [22mverifyAuthToken[2m > [22mreturns 401 when token is empty string[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/auth-helpers.test.ts[2m > [22mAuth Helpers[2m > [22mverifyAuthToken[2m > [22mreturns 401 when token is invalid/expired[32m 4[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/auth-helpers.test.ts[2m > [22mAuth Helpers[2m > [22mverifyAuthToken[2m > [22mreturns 401 when token is malformed[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/auth-helpers.test.ts[2m > [22mAuth Helpers[2m > [22mverifyAuthToken[2m > [22mreturns success with uid, email, isAdmin for valid user token[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/auth-helpers.test.ts[2m > [22mAuth Helpers[2m > [22mverifyAuthToken[2m > [22mreturns success with isAdmin=true for valid admin token[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/auth-helpers.test.ts[2m > [22mAuth Helpers[2m > [22mverifyAuthToken[2m > [22merror response body does not expose internal details[32m 3[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/auth-helpers.test.ts[2m > [22mAuth Helpers[2m > [22mverifyAdminAuth[2m > [22mreturns 401 when no auth header present[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/auth-helpers.test.ts[2m > [22mAuth Helpers[2m > [22mverifyAdminAuth[2m > [22mreturns 403 when authenticated user is not admin[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/auth-helpers.test.ts[2m > [22mAuth Helpers[2m > [22mverifyAdminAuth[2m > [22mreturns success when user has admin custom claim[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/auth-helpers.test.ts[2m > [22mAuth Helpers[2m > [22mverifyAdminAuth[2m > [22m403 error message does not expose admin list[32m 1[2mms[22m[39m
[90mstdout[2m | security-tests/integration/wallet/get-balance.security.test.ts[2m > [22m[2mAuthentication enforcement[2m > [22m[2mAUTH-1: returns 401 when no Authorization header is provided
[22m[39m[INFO] [API get-wallet-balance] Request received 

[90mstdout[2m | security-tests/integration/wallet/get-transactions.security.test.ts[2m > [22m[2mAuthentication enforcement[2m > [22m[2mAUTH-1: returns 401 when no Authorization header is provided
[22m[39m[INFO] [API get-wallet-transactions] Request received 

[90mstdout[2m | security-tests/integration/wallet/get-balance.security.test.ts[2m > [22m[2mAuthentication enforcement[2m > [22m[2mAUTH-2: returns 401 when the token is invalid
[22m[39m[INFO] [API get-wallet-balance] Request received 

[90mstdout[2m | security-tests/integration/wallet/get-transactions.security.test.ts[2m > [22m[2mAuthentication enforcement[2m > [22m[2mAUTH-2: returns 401 when the token is invalid
[22m[39m[INFO] [API get-wallet-transactions] Request received 

[90mstderr[2m | security-tests/integration/wallet/get-balance.security.test.ts[2m > [22m[2mAuthentication enforcement[2m > [22m[2mAUTH-2: returns 401 when the token is invalid
[22m[39m[ERROR] [API get-wallet-balance] Invalid token: Error: Firebase ID token has been revoked or is invalid
    at Object.verifyIdToken (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/helpers/mock-firebase.ts:273:15)
    at Module.GET (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/get-wallet-balance.ts:32:43)
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/wallet/get-balance.security.test.ts:102:23
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:157:11
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:26
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1636:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1602:10[90m)[39m
    at runTest [90m(file:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1309:12[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m

[90mstdout[2m | security-tests/integration/wallet/get-balance.security.test.ts[2m > [22m[2mAuthentication enforcement[2m > [22m[2mAUTH-2 (expired): returns 401 when the token is expired
[22m[39m[INFO] [API get-wallet-balance] Request received 

[90mstderr[2m | security-tests/integration/wallet/get-transactions.security.test.ts[2m > [22m[2mAuthentication enforcement[2m > [22m[2mAUTH-2: returns 401 when the token is invalid
[22m[39m[ERROR] [API get-wallet-transactions] Invalid token: Error: Firebase ID token has been revoked or is invalid
    at Object.verifyIdToken (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/helpers/mock-firebase.ts:273:15)
    at Module.GET (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/get-wallet-transactions.ts:33:43)
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/wallet/get-transactions.security.test.ts:127:23
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:157:11
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:26
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1636:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1602:10[90m)[39m
    at runTest [90m(file:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1309:12[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m

[90mstdout[2m | security-tests/integration/wallet/get-transactions.security.test.ts[2m > [22m[2mAuthentication enforcement[2m > [22m[2mAUTH-2 (expired): returns 401 when the token is expired
[22m[39m[INFO] [API get-wallet-transactions] Request received 

[90mstderr[2m | security-tests/integration/wallet/get-balance.security.test.ts[2m > [22m[2mAuthentication enforcement[2m > [22m[2mAUTH-2 (expired): returns 401 when the token is expired
[22m[39m[ERROR] [API get-wallet-balance] Invalid token: Error: Firebase ID token has been revoked or is invalid
    at Object.verifyIdToken (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/helpers/mock-firebase.ts:273:15)
    at Module.GET (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/get-wallet-balance.ts:32:43)
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/wallet/get-balance.security.test.ts:112:23
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:157:11
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:26
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1636:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1602:10[90m)[39m
    at runTest [90m(file:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1309:12[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m

[90mstderr[2m | security-tests/integration/wallet/get-transactions.security.test.ts[2m > [22m[2mAuthentication enforcement[2m > [22m[2mAUTH-2 (expired): returns 401 when the token is expired
[22m[39m[ERROR] [API get-wallet-transactions] Invalid token: Error: Firebase ID token has been revoked or is invalid
    at Object.verifyIdToken (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/helpers/mock-firebase.ts:273:15)
    at Module.GET (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/get-wallet-transactions.ts:33:43)
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/wallet/get-transactions.security.test.ts:137:23
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:157:11
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:26
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1636:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1602:10[90m)[39m
    at runTest [90m(file:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1309:12[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m

[90mstdout[2m | security-tests/integration/wallet/get-balance.security.test.ts[2m > [22m[2mIDOR protection[2m > [22m[2mIDOR-1: returns 200 and the balance when a user requests their own wallet
[22m[39m[INFO] [API get-wallet-balance] Request received 

[90mstdout[2m | security-tests/integration/wallet/get-balance.security.test.ts[2m > [22m[2mIDOR protection[2m > [22m[2mIDOR-1: returns 200 and the balance when a user requests their own wallet
[22m[39m[INFO] [API get-wallet-balance] Balance retrieved { userId: [32m'user-123'[39m, balance: [33m25[39m }

[90mstdout[2m | security-tests/integration/wallet/get-transactions.security.test.ts[2m > [22m[2mIDOR protection[2m > [22m[2mIDOR-1: returns 200 and own transactions when a user requests their own data
[22m[39m[INFO] [API get-wallet-transactions] Request received 

[90mstdout[2m | security-tests/integration/wallet/get-balance.security.test.ts[2m > [22m[2mIDOR protection[2m > [22m[2mIDOR-2: returns 403 when a regular user requests another user's wallet
[22m[39m[INFO] [API get-wallet-balance] Request received 

[90mstdout[2m | security-tests/integration/wallet/get-transactions.security.test.ts[2m > [22m[2mIDOR protection[2m > [22m[2mIDOR-1: returns 200 and own transactions when a user requests their own data
[22m[39m[INFO] [API get-wallet-transactions] Transactions retrieved { userId: [32m'user-123'[39m, count: [33m3[39m }

[90mstdout[2m | security-tests/integration/wallet/get-balance.security.test.ts[2m > [22m[2mIDOR protection[2m > [22m[2mIDOR-3: returns 200 when an admin requests another user's wallet
[22m[39m[INFO] [API get-wallet-balance] Request received 

[90mstdout[2m | security-tests/integration/wallet/get-balance.security.test.ts[2m > [22m[2mIDOR protection[2m > [22m[2mIDOR-3: returns 200 when an admin requests another user's wallet
[22m[39m[INFO] [API get-wallet-balance] Balance retrieved { userId: [32m'user-123'[39m, balance: [33m75.5[39m }

[90mstdout[2m | security-tests/integration/wallet/get-balance.security.test.ts[2m > [22m[2mBalance accuracy[2m > [22m[2mBALANCE-1: returns balance of 0 for a non-existent wallet and auto-creates it
[22m[39m[INFO] [API get-wallet-balance] Request received 

[90mstdout[2m | security-tests/integration/wallet/get-transactions.security.test.ts[2m > [22m[2mIDOR protection[2m > [22m[2mIDOR-2: returns 403 when a regular user requests another user's transactions
[22m[39m[INFO] [API get-wallet-transactions] Request received 

[90mstdout[2m | security-tests/integration/wallet/get-balance.security.test.ts[2m > [22m[2mBalance accuracy[2m > [22m[2mBALANCE-1: returns balance of 0 for a non-existent wallet and auto-creates it
[22m[39m[INFO] [API get-wallet-balance] Balance retrieved { userId: [32m'user-123'[39m, balance: [33m0[39m }

[90mstdout[2m | security-tests/integration/wallet/get-balance.security.test.ts[2m > [22m[2mBalance accuracy[2m > [22m[2mBALANCE-2: returns the correct balance from a seeded wallet
[22m[39m[INFO] [API get-wallet-balance] Request received 

[90mstdout[2m | security-tests/integration/wallet/get-balance.security.test.ts[2m > [22m[2mBalance accuracy[2m > [22m[2mBALANCE-2: returns the correct balance from a seeded wallet
[22m[39m[INFO] [API get-wallet-balance] Balance retrieved { userId: [32m'user-123'[39m, balance: [33m42.5[39m }

[90mstdout[2m | security-tests/integration/wallet/get-transactions.security.test.ts[2m > [22m[2mIDOR protection[2m > [22m[2mIDOR-3: returns 200 when an admin requests another user's transactions
[22m[39m[INFO] [API get-wallet-transactions] Request received 

[90mstdout[2m | security-tests/integration/wallet/get-transactions.security.test.ts[2m > [22m[2mIDOR protection[2m > [22m[2mIDOR-3: returns 200 when an admin requests another user's transactions
[22m[39m[INFO] [API get-wallet-transactions] Transactions retrieved { userId: [32m'user-123'[39m, count: [33m2[39m }

[90mstdout[2m | security-tests/integration/wallet/get-balance.security.test.ts[2m > [22m[2mBalance accuracy[2m > [22m[2mBALANCE-2 (default uid): returns own balance when no userId query param is provided
[22m[39m[INFO] [API get-wallet-balance] Request received 

[90mstdout[2m | security-tests/integration/wallet/get-balance.security.test.ts[2m > [22m[2mBalance accuracy[2m > [22m[2mBALANCE-2 (default uid): returns own balance when no userId query param is provided
[22m[39m[INFO] [API get-wallet-balance] Balance retrieved { userId: [32m'user-123'[39m, balance: [33m15.75[39m }

[90mstdout[2m | security-tests/integration/wallet/get-transactions.security.test.ts[2m > [22m[2mLimit parameter[2m > [22m[2mLIMIT-1: respects the ?limit query param and returns at most limit transactions
[22m[39m[INFO] [API get-wallet-transactions] Request received 

[90mstdout[2m | security-tests/integration/wallet/get-transactions.security.test.ts[2m > [22m[2mLimit parameter[2m > [22m[2mLIMIT-1: respects the ?limit query param and returns at most limit transactions
[22m[39m[INFO] [API get-wallet-transactions] Transactions retrieved { userId: [32m'user-123'[39m, count: [33m3[39m }

[90mstdout[2m | security-tests/integration/wallet/get-transactions.security.test.ts[2m > [22m[2mLimit parameter[2m > [22m[2mLIMIT-1 (default): returns up to 50 transactions when no limit param is given
[22m[39m[INFO] [API get-wallet-transactions] Request received 

[90mstdout[2m | security-tests/integration/wallet/get-transactions.security.test.ts[2m > [22m[2mLimit parameter[2m > [22m[2mLIMIT-1 (default): returns up to 50 transactions when no limit param is given
[22m[39m[INFO] [API get-wallet-transactions] Transactions retrieved { userId: [32m'user-123'[39m, count: [33m5[39m }

[90mstdout[2m | security-tests/integration/wallet/get-transactions.security.test.ts[2m > [22m[2mLimit parameter[2m > [22m[2mLIMIT-1 (sorted): returns transactions sorted by date descending
[22m[39m[INFO] [API get-wallet-transactions] Request received 

[90mstderr[2m | security-tests/integration/orders/get-order.security.test.ts[2m > [22m[2mAuthentication enforcement[2m > [22m[2mreturns 401 when the token is expired
[22m[39m[ERROR] [get-order] Invalid token: Error: Firebase ID token has been revoked or is invalid
    at Object.verifyIdToken (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/helpers/mock-firebase.ts:273:15)
    at Module.GET (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/get-order.ts:33:43)
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/orders/get-order.security.test.ts:151:23
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:157:11
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:26
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1636:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1602:10[90m)[39m
    at runTest [90m(file:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1309:12[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m

[90mstdout[2m | security-tests/integration/wallet/get-transactions.security.test.ts[2m > [22m[2mLimit parameter[2m > [22m[2mLIMIT-1 (sorted): returns transactions sorted by date descending
[22m[39m[INFO] [API get-wallet-transactions] Transactions retrieved { userId: [32m'user-123'[39m, count: [33m3[39m }

 [32mâœ“[39m security-tests/integration/wallet/get-balance.security.test.ts[2m > [22mAuthentication enforcement[2m > [22mAUTH-1: returns 401 when no Authorization header is provided[32m 32[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/wallet/get-balance.security.test.ts[2m > [22mAuthentication enforcement[2m > [22mAUTH-2: returns 401 when the token is invalid[32m 7[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/wallet/get-balance.security.test.ts[2m > [22mAuthentication enforcement[2m > [22mAUTH-2 (expired): returns 401 when the token is expired[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/wallet/get-balance.security.test.ts[2m > [22mIDOR protection[2m > [22mIDOR-1: returns 200 and the balance when a user requests their own wallet[32m 3[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/wallet/get-balance.security.test.ts[2m > [22mIDOR protection[2m > [22mIDOR-2: returns 403 when a regular user requests another user's wallet[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/wallet/get-balance.security.test.ts[2m > [22mIDOR protection[2m > [22mIDOR-3: returns 200 when an admin requests another user's wallet[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/wallet/get-balance.security.test.ts[2m > [22mBalance accuracy[2m > [22mBALANCE-1: returns balance of 0 for a non-existent wallet and auto-creates it[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/wallet/get-balance.security.test.ts[2m > [22mBalance accuracy[2m > [22mBALANCE-2: returns the correct balance from a seeded wallet[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/wallet/get-balance.security.test.ts[2m > [22mBalance accuracy[2m > [22mBALANCE-2 (default uid): returns own balance when no userId query param is provided[32m 2[2mms[22m[39m
[90mstderr[2m | security-tests/integration/orders/get-order.security.test.ts[2m > [22m[2mAuthentication enforcement[2m > [22m[2mreturns 401 when the token is malformed
[22m[39m[ERROR] [get-order] Invalid token: Error: Firebase ID token has been revoked or is invalid
    at Object.verifyIdToken (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/helpers/mock-firebase.ts:273:15)
    at Module.GET (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/get-order.ts:33:43)
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/orders/get-order.security.test.ts:160:23
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:157:11
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:26
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1636:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1602:10[90m)[39m
    at runTest [90m(file:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1309:12[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m

 [32mâœ“[39m security-tests/integration/wallet/get-transactions.security.test.ts[2m > [22mAuthentication enforcement[2m > [22mAUTH-1: returns 401 when no Authorization header is provided[32m 32[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/wallet/get-transactions.security.test.ts[2m > [22mAuthentication enforcement[2m > [22mAUTH-2: returns 401 when the token is invalid[32m 7[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/wallet/get-transactions.security.test.ts[2m > [22mAuthentication enforcement[2m > [22mAUTH-2 (expired): returns 401 when the token is expired[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/wallet/get-transactions.security.test.ts[2m > [22mIDOR protection[2m > [22mIDOR-1: returns 200 and own transactions when a user requests their own data[32m 6[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/wallet/get-transactions.security.test.ts[2m > [22mIDOR protection[2m > [22mIDOR-2: returns 403 when a regular user requests another user's transactions[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/wallet/get-transactions.security.test.ts[2m > [22mIDOR protection[2m > [22mIDOR-3: returns 200 when an admin requests another user's transactions[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/wallet/get-transactions.security.test.ts[2m > [22mLimit parameter[2m > [22mLIMIT-1: respects the ?limit query param and returns at most limit transactions[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/wallet/get-transactions.security.test.ts[2m > [22mLimit parameter[2m > [22mLIMIT-1 (default): returns up to 50 transactions when no limit param is given[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/wallet/get-transactions.security.test.ts[2m > [22mLimit parameter[2m > [22mLIMIT-1 (sorted): returns transactions sorted by date descending[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/orders/get-order.security.test.ts[2m > [22mAuthentication enforcement[2m > [22mreturns 401 when no Authorization header is provided[32m 30[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/orders/get-order.security.test.ts[2m > [22mAuthentication enforcement[2m > [22mreturns 401 when Authorization header is not a Bearer token[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/orders/get-order.security.test.ts[2m > [22mAuthentication enforcement[2m > [22mreturns 401 when the token is expired[32m 8[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/orders/get-order.security.test.ts[2m > [22mAuthentication enforcement[2m > [22mreturns 401 when the token is malformed[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/orders/get-order.security.test.ts[2m > [22mAuthentication enforcement[2m > [22mreturns 401 when Bearer token value is an empty string[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/orders/get-order.security.test.ts[2m > [22mIDOR protection[2m > [22mreturns 404 when a regular user requests another user's order[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/orders/get-order.security.test.ts[2m > [22mIDOR protection[2m > [22mdoes NOT leak the existence of another user's order (returns 404, not 403)[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/orders/get-order.security.test.ts[2m > [22mIDOR protection[2m > [22mreturns 404 for a non-existent orderId (authenticated user)[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/orders/get-order.security.test.ts[2m > [22mAuthorised access[2m > [22mreturns 200 when an authenticated user requests their own order[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/orders/get-order.security.test.ts[2m > [22mAuthorised access[2m > [22mreturns correct order fields for an authenticated user[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/orders/get-order.security.test.ts[2m > [22mAuthorised access[2m > [22mallows admin to access any user's order[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/orders/get-order.security.test.ts[2m > [22mAuthorised access[2m > [22mallows admin to access the primary user's order too[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/orders/get-order.security.test.ts[2m > [22mQuery parameter validation[2m > [22mreturns 400 when orderId is missing from query params[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/orders/get-order.security.test.ts[2m > [22mQuery parameter validation[2m > [22mreturns 404 (not 500) when orderId consists only of whitespace[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/orders/get-order.security.test.ts[2m > [22mResponse does not expose internal details[2m > [22mdoes not include sensitive internal fields in the order response[32m 3[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/orders/get-order.security.test.ts[2m > [22mResponse does not expose internal details[2m > [22mincludes cache-control headers to prevent caching of sensitive data[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/addresses/addresses.security.test.ts[2m > [22mAUTH-1: GET /api/addresses â€” authentication enforcement[2m > [22mreturns 401 when no Authorization header is provided[32m 30[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/addresses/addresses.security.test.ts[2m > [22mAUTH-2: POST /api/addresses â€” authentication enforcement[2m > [22mreturns 401 when no Authorization header is provided[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/addresses/addresses.security.test.ts[2m > [22mLIST-1: GET /api/addresses â€” returns authenticated user addresses[2m > [22mreturns 200 with only the authenticated user's addresses[32m 3[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/addresses/addresses.security.test.ts[2m > [22mIDOR-1: Addresses are scoped to the authenticated user's uid[2m > [22muser A receives an empty list when user B has addresses but user A has none[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/addresses/addresses.security.test.ts[2m > [22mCREATE-1: POST /api/addresses â€” successful creation[2m > [22mreturns 201 when a valid address body is submitted[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/addresses/addresses.security.test.ts[2m > [22mCREATE-2: POST /api/addresses â€” rejects client-controlled id[2m > [22mreturns 400 when the request body includes an "id" field[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/addresses/addresses.security.test.ts[2m > [22mCREATE-3: POST /api/addresses â€” rejects client-supplied userId[2m > [22mreturns 400 when the request body includes a "userId" field[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/addresses/addresses.security.test.ts[2m > [22mUPDATE-1: PUT /api/addresses/[id] â€” 404 for non-existent address[2m > [22mreturns 404 when the address does not exist in the user's subcollection[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/addresses/addresses.security.test.ts[2m > [22mDELETE-1: DELETE /api/addresses/[id] â€” successful deletion[2m > [22mreturns 200 after deleting an existing address[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/addresses/addresses.security.test.ts[2m > [22mDELETE-2: DELETE /api/addresses/[id] â€” 404 for non-existent address[2m > [22mreturns 404 when the address does not exist in the user's subcollection[32m 1[2mms[22m[39m
(node:23472) [DEP0040] DeprecationWarning: The `punycode` module is deprecated. Please use a userland alternative instead.
(Use `node --trace-deprecation ...` to show where the warning was created)
 [32mâœ“[39m security-tests/integration/share/share.security.test.ts[2m > [22mInput validation[2m > [22mINPUT-1: returns 400 for missing productId[32m 33[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/share/share.security.test.ts[2m > [22mInput validation[2m > [22mINPUT-2: returns 400 for missing productName[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/share/share.security.test.ts[2m > [22mInput validation[2m > [22mINPUT-1b: returns 400 for empty productId string[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/share/share.security.test.ts[2m > [22mInput validation[2m > [22mINPUT-2b: returns 400 for empty productName string[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/share/share.security.test.ts[2m > [22mShare creation[2m > [22mCREATE-1: returns shareId on successful share creation (200)[32m 3[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/share/share.security.test.ts[2m > [22mShare creation[2m > [22mCREATE-1b: returned shareId matches the mocked nanoid value[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/share/share.security.test.ts[2m > [22mShare creation[2m > [22mCREATE-2: saves the shared design document to Firestore[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/share/share.security.test.ts[2m > [22mShare creation[2m > [22mCREATE-2b: saved document contains expected metadata fields[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/share/share.security.test.ts[2m > [22mShare creation[2m > [22mCREATE-1c: accepts optional previewImage URL and stores it[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/share/share.security.test.ts[2m > [22mRate limiting (STANDARD â€” 60 req/min)[2m > [22mRATE-1: blocks the 61st request from the same IP with 429[32m 26[2mms[22m[39m
[90mstdout[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mRATE-1: blocks the 11th request from the same IP with 429
[22m[39m[INFO] ðŸ“§ API send-email: Solicitud recibida 

[90mstderr[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mRATE-1: blocks the 11th request from the same IP with 429
[22m[39m[WARN] ðŸ“§ Invalid input: {
  _errors: [],
  type: {
    _errors: [
      [32m"Invalid enum value. Expected 'confirmation' | 'status-update' | 'newsletter-welcome' | 'tracking-update', received 'invalid-type-to-get-400-not-500'"[39m
    ]
  }
}

[90mstdout[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mRATE-1: blocks the 11th request from the same IP with 429
[22m[39m[INFO] ðŸ“§ API send-email: Solicitud recibida 

[90mstderr[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mRATE-1: blocks the 11th request from the same IP with 429
[22m[39m[WARN] ðŸ“§ Invalid input: {
  _errors: [],
  type: {
    _errors: [
      [32m"Invalid enum value. Expected 'confirmation' | 'status-update' | 'newsletter-welcome' | 'tracking-update', received 'invalid-type-to-get-400-not-500'"[39m
    ]
  }
}

[90mstdout[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mRATE-1: blocks the 11th request from the same IP with 429
[22m[39m[INFO] ðŸ“§ API send-email: Solicitud recibida 

[90mstdout[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email rejects unauthenticated order confirmation requests
[22m[39m[INFO] ðŸ“§ API send-email: Solicitud recibida 

[90mstderr[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mRATE-1: blocks the 11th request from the same IP with 429
[22m[39m[WARN] ðŸ“§ Invalid input: {
  _errors: [],
  type: {
    _errors: [
      [32m"Invalid enum value. Expected 'confirmation' | 'status-update' | 'newsletter-welcome' | 'tracking-update', received 'invalid-type-to-get-400-not-500'"[39m
    ]
  }
}

[90mstdout[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mRATE-1: blocks the 11th request from the same IP with 429
[22m[39m[INFO] ðŸ“§ API send-email: Solicitud recibida 

[90mstderr[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mRATE-1: blocks the 11th request from the same IP with 429
[22m[39m[WARN] ðŸ“§ Invalid input: {
  _errors: [],
  type: {
    _errors: [
      [32m"Invalid enum value. Expected 'confirmation' | 'status-update' | 'newsletter-welcome' | 'tracking-update', received 'invalid-type-to-get-400-not-500'"[39m
    ]
  }
}

[90mstdout[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mRATE-1: blocks the 11th request from the same IP with 429
[22m[39m[INFO] ðŸ“§ API send-email: Solicitud recibida 

[90mstderr[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mRATE-1: blocks the 11th request from the same IP with 429
[22m[39m[WARN] ðŸ“§ Invalid input: {
  _errors: [],
  type: {
    _errors: [
      [32m"Invalid enum value. Expected 'confirmation' | 'status-update' | 'newsletter-welcome' | 'tracking-update', received 'invalid-type-to-get-400-not-500'"[39m
    ]
  }
}

[90mstdout[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mRATE-1: blocks the 11th request from the same IP with 429
[22m[39m[INFO] ðŸ“§ API send-email: Solicitud recibida 

[90mstderr[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mRATE-1: blocks the 11th request from the same IP with 429
[22m[39m[WARN] ðŸ“§ Invalid input: {
  _errors: [],
  type: {
    _errors: [
      [32m"Invalid enum value. Expected 'confirmation' | 'status-update' | 'newsletter-welcome' | 'tracking-update', received 'invalid-type-to-get-400-not-500'"[39m
    ]
  }
}

[90mstdout[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mRATE-1: blocks the 11th request from the same IP with 429
[22m[39m[INFO] ðŸ“§ API send-email: Solicitud recibida 

[90mstdout[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email rejects unauthenticated order confirmation requests
[22m[39m[INFO] ðŸ“§ Datos recibidos: {
  orderId: [32m'order-1'[39m,
  type: [32m'confirmation'[39m,
  newStatus: [90mundefined[39m,
  email: [90mundefined[39m
}

[90mstderr[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email rejects unauthenticated order confirmation requests
[22m[39m[WARN] ðŸ“§ Unauthorized order email attempt 

[90mstderr[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mRATE-1: blocks the 11th request from the same IP with 429
[22m[39m[WARN] ðŸ“§ Invalid input: {
  _errors: [],
  type: {
    _errors: [
      [32m"Invalid enum value. Expected 'confirmation' | 'status-update' | 'newsletter-welcome' | 'tracking-update', received 'invalid-type-to-get-400-not-500'"[39m
    ]
  }
}

[90mstdout[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mRATE-1: blocks the 11th request from the same IP with 429
[22m[39m[INFO] ðŸ“§ API send-email: Solicitud recibida 

[90mstderr[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mRATE-1: blocks the 11th request from the same IP with 429
[22m[39m[WARN] ðŸ“§ Invalid input: {
  _errors: [],
  type: {
    _errors: [
      [32m"Invalid enum value. Expected 'confirmation' | 'status-update' | 'newsletter-welcome' | 'tracking-update', received 'invalid-type-to-get-400-not-500'"[39m
    ]
  }
}

[90mstdout[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mRATE-1: blocks the 11th request from the same IP with 429
[22m[39m[INFO] ðŸ“§ API send-email: Solicitud recibida 

[90mstdout[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email rejects regular user sending order emails
[22m[39m[INFO] ðŸ“§ API send-email: Solicitud recibida 

[90mstdout[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email rejects regular user sending order emails
[22m[39m[INFO] ðŸ“§ Datos recibidos: {
  orderId: [32m'order-1'[39m,
  type: [32m'confirmation'[39m,
  newStatus: [90mundefined[39m,
  email: [90mundefined[39m
}

[90mstderr[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email rejects regular user sending order emails
[22m[39m[WARN] ðŸ“§ Unauthorized order email attempt 

[90mstderr[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mRATE-1: blocks the 11th request from the same IP with 429
[22m[39m[WARN] ðŸ“§ Invalid input: {
  _errors: [],
  type: {
    _errors: [
      [32m"Invalid enum value. Expected 'confirmation' | 'status-update' | 'newsletter-welcome' | 'tracking-update', received 'invalid-type-to-get-400-not-500'"[39m
    ]
  }
}

[90mstdout[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mRATE-1: blocks the 11th request from the same IP with 429
[22m[39m[INFO] ðŸ“§ API send-email: Solicitud recibida 

[90mstdout[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email has rate limiting active
[22m[39m[INFO] ðŸ“§ API send-email: Solicitud recibida 

[90mstderr[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mRATE-1: blocks the 11th request from the same IP with 429
[22m[39m[WARN] ðŸ“§ Invalid input: {
  _errors: [],
  type: {
    _errors: [
      [32m"Invalid enum value. Expected 'confirmation' | 'status-update' | 'newsletter-welcome' | 'tracking-update', received 'invalid-type-to-get-400-not-500'"[39m
    ]
  }
}

[90mstdout[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mRATE-1: blocks the 11th request from the same IP with 429
[22m[39m[INFO] ðŸ“§ API send-email: Solicitud recibida 

[90mstdout[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email has rate limiting active
[22m[39m[INFO] ðŸ“§ Datos recibidos: {
  orderId: [32m'order-1'[39m,
  type: [32m'confirmation'[39m,
  newStatus: [90mundefined[39m,
  email: [90mundefined[39m
}

[90mstderr[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mRATE-1: blocks the 11th request from the same IP with 429
[22m[39m[WARN] ðŸ“§ Rate limit exceeded for send-email 

[90mstderr[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email has rate limiting active
[22m[39m[WARN] ðŸ“§ Unauthorized order email attempt 

[90mstdout[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email has rate limiting active
[22m[39m[INFO] ðŸ“§ API send-email: Solicitud recibida 

[90mstdout[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email has rate limiting active
[22m[39m[INFO] ðŸ“§ Datos recibidos: {
  orderId: [32m'order-1'[39m,
  type: [32m'confirmation'[39m,
  newStatus: [90mundefined[39m,
  email: [90mundefined[39m
}

[90mstderr[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email has rate limiting active
[22m[39m[WARN] ðŸ“§ Unauthorized order email attempt 

[90mstdout[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mNewsletter-welcome authorization[2m > [22m[2mAUTH-1: returns 403 when newsletter-welcome is requested without X-Internal-Secret
[22m[39m[INFO] ðŸ“§ API send-email: Solicitud recibida 

[90mstdout[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email has rate limiting active
[22m[39m[INFO] ðŸ“§ API send-email: Solicitud recibida 

[90mstdout[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email has rate limiting active
[22m[39m[INFO] ðŸ“§ Datos recibidos: {
  orderId: [32m'order-1'[39m,
  type: [32m'confirmation'[39m,
  newStatus: [90mundefined[39m,
  email: [90mundefined[39m
}

[90mstderr[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mNewsletter-welcome authorization[2m > [22m[2mAUTH-1: returns 403 when newsletter-welcome is requested without X-Internal-Secret
[22m[39m[WARN] ðŸ“§ Unauthorized newsletter-welcome attempt (not internal call) 

[90mstderr[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email has rate limiting active
[22m[39m[WARN] ðŸ“§ Unauthorized order email attempt 

[90mstdout[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mNewsletter-welcome authorization[2m > [22m[2mAUTH-1: returns 403 when newsletter-welcome is requested without X-Internal-Secret
[22m[39m[INFO] ðŸ“§ Datos recibidos: {
  orderId: [90mundefined[39m,
  type: [32m'newsletter-welcome'[39m,
  newStatus: [90mundefined[39m,
  email: [32m'***@***'[39m
}

[90mstdout[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email has rate limiting active
[22m[39m[INFO] ðŸ“§ API send-email: Solicitud recibida 

[90mstdout[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email has rate limiting active
[22m[39m[INFO] ðŸ“§ Datos recibidos: {
  orderId: [32m'order-1'[39m,
  type: [32m'confirmation'[39m,
  newStatus: [90mundefined[39m,
  email: [90mundefined[39m
}

[90mstdout[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mNewsletter-welcome authorization[2m > [22m[2mAUTH-1b: returns 403 when newsletter-welcome is sent with wrong internal secret
[22m[39m[INFO] ðŸ“§ API send-email: Solicitud recibida 

[90mstderr[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email has rate limiting active
[22m[39m[WARN] ðŸ“§ Unauthorized order email attempt 

[90mstdout[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email has rate limiting active
[22m[39m[INFO] ðŸ“§ API send-email: Solicitud recibida 

[90mstderr[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mNewsletter-welcome authorization[2m > [22m[2mAUTH-1b: returns 403 when newsletter-welcome is sent with wrong internal secret
[22m[39m[WARN] ðŸ“§ Unauthorized newsletter-welcome attempt (not internal call) 

[90mstdout[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mNewsletter-welcome authorization[2m > [22m[2mAUTH-1b: returns 403 when newsletter-welcome is sent with wrong internal secret
[22m[39m[INFO] ðŸ“§ Datos recibidos: {
  orderId: [90mundefined[39m,
  type: [32m'newsletter-welcome'[39m,
  newStatus: [90mundefined[39m,
  email: [32m'***@***'[39m
}

[90mstdout[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email has rate limiting active
[22m[39m[INFO] ðŸ“§ Datos recibidos: {
  orderId: [32m'order-1'[39m,
  type: [32m'confirmation'[39m,
  newStatus: [90mundefined[39m,
  email: [90mundefined[39m
}

[90mstderr[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email has rate limiting active
[22m[39m[WARN] ðŸ“§ Unauthorized order email attempt 

[90mstdout[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mOrder email authorization[2m > [22m[2mAUTH-2: returns 403 for order confirmation without admin auth
[22m[39m[INFO] ðŸ“§ API send-email: Solicitud recibida 

[90mstdout[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email has rate limiting active
[22m[39m[INFO] ðŸ“§ API send-email: Solicitud recibida 

[90mstdout[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mOrder email authorization[2m > [22m[2mAUTH-2: returns 403 for order confirmation without admin auth
[22m[39m[INFO] ðŸ“§ Datos recibidos: {
  orderId: [32m'order-1'[39m,
  type: [32m'confirmation'[39m,
  newStatus: [90mundefined[39m,
  email: [90mundefined[39m
}

[90mstdout[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email has rate limiting active
[22m[39m[INFO] ðŸ“§ Datos recibidos: {
  orderId: [32m'order-1'[39m,
  type: [32m'confirmation'[39m,
  newStatus: [90mundefined[39m,
  email: [90mundefined[39m
}

[90mstderr[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mOrder email authorization[2m > [22m[2mAUTH-2: returns 403 for order confirmation without admin auth
[22m[39m[WARN] ðŸ“§ Unauthorized order email attempt 

[90mstderr[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email has rate limiting active
[22m[39m[WARN] ðŸ“§ Unauthorized order email attempt 

[90mstdout[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email has rate limiting active
[22m[39m[INFO] ðŸ“§ API send-email: Solicitud recibida 

[90mstdout[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mOrder email authorization[2m > [22m[2mAUTH-2b: returns 403 for order status-update without admin auth
[22m[39m[INFO] ðŸ“§ API send-email: Solicitud recibida 

[90mstdout[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mOrder email authorization[2m > [22m[2mAUTH-2b: returns 403 for order status-update without admin auth
[22m[39m[INFO] ðŸ“§ Datos recibidos: {
  orderId: [32m'order-1'[39m,
  type: [32m'status-update'[39m,
  newStatus: [32m'processing'[39m,
  email: [90mundefined[39m
}

[90mstderr[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mOrder email authorization[2m > [22m[2mAUTH-2b: returns 403 for order status-update without admin auth
[22m[39m[WARN] ðŸ“§ Unauthorized order email attempt 

[90mstdout[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email has rate limiting active
[22m[39m[INFO] ðŸ“§ Datos recibidos: {
  orderId: [32m'order-1'[39m,
  type: [32m'confirmation'[39m,
  newStatus: [90mundefined[39m,
  email: [90mundefined[39m
}

[90mstderr[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email has rate limiting active
[22m[39m[WARN] ðŸ“§ Unauthorized order email attempt 

[90mstdout[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mOrder email authorization[2m > [22m[2mAUTH-2c: returns 403 when a regular (non-admin) user attempts to send order email
[22m[39m[INFO] ðŸ“§ API send-email: Solicitud recibida 

[90mstdout[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email has rate limiting active
[22m[39m[INFO] ðŸ“§ API send-email: Solicitud recibida 

[90mstdout[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mOrder email authorization[2m > [22m[2mAUTH-2c: returns 403 when a regular (non-admin) user attempts to send order email
[22m[39m[INFO] ðŸ“§ Datos recibidos: {
  orderId: [32m'order-1'[39m,
  type: [32m'confirmation'[39m,
  newStatus: [90mundefined[39m,
  email: [90mundefined[39m
}

[90mstdout[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email has rate limiting active
[22m[39m[INFO] ðŸ“§ Datos recibidos: {
  orderId: [32m'order-1'[39m,
  type: [32m'confirmation'[39m,
  newStatus: [90mundefined[39m,
  email: [90mundefined[39m
}

[90mstderr[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email has rate limiting active
[22m[39m[WARN] ðŸ“§ Unauthorized order email attempt 

[90mstdout[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email has rate limiting active
[22m[39m[INFO] ðŸ“§ API send-email: Solicitud recibida 

[90mstdout[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email has rate limiting active
[22m[39m[INFO] ðŸ“§ Datos recibidos: {
  orderId: [32m'order-1'[39m,
  type: [32m'confirmation'[39m,
  newStatus: [90mundefined[39m,
  email: [90mundefined[39m
}

[90mstderr[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email has rate limiting active
[22m[39m[WARN] ðŸ“§ Unauthorized order email attempt 

[90mstdout[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email has rate limiting active
[22m[39m[INFO] ðŸ“§ API send-email: Solicitud recibida 

[90mstderr[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mOrder email authorization[2m > [22m[2mAUTH-2c: returns 403 when a regular (non-admin) user attempts to send order email
[22m[39m[WARN] ðŸ“§ Unauthorized order email attempt 

[90mstdout[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mAdmin order email[2m > [22m[2mAUTH-3: admin can send order confirmation email (200)
[22m[39m[INFO] ðŸ“§ API send-email: Solicitud recibida 

[90mstdout[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mAdmin order email[2m > [22m[2mAUTH-3: admin can send order confirmation email (200)
[22m[39m[INFO] ðŸ“§ Datos recibidos: {
  orderId: [32m'order-1'[39m,
  type: [32m'confirmation'[39m,
  newStatus: [90mundefined[39m,
  email: [90mundefined[39m
}

[90mstdout[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email has rate limiting active
[22m[39m[INFO] ðŸ“§ Datos recibidos: {
  orderId: [32m'order-1'[39m,
  type: [32m'confirmation'[39m,
  newStatus: [90mundefined[39m,
  email: [90mundefined[39m
}

[90mstdout[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mAdmin order email[2m > [22m[2mAUTH-3: admin can send order confirmation email (200)
[22m[39m[INFO] ðŸ“§ Enviando email a: user@test.com

[90mstderr[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email has rate limiting active
[22m[39m[WARN] ðŸ“§ Unauthorized order email attempt 

[90mstdout[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mAdmin order email[2m > [22m[2mAUTH-3: admin can send order confirmation email (200)
[22m[39m[INFO] ðŸ“§ Email enviado correctamente: { data: { id: [32m'email-123'[39m } }

[90mstdout[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email has rate limiting active
[22m[39m[INFO] ðŸ“§ API send-email: Solicitud recibida 

[90mstderr[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email has rate limiting active
[22m[39m[WARN] ðŸ“§ Rate limit exceeded for send-email 

[90mstdout[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mInput validation[2m > [22m[2mINPUT-1: returns 400 for an invalid email type
[22m[39m[INFO] ðŸ“§ API send-email: Solicitud recibida 

[90mstderr[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mInput validation[2m > [22m[2mINPUT-1: returns 400 for an invalid email type
[22m[39m[WARN] ðŸ“§ Invalid input: {
  _errors: [],
  type: {
    _errors: [
      [32m"Invalid enum value. Expected 'confirmation' | 'status-update' | 'newsletter-welcome' | 'tracking-update', received 'unknown-email-type'"[39m
    ]
  }
}

[90mstdout[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mInput validation[2m > [22m[2mINPUT-2: returns 400 for missing orderId on order email types
[22m[39m[INFO] ðŸ“§ API send-email: Solicitud recibida 

[90mstdout[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mInput validation[2m > [22m[2mINPUT-2: returns 400 for missing orderId on order email types
[22m[39m[INFO] ðŸ“§ Datos recibidos: {
  orderId: [90mundefined[39m,
  type: [32m'confirmation'[39m,
  newStatus: [90mundefined[39m,
  email: [90mundefined[39m
}

[90mstdout[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email has CSRF protection
[22m[39m[INFO] ðŸ“§ API send-email: Solicitud recibida 

[90mstdout[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mCSRF protection[2m > [22m[2mCSRF-1: returns 403 when CSRF validation fails
[22m[39m[INFO] ðŸ“§ API send-email: Solicitud recibida 

[90mstderr[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003: send-email has CSRF protection
[22m[39m[WARN] ðŸ“§ CSRF validation failed: origin mismatch

[90mstderr[2m | security-tests/integration/email/send-email.security.test.ts[2m > [22m[2mCSRF protection[2m > [22m[2mCSRF-1: returns 403 when CSRF validation fails
[22m[39m[WARN] ðŸ“§ CSRF validation failed: Origin mismatch

 [32mâœ“[39m security-tests/integration/email/send-email.security.test.ts[2m > [22mRate limiting (STRICT â€” 10 req/min)[2m > [22mRATE-1: blocks the 11th request from the same IP with 429[32m 50[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/email/send-email.security.test.ts[2m > [22mNewsletter-welcome authorization[2m > [22mAUTH-1: returns 403 when newsletter-welcome is requested without X-Internal-Secret[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/email/send-email.security.test.ts[2m > [22mNewsletter-welcome authorization[2m > [22mAUTH-1b: returns 403 when newsletter-welcome is sent with wrong internal secret[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/email/send-email.security.test.ts[2m > [22mOrder email authorization[2m > [22mAUTH-2: returns 403 for order confirmation without admin auth[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/email/send-email.security.test.ts[2m > [22mOrder email authorization[2m > [22mAUTH-2b: returns 403 for order status-update without admin auth[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/email/send-email.security.test.ts[2m > [22mOrder email authorization[2m > [22mAUTH-2c: returns 403 when a regular (non-admin) user attempts to send order email[32m 6[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/email/send-email.security.test.ts[2m > [22mAdmin order email[2m > [22mAUTH-3: admin can send order confirmation email (200)[32m 4[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/email/send-email.security.test.ts[2m > [22mInput validation[2m > [22mINPUT-1: returns 400 for an invalid email type[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/email/send-email.security.test.ts[2m > [22mInput validation[2m > [22mINPUT-2: returns 400 for missing orderId on order email types[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/email/send-email.security.test.ts[2m > [22mCSRF protection[2m > [22mCSRF-1: returns 403 when CSRF validation fails[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/coupons/validate-coupon.security.test.ts[2m > [22mCSRF protection[2m > [22mCSRF-1: rejects request with invalid origin (403)[32m 31[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/coupons/validate-coupon.security.test.ts[2m > [22mRate limiting (STANDARD â€” 60 req/min)[2m > [22mRATE-1: allows 60 requests then blocks the 61st (429)[32m 32[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/coupons/validate-coupon.security.test.ts[2m > [22mInput validation[2m > [22mINPUT-1: returns 400 for missing code field[32m 22[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/coupons/validate-coupon.security.test.ts[2m > [22mInput validation[2m > [22mINPUT-2: returns 400 for empty body[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/coupons/validate-coupon.security.test.ts[2m > [22mCoupon validity[2m > [22mCOUPON-1: returns valid=false for non-existent or inactive coupon code[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/coupons/validate-coupon.security.test.ts[2m > [22mCoupon validity[2m > [22mCOUPON-2: returns valid=false for expired coupon (endDate in past)[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/coupons/validate-coupon.security.test.ts[2m > [22mCoupon validity[2m > [22mCOUPON-3: returns valid=false when coupon not yet valid (startDate in future)[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/coupons/validate-coupon.security.test.ts[2m > [22mCoupon validity[2m > [22mCOUPON-4: returns valid=false when cartTotal < minPurchase[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/coupons/validate-coupon.security.test.ts[2m > [22mCoupon validity[2m > [22mCOUPON-5: returns valid=false when maxUses reached[32m 3[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/coupons/validate-coupon.security.test.ts[2m > [22mCoupon validity[2m > [22mCOUPON-6: returns valid=false when maxUsesPerUser reached for a specific user[32m 11[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/coupons/validate-coupon.security.test.ts[2m > [22mCoupon validity[2m > [22mCOUPON-7: returns valid=true with correct discount for a percentage coupon[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/coupons/validate-coupon.security.test.ts[2m > [22mCoupon validity[2m > [22mCOUPON-8: returns valid=true with discount capped at maxDiscount[32m 1[2mms[22m[39m
[90mstderr[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mMED-006: validate-coupon does not expose error details in production
[22m[39m[rateLimitPersistent] Firestore error, falling back to in-memory rate limiting: Error: INTERNAL_FIRESTORE_CONNECTION_STRING_secret123
    at Object.__firebase.db.collection (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/regression/fixed-vulnerabilities.test.ts:150:13)
    at rateLimitPersistent (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rateLimitPersistent.ts:108:29)
    at checkRateLimit (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rate-limiter.ts:166:26)
    at Module.POST (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/validate-coupon.ts:36:33)
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/regression/fixed-vulnerabilities.test.ts:157:23
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:157:11
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:26
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1636:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1602:10[90m)[39m
[rateLimitPersistent] Using in-memory fallback for key: validate-coupon:unknown { ok: [33mtrue[39m, remaining: [33m59[39m }

 [32mâœ“[39m security-tests/integration/payments/stripe-webhook.security.test.ts[2m > [22mSecurity: POST /api/stripe-webhook[2m > [22mSIG-1: returns 400 when stripe-signature header is absent[32m 35[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/payments/stripe-webhook.security.test.ts[2m > [22mSecurity: POST /api/stripe-webhook[2m > [22mSIG-2: returns 400 when stripe-signature header contains an invalid signature[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/payments/stripe-webhook.security.test.ts[2m > [22mSecurity: POST /api/stripe-webhook[2m > [22mSIG-3: returns 400 when stripe-signature uses wrong secret[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/payments/stripe-webhook.security.test.ts[2m > [22mSecurity: POST /api/stripe-webhook[2m > [22mIDEMPOTENCY-1: duplicate event ID returns 200 without reprocessing[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/payments/stripe-webhook.security.test.ts[2m > [22mSecurity: POST /api/stripe-webhook[2m > [22mSUCCEEDED-1: payment_intent.succeeded updates order status to "processing" and paymentStatus to "paid"[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/payments/stripe-webhook.security.test.ts[2m > [22mSecurity: POST /api/stripe-webhook[2m > [22mSUCCEEDED-2: payment_intent.succeeded event is recorded in stripe_events for idempotency[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/payments/stripe-webhook.security.test.ts[2m > [22mSecurity: POST /api/stripe-webhook[2m > [22mFAILED-1: payment_intent.payment_failed releases stock reservations[32m 4[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/payments/stripe-webhook.security.test.ts[2m > [22mSecurity: POST /api/stripe-webhook[2m > [22mFAILED-2: payment_intent.payment_failed releases wallet reservation when present[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/payments/stripe-webhook.security.test.ts[2m > [22mSecurity: POST /api/stripe-webhook[2m > [22mMISMATCH-1: does not finalize order when payment amount differs from order totalCents[32m 12[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/payments/stripe-webhook.security.test.ts[2m > [22mSecurity: POST /api/stripe-webhook[2m > [22mMISMATCH-2: does not finalize order when payment currency differs from order paymentCurrency[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/payments/stripe-webhook.security.test.ts[2m > [22mSecurity: POST /api/stripe-webhook[2m > [22mMETADATA-1: returns 200 and logs warning when event metadata has no orderId[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/admin/admin-access.security.test.ts[2m > [22mPOST /api/admin/update-order-status[2m > [22mreturns 401 when no Authorization header is provided[32m 117[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/admin/admin-access.security.test.ts[2m > [22mPOST /api/admin/update-order-status[2m > [22mreturns 401 when Authorization header is present but has no Bearer prefix[32m 11[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/admin/admin-access.security.test.ts[2m > [22mPOST /api/admin/update-order-status[2m > [22mreturns 401 when token is expired[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/admin/admin-access.security.test.ts[2m > [22mPOST /api/admin/update-order-status[2m > [22mreturns 401 when token is malformed[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/admin/admin-access.security.test.ts[2m > [22mPOST /api/admin/update-order-status[2m > [22mrejects non-admin user with 401 (verifyAdminAuth returns success: false)[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/admin/admin-access.security.test.ts[2m > [22mPOST /api/admin/update-order-status[2m > [22merror response body does not expose admin email list[32m 4[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/admin/admin-access.security.test.ts[2m > [22mPOST /api/admin/update-order-status[2m > [22mreturns 200 when a valid admin updates an existing order status[32m 3[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/admin/admin-access.security.test.ts[2m > [22mPOST /api/admin/update-order-status[2m > [22mpersists the new status in the mock DB after a successful update[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/admin/admin-access.security.test.ts[2m > [22mPOST /api/admin/update-order-status[2m > [22mreturns 400 when body is missing required id field[32m 3[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/admin/admin-access.security.test.ts[2m > [22mPOST /api/admin/update-order-status[2m > [22mreturns 400 when body is missing required status field[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/admin/admin-access.security.test.ts[2m > [22mPOST /api/admin/update-order-status[2m > [22mreturns 400 when status value is not in the whitelist[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/admin/admin-access.security.test.ts[2m > [22mPOST /api/admin/update-order-status[2m > [22mreturns 400 when status is an arbitrary SQL injection string[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/admin/admin-access.security.test.ts[2m > [22mPOST /api/admin/update-order-status[2m > [22mreturns 404 when order does not exist in the DB[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/admin/admin-access.security.test.ts[2m > [22mPOST /api/admin/update-order-status[2m > [22maccepts all valid whitelisted status values[32m 13[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/admin/admin-access.security.test.ts[2m > [22mPOST /api/admin/update-order-status[2m > [22mdoes not expose internal error details in the 400 response body[32m 2[2mms[22m[39m
[90mstdout[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003b: newsletter-welcome email blocked without X-Internal-Secret
[22m[39m[INFO] ðŸ“§ API send-email: Solicitud recibida 

[90mstderr[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003b: newsletter-welcome email blocked without X-Internal-Secret
[22m[39m[WARN] ðŸ“§ Unauthorized newsletter-welcome attempt (not internal call) 

[90mstdout[2m | security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22m[2mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22m[2mCRIT-003b: newsletter-welcome email blocked without X-Internal-Secret
[22m[39m[INFO] ðŸ“§ Datos recibidos: {
  orderId: [90mundefined[39m,
  type: [32m'newsletter-welcome'[39m,
  newStatus: [90mundefined[39m,
  email: [32m'***@***'[39m
}

 [32mâœ“[39m security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22mCRIT-003: send-email rejects unauthenticated order confirmation requests[32m 36[2mms[22m[39m
 [32mâœ“[39m security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22mCRIT-003: send-email rejects regular user sending order emails[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22mCRIT-003: send-email has rate limiting active[32m 20[2mms[22m[39m
 [32mâœ“[39m security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22mCRIT-003: send-email has CSRF protection[32m 4[2mms[22m[39m
 [32mâœ“[39m security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22mMED-006: validate-coupon does not expose error details in production[32m 20[2mms[22m[39m
 [32mâœ“[39m security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22mCRIT-003b: newsletter-welcome email blocked without X-Internal-Secret[32m 5[2mms[22m[39m
 [32mâœ“[39m security-tests/regression/fixed-vulnerabilities.test.ts[2m > [22mRegression: Fixed Vulnerabilities from SECURITY_AUDIT_REPORT[2m > [22mCSRF-REGRESSION: validate-coupon has CSRF protection[32m 11[2mms[22m[39m
[90mstderr[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mCSRF protection[2m > [22m[2mrejects request with invalid origin (403)
[22m[39m[2026-02-15T19:52:21.914Z] [WARN] [save-order] [save-order] CSRF validation failed: "Origin mismatch"

[90mstderr[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mCSRF protection[2m > [22m[2mrejects request with missing Origin header (403)
[22m[39m[2026-02-15T19:52:21.918Z] [WARN] [save-order] [save-order] CSRF validation failed: "Missing origin"

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mCSRF protection[2m > [22m[2mallows request that passes CSRF validation (200)
[22m[39m[2026-02-15T19:52:21.920Z] [INFO] [save-order] [save-order] Guest checkout (no authentication)
[2026-02-15T19:52:21.920Z] [INFO] [save-order] API save-order: Solicitud recibida

 [32mâœ“[39m security-tests/input-validation/payloads.test.ts[2m > [22mInput Validation: Attack payloads against API endpoints[2m > [22mXSS payloads in validate-coupon[2m > [22mrejects or handles XSS in coupon code: <script>alert(1)</script>...[32m 36[2mms[22m[39m
 [32mâœ“[39m security-tests/input-validation/payloads.test.ts[2m > [22mInput Validation: Attack payloads against API endpoints[2m > [22mXSS payloads in validate-coupon[2m > [22mrejects or handles XSS in coupon code: <img src=x onerror=alert(1)>...[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/input-validation/payloads.test.ts[2m > [22mInput Validation: Attack payloads against API endpoints[2m > [22mXSS payloads in validate-coupon[2m > [22mrejects or handles XSS in coupon code: "><script>alert(document.cooki...[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/input-validation/payloads.test.ts[2m > [22mInput Validation: Attack payloads against API endpoints[2m > [22mXSS payloads in validate-coupon[2m > [22mrejects or handles XSS in coupon code: javascript:alert('XSS')...[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/input-validation/payloads.test.ts[2m > [22mInput Validation: Attack payloads against API endpoints[2m > [22mXSS payloads in validate-coupon[2m > [22mrejects or handles XSS in coupon code: <svg onload=alert(1)>...[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/input-validation/payloads.test.ts[2m > [22mInput Validation: Attack payloads against API endpoints[2m > [22mXSS payloads in validate-coupon[2m > [22mrejects or handles XSS in coupon code: <body onload=alert(1)>...[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/input-validation/payloads.test.ts[2m > [22mInput Validation: Attack payloads against API endpoints[2m > [22mXSS payloads in validate-coupon[2m > [22mrejects or handles XSS in coupon code: ${alert(1)}...[32m 3[2mms[22m[39m
 [32mâœ“[39m security-tests/input-validation/payloads.test.ts[2m > [22mInput Validation: Attack payloads against API endpoints[2m > [22mXSS payloads in validate-coupon[2m > [22mrejects or handles XSS in coupon code: {{constructor.constructor("ret...[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/input-validation/payloads.test.ts[2m > [22mInput Validation: Attack payloads against API endpoints[2m > [22mSQL injection payloads in validate-coupon[2m > [22mhandles SQL injection payload: ' OR '1'='1...[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/input-validation/payloads.test.ts[2m > [22mInput Validation: Attack payloads against API endpoints[2m > [22mSQL injection payloads in validate-coupon[2m > [22mhandles SQL injection payload: '; DROP TABLE users;--...[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/input-validation/payloads.test.ts[2m > [22mInput Validation: Attack payloads against API endpoints[2m > [22mSQL injection payloads in validate-coupon[2m > [22mhandles SQL injection payload: ' UNION SELECT * FROM users--...[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/input-validation/payloads.test.ts[2m > [22mInput Validation: Attack payloads against API endpoints[2m > [22mSQL injection payloads in validate-coupon[2m > [22mhandles SQL injection payload: 1' AND '1'='1...[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/input-validation/payloads.test.ts[2m > [22mInput Validation: Attack payloads against API endpoints[2m > [22mSQL injection payloads in validate-coupon[2m > [22mhandles SQL injection payload: admin'--...[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/input-validation/payloads.test.ts[2m > [22mInput Validation: Attack payloads against API endpoints[2m > [22mPrototype pollution in save-order[2m > [22mrejects __proto__ in request body[32m 19[2mms[22m[39m
 [32mâœ“[39m security-tests/input-validation/payloads.test.ts[2m > [22mInput Validation: Attack payloads against API endpoints[2m > [22mPrototype pollution in save-order[2m > [22mrejects constructor.prototype pollution in coupon code[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/input-validation/payloads.test.ts[2m > [22mInput Validation: Attack payloads against API endpoints[2m > [22mLong string payloads[2m > [22mvalidate-coupon handles 100k character code without crashing[32m 5[2mms[22m[39m
 [32mâœ“[39m security-tests/input-validation/payloads.test.ts[2m > [22mInput Validation: Attack payloads against API endpoints[2m > [22mLong string payloads[2m > [22msave-order handles extremely long product names[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/input-validation/payloads.test.ts[2m > [22mInput Validation: Attack payloads against API endpoints[2m > [22mUnicode and null byte payloads[2m > [22mvalidate-coupon handles null bytes in code[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/input-validation/payloads.test.ts[2m > [22mInput Validation: Attack payloads against API endpoints[2m > [22mUnicode and null byte payloads[2m > [22mvalidate-coupon handles zero-width space characters[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/input-validation/payloads.test.ts[2m > [22mInput Validation: Attack payloads against API endpoints[2m > [22mMalformed request bodies[2m > [22mvalidate-coupon returns 400/500 for non-JSON body[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/input-validation/payloads.test.ts[2m > [22mInput Validation: Attack payloads against API endpoints[2m > [22mMalformed request bodies[2m > [22mvalidate-coupon handles null body fields[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/input-validation/payloads.test.ts[2m > [22mInput Validation: Attack payloads against API endpoints[2m > [22mMalformed request bodies[2m > [22mvalidate-coupon handles array instead of object[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/input-validation/payloads.test.ts[2m > [22mInput Validation: Attack payloads against API endpoints[2m > [22mNumeric edge cases[2m > [22mvalidate-coupon handles negative cartTotal[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/input-validation/payloads.test.ts[2m > [22mInput Validation: Attack payloads against API endpoints[2m > [22mNumeric edge cases[2m > [22mvalidate-coupon handles Infinity cartTotal[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/input-validation/payloads.test.ts[2m > [22mInput Validation: Attack payloads against API endpoints[2m > [22mNumeric edge cases[2m > [22mvalidate-coupon handles NaN cartTotal[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/input-validation/payloads.test.ts[2m > [22mInput Validation: Attack payloads against API endpoints[2m > [22mNoSQL injection payloads[2m > [22mhandles NoSQL injection: {"$gt":""}...[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/input-validation/payloads.test.ts[2m > [22mInput Validation: Attack payloads against API endpoints[2m > [22mNoSQL injection payloads[2m > [22mhandles NoSQL injection: {"$ne":""}...[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/input-validation/payloads.test.ts[2m > [22mInput Validation: Attack payloads against API endpoints[2m > [22mNoSQL injection payloads[2m > [22mhandles NoSQL injection: {"$regex":".*"}...[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/input-validation/payloads.test.ts[2m > [22mInput Validation: Attack payloads against API endpoints[2m > [22mNoSQL injection payloads[2m > [22mhandles NoSQL injection: {"$where":"1==1"}...[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/input-validation/payloads.test.ts[2m > [22mInput Validation: Attack payloads against API endpoints[2m > [22mNoSQL injection payloads[2m > [22mhandles NoSQL injection: {"__proto__":{"isAdmin":true}}...[32m 0[2mms[22m[39m
[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mCSRF protection[2m > [22m[2mallows request that passes CSRF validation (200)
[22m[39m[2026-02-15T19:52:21.922Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{\n  \"idempotencyKey\": \"ck-1771185141919-pukzt0e4kik\",\n  \"checkoutId\": \"ck-1771185141919-pukzt0e4kik\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"usedWallet\": false\n}"
[2026-02-15T19:52:21.925Z] [INFO] [save-order] API save-order: Datos validados: "{\n  \"idempotencyKey\": \"ck-1771185141919-pukzt0e4kik\",\n  \"checkoutId\": \"ck-1771185141919-pukzt0e4kik\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"paymentMethod\": \"card\",\n  \"usedWallet\": false\n}"
[2026-02-15T19:52:21.925Z] [INFO] [save-order] API save-order: Intentando guardar en Firestore con Admin SDK...

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mCSRF protection[2m > [22m[2mallows request that passes CSRF validation (200)
[22m[39m[2026-02-15T19:52:21.929Z] [INFO] [save-order] [reserve_stock_success] {"orderId":"auto_orders_1","itemsCount":1}
[2026-02-15T19:52:21.930Z] [INFO] [save-order] API save-order: Pedido guardado con ID: "auto_orders_1"
[2026-02-15T19:52:21.930Z] [INFO] [save-order] [save-order] Order auto_orders_1 created with status 'pending'. Post-payment actions will run after payment confirmation via webhook.

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mallows the first 10 requests and blocks the 11th (429)
[22m[39m[2026-02-15T19:52:21.933Z] [INFO] [save-order] [save-order] Guest checkout (no authentication)
[2026-02-15T19:52:21.933Z] [INFO] [save-order] API save-order: Solicitud recibida

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mallows the first 10 requests and blocks the 11th (429)
[22m[39m[2026-02-15T19:52:21.934Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{\n  \"idempotencyKey\": \"rl-key-0-1771185141932\",\n  \"checkoutId\": \"rl-key-0-1771185141932\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"usedWallet\": false\n}"
[2026-02-15T19:52:21.934Z] [INFO] [save-order] API save-order: Datos validados: "{\n  \"idempotencyKey\": \"rl-key-0-1771185141932\",\n  \"checkoutId\": \"rl-key-0-1771185141932\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"paymentMethod\": \"card\",\n  \"usedWallet\": false\n}"
[2026-02-15T19:52:21.935Z] [INFO] [save-order] API save-order: Intentando guardar en Firestore con Admin SDK...

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mallows the first 10 requests and blocks the 11th (429)
[22m[39m[2026-02-15T19:52:21.937Z] [INFO] [save-order] [reserve_stock_success] {"orderId":"auto_orders_2","itemsCount":1}
[2026-02-15T19:52:21.937Z] [INFO] [save-order] API save-order: Pedido guardado con ID: "auto_orders_2"
[2026-02-15T19:52:21.937Z] [INFO] [save-order] [save-order] Order auto_orders_2 created with status 'pending'. Post-payment actions will run after payment confirmation via webhook.

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mallows the first 10 requests and blocks the 11th (429)
[22m[39m[2026-02-15T19:52:21.938Z] [INFO] [save-order] [save-order] Guest checkout (no authentication)
[2026-02-15T19:52:21.938Z] [INFO] [save-order] API save-order: Solicitud recibida

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mallows the first 10 requests and blocks the 11th (429)
[22m[39m[2026-02-15T19:52:21.938Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{\n  \"idempotencyKey\": \"rl-key-1-1771185141937\",\n  \"checkoutId\": \"rl-key-1-1771185141937\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"usedWallet\": false\n}"
[2026-02-15T19:52:21.939Z] [INFO] [save-order] API save-order: Datos validados: "{\n  \"idempotencyKey\": \"rl-key-1-1771185141937\",\n  \"checkoutId\": \"rl-key-1-1771185141937\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"paymentMethod\": \"card\",\n  \"usedWallet\": false\n}"
[2026-02-15T19:52:21.939Z] [INFO] [save-order] API save-order: Intentando guardar en Firestore con Admin SDK...

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mallows the first 10 requests and blocks the 11th (429)
[22m[39m[2026-02-15T19:52:21.939Z] [INFO] [save-order] [reserve_stock_success] {"orderId":"auto_orders_3","itemsCount":1}
[2026-02-15T19:52:21.939Z] [INFO] [save-order] API save-order: Pedido guardado con ID: "auto_orders_3"
[2026-02-15T19:52:21.939Z] [INFO] [save-order] [save-order] Order auto_orders_3 created with status 'pending'. Post-payment actions will run after payment confirmation via webhook.

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mallows the first 10 requests and blocks the 11th (429)
[22m[39m[2026-02-15T19:52:21.940Z] [INFO] [save-order] [save-order] Guest checkout (no authentication)
[2026-02-15T19:52:21.940Z] [INFO] [save-order] API save-order: Solicitud recibida

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mallows the first 10 requests and blocks the 11th (429)
[22m[39m[2026-02-15T19:52:21.940Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{\n  \"idempotencyKey\": \"rl-key-2-1771185141940\",\n  \"checkoutId\": \"rl-key-2-1771185141940\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"usedWallet\": false\n}"
[2026-02-15T19:52:21.941Z] [INFO] [save-order] API save-order: Datos validados: "{\n  \"idempotencyKey\": \"rl-key-2-1771185141940\",\n  \"checkoutId\": \"rl-key-2-1771185141940\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"paymentMethod\": \"card\",\n  \"usedWallet\": false\n}"
[2026-02-15T19:52:21.941Z] [INFO] [save-order] API save-order: Intentando guardar en Firestore con Admin SDK...

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mallows the first 10 requests and blocks the 11th (429)
[22m[39m[2026-02-15T19:52:21.941Z] [INFO] [save-order] [reserve_stock_success] {"orderId":"auto_orders_4","itemsCount":1}
[2026-02-15T19:52:21.941Z] [INFO] [save-order] API save-order: Pedido guardado con ID: "auto_orders_4"
[2026-02-15T19:52:21.941Z] [INFO] [save-order] [save-order] Order auto_orders_4 created with status 'pending'. Post-payment actions will run after payment confirmation via webhook.

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mallows the first 10 requests and blocks the 11th (429)
[22m[39m[2026-02-15T19:52:21.942Z] [INFO] [save-order] [save-order] Guest checkout (no authentication)
[2026-02-15T19:52:21.942Z] [INFO] [save-order] API save-order: Solicitud recibida

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mallows the first 10 requests and blocks the 11th (429)
[22m[39m[2026-02-15T19:52:21.942Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{\n  \"idempotencyKey\": \"rl-key-3-1771185141942\",\n  \"checkoutId\": \"rl-key-3-1771185141942\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"usedWallet\": false\n}"
[2026-02-15T19:52:21.942Z] [INFO] [save-order] API save-order: Datos validados: "{\n  \"idempotencyKey\": \"rl-key-3-1771185141942\",\n  \"checkoutId\": \"rl-key-3-1771185141942\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"paymentMethod\": \"card\",\n  \"usedWallet\": false\n}"
[2026-02-15T19:52:21.942Z] [INFO] [save-order] API save-order: Intentando guardar en Firestore con Admin SDK...

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mallows the first 10 requests and blocks the 11th (429)
[22m[39m[2026-02-15T19:52:21.943Z] [INFO] [save-order] [reserve_stock_success] {"orderId":"auto_orders_5","itemsCount":1}
[2026-02-15T19:52:21.943Z] [INFO] [save-order] API save-order: Pedido guardado con ID: "auto_orders_5"
[2026-02-15T19:52:21.943Z] [INFO] [save-order] [save-order] Order auto_orders_5 created with status 'pending'. Post-payment actions will run after payment confirmation via webhook.

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mallows the first 10 requests and blocks the 11th (429)
[22m[39m[2026-02-15T19:52:21.944Z] [INFO] [save-order] [save-order] Guest checkout (no authentication)
[2026-02-15T19:52:21.944Z] [INFO] [save-order] API save-order: Solicitud recibida

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mallows the first 10 requests and blocks the 11th (429)
[22m[39m[2026-02-15T19:52:21.944Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{\n  \"idempotencyKey\": \"rl-key-4-1771185141944\",\n  \"checkoutId\": \"rl-key-4-1771185141944\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"usedWallet\": false\n}"
[2026-02-15T19:52:21.944Z] [INFO] [save-order] API save-order: Datos validados: "{\n  \"idempotencyKey\": \"rl-key-4-1771185141944\",\n  \"checkoutId\": \"rl-key-4-1771185141944\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"paymentMethod\": \"card\",\n  \"usedWallet\": false\n}"
[2026-02-15T19:52:21.944Z] [INFO] [save-order] API save-order: Intentando guardar en Firestore con Admin SDK...

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mallows the first 10 requests and blocks the 11th (429)
[22m[39m[2026-02-15T19:52:21.945Z] [INFO] [save-order] [reserve_stock_success] {"orderId":"auto_orders_6","itemsCount":1}
[2026-02-15T19:52:21.945Z] [INFO] [save-order] API save-order: Pedido guardado con ID: "auto_orders_6"
[2026-02-15T19:52:21.945Z] [INFO] [save-order] [save-order] Order auto_orders_6 created with status 'pending'. Post-payment actions will run after payment confirmation via webhook.

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mallows the first 10 requests and blocks the 11th (429)
[22m[39m[2026-02-15T19:52:21.946Z] [INFO] [save-order] [save-order] Guest checkout (no authentication)
[2026-02-15T19:52:21.946Z] [INFO] [save-order] API save-order: Solicitud recibida

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mallows the first 10 requests and blocks the 11th (429)
[22m[39m[2026-02-15T19:52:21.946Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{\n  \"idempotencyKey\": \"rl-key-5-1771185141945\",\n  \"checkoutId\": \"rl-key-5-1771185141945\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"usedWallet\": false\n}"
[2026-02-15T19:52:21.946Z] [INFO] [save-order] API save-order: Datos validados: "{\n  \"idempotencyKey\": \"rl-key-5-1771185141945\",\n  \"checkoutId\": \"rl-key-5-1771185141945\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"paymentMethod\": \"card\",\n  \"usedWallet\": false\n}"
[2026-02-15T19:52:21.946Z] [INFO] [save-order] API save-order: Intentando guardar en Firestore con Admin SDK...

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mallows the first 10 requests and blocks the 11th (429)
[22m[39m[2026-02-15T19:52:21.946Z] [INFO] [save-order] [reserve_stock_success] {"orderId":"auto_orders_7","itemsCount":1}
[2026-02-15T19:52:21.946Z] [INFO] [save-order] API save-order: Pedido guardado con ID: "auto_orders_7"
[2026-02-15T19:52:21.946Z] [INFO] [save-order] [save-order] Order auto_orders_7 created with status 'pending'. Post-payment actions will run after payment confirmation via webhook.

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mallows the first 10 requests and blocks the 11th (429)
[22m[39m[2026-02-15T19:52:21.947Z] [INFO] [save-order] [save-order] Guest checkout (no authentication)
[2026-02-15T19:52:21.947Z] [INFO] [save-order] API save-order: Solicitud recibida

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mallows the first 10 requests and blocks the 11th (429)
[22m[39m[2026-02-15T19:52:21.947Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{\n  \"idempotencyKey\": \"rl-key-6-1771185141947\",\n  \"checkoutId\": \"rl-key-6-1771185141947\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"usedWallet\": false\n}"
[2026-02-15T19:52:21.948Z] [INFO] [save-order] API save-order: Datos validados: "{\n  \"idempotencyKey\": \"rl-key-6-1771185141947\",\n  \"checkoutId\": \"rl-key-6-1771185141947\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"paymentMethod\": \"card\",\n  \"usedWallet\": false\n}"
[2026-02-15T19:52:21.948Z] [INFO] [save-order] API save-order: Intentando guardar en Firestore con Admin SDK...

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mallows the first 10 requests and blocks the 11th (429)
[22m[39m[2026-02-15T19:52:21.948Z] [INFO] [save-order] [reserve_stock_success] {"orderId":"auto_orders_8","itemsCount":1}
[2026-02-15T19:52:21.948Z] [INFO] [save-order] API save-order: Pedido guardado con ID: "auto_orders_8"
[2026-02-15T19:52:21.948Z] [INFO] [save-order] [save-order] Order auto_orders_8 created with status 'pending'. Post-payment actions will run after payment confirmation via webhook.

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mallows the first 10 requests and blocks the 11th (429)
[22m[39m[2026-02-15T19:52:21.949Z] [INFO] [save-order] [save-order] Guest checkout (no authentication)
[2026-02-15T19:52:21.949Z] [INFO] [save-order] API save-order: Solicitud recibida

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mallows the first 10 requests and blocks the 11th (429)
[22m[39m[2026-02-15T19:52:21.949Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{\n  \"idempotencyKey\": \"rl-key-7-1771185141948\",\n  \"checkoutId\": \"rl-key-7-1771185141948\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"usedWallet\": false\n}"
[2026-02-15T19:52:21.949Z] [INFO] [save-order] API save-order: Datos validados: "{\n  \"idempotencyKey\": \"rl-key-7-1771185141948\",\n  \"checkoutId\": \"rl-key-7-1771185141948\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"paymentMethod\": \"card\",\n  \"usedWallet\": false\n}"
[2026-02-15T19:52:21.949Z] [INFO] [save-order] API save-order: Intentando guardar en Firestore con Admin SDK...

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mallows the first 10 requests and blocks the 11th (429)
[22m[39m[2026-02-15T19:52:21.951Z] [INFO] [save-order] [reserve_stock_success] {"orderId":"auto_orders_9","itemsCount":1}
[2026-02-15T19:52:21.951Z] [INFO] [save-order] API save-order: Pedido guardado con ID: "auto_orders_9"
[2026-02-15T19:52:21.951Z] [INFO] [save-order] [save-order] Order auto_orders_9 created with status 'pending'. Post-payment actions will run after payment confirmation via webhook.

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mallows the first 10 requests and blocks the 11th (429)
[22m[39m[2026-02-15T19:52:21.952Z] [INFO] [save-order] [save-order] Guest checkout (no authentication)
[2026-02-15T19:52:21.952Z] [INFO] [save-order] API save-order: Solicitud recibida

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mallows the first 10 requests and blocks the 11th (429)
[22m[39m[2026-02-15T19:52:21.952Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{\n  \"idempotencyKey\": \"rl-key-8-1771185141951\",\n  \"checkoutId\": \"rl-key-8-1771185141951\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"usedWallet\": false\n}"
[2026-02-15T19:52:21.952Z] [INFO] [save-order] API save-order: Datos validados: "{\n  \"idempotencyKey\": \"rl-key-8-1771185141951\",\n  \"checkoutId\": \"rl-key-8-1771185141951\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"paymentMethod\": \"card\",\n  \"usedWallet\": false\n}"
[2026-02-15T19:52:21.952Z] [INFO] [save-order] API save-order: Intentando guardar en Firestore con Admin SDK...

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mallows the first 10 requests and blocks the 11th (429)
[22m[39m[2026-02-15T19:52:21.953Z] [INFO] [save-order] [reserve_stock_success] {"orderId":"auto_orders_10","itemsCount":1}
[2026-02-15T19:52:21.953Z] [INFO] [save-order] API save-order: Pedido guardado con ID: "auto_orders_10"
[2026-02-15T19:52:21.953Z] [INFO] [save-order] [save-order] Order auto_orders_10 created with status 'pending'. Post-payment actions will run after payment confirmation via webhook.

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mallows the first 10 requests and blocks the 11th (429)
[22m[39m[2026-02-15T19:52:21.954Z] [INFO] [save-order] [save-order] Guest checkout (no authentication)
[2026-02-15T19:52:21.954Z] [INFO] [save-order] API save-order: Solicitud recibida

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mallows the first 10 requests and blocks the 11th (429)
[22m[39m[2026-02-15T19:52:21.954Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{\n  \"idempotencyKey\": \"rl-key-9-1771185141954\",\n  \"checkoutId\": \"rl-key-9-1771185141954\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"usedWallet\": false\n}"
[2026-02-15T19:52:21.954Z] [INFO] [save-order] API save-order: Datos validados: "{\n  \"idempotencyKey\": \"rl-key-9-1771185141954\",\n  \"checkoutId\": \"rl-key-9-1771185141954\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"paymentMethod\": \"card\",\n  \"usedWallet\": false\n}"
[2026-02-15T19:52:21.954Z] [INFO] [save-order] API save-order: Intentando guardar en Firestore con Admin SDK...

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mallows the first 10 requests and blocks the 11th (429)
[22m[39m[2026-02-15T19:52:21.955Z] [INFO] [save-order] [reserve_stock_success] {"orderId":"auto_orders_11","itemsCount":1}
[2026-02-15T19:52:21.955Z] [INFO] [save-order] API save-order: Pedido guardado con ID: "auto_orders_11"
[2026-02-15T19:52:21.955Z] [INFO] [save-order] [save-order] Order auto_orders_11 created with status 'pending'. Post-payment actions will run after payment confirmation via webhook.

[90mstderr[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mallows the first 10 requests and blocks the 11th (429)
[22m[39m[2026-02-15T19:52:21.955Z] [WARN] [save-order] [save-order] Rate limit exceeded

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mreturns Retry-After header on 429
[22m[39m[2026-02-15T19:52:21.956Z] [INFO] [save-order] [save-order] Guest checkout (no authentication)
[2026-02-15T19:52:21.956Z] [INFO] [save-order] API save-order: Solicitud recibida

[90mstderr[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mreturns Retry-After header on 429
[22m[39m[2026-02-15T19:52:21.958Z] [ERROR] [save-order] API save-order: ValidaciÃ³n Zod fallÃ³: {"error":"[\n  {\n    \"path\": \"idempotencyKey\",\n    \"message\": \"String must contain at least 10 character(s)\",\n    \"code\": \"too_small\"\n  },\n  {\n    \"path\": \"checkoutId\",\n    \"message\": \"String must contain at least 10 character(s)\",\n    \"code\": \"too_small\"\n  }\n]"}

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mreturns Retry-After header on 429
[22m[39m[2026-02-15T19:52:21.957Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{\n  \"idempotencyKey\": \"ra-key-0\",\n  \"checkoutId\": \"ra-key-0\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"usedWallet\": false\n}"

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mreturns Retry-After header on 429
[22m[39m[2026-02-15T19:52:21.958Z] [INFO] [save-order] [save-order] Guest checkout (no authentication)
[2026-02-15T19:52:21.958Z] [INFO] [save-order] API save-order: Solicitud recibida

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mreturns Retry-After header on 429
[22m[39m[2026-02-15T19:52:21.958Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{\n  \"idempotencyKey\": \"ra-key-1\",\n  \"checkoutId\": \"ra-key-1\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"usedWallet\": false\n}"

[90mstderr[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mreturns Retry-After header on 429
[22m[39m[2026-02-15T19:52:21.959Z] [ERROR] [save-order] API save-order: ValidaciÃ³n Zod fallÃ³: {"error":"[\n  {\n    \"path\": \"idempotencyKey\",\n    \"message\": \"String must contain at least 10 character(s)\",\n    \"code\": \"too_small\"\n  },\n  {\n    \"path\": \"checkoutId\",\n    \"message\": \"String must contain at least 10 character(s)\",\n    \"code\": \"too_small\"\n  }\n]"}

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mreturns Retry-After header on 429
[22m[39m[2026-02-15T19:52:21.959Z] [INFO] [save-order] [save-order] Guest checkout (no authentication)
[2026-02-15T19:52:21.959Z] [INFO] [save-order] API save-order: Solicitud recibida

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mreturns Retry-After header on 429
[22m[39m[2026-02-15T19:52:21.959Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{\n  \"idempotencyKey\": \"ra-key-2\",\n  \"checkoutId\": \"ra-key-2\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"usedWallet\": false\n}"

[90mstderr[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mreturns Retry-After header on 429
[22m[39m[2026-02-15T19:52:21.959Z] [ERROR] [save-order] API save-order: ValidaciÃ³n Zod fallÃ³: {"error":"[\n  {\n    \"path\": \"idempotencyKey\",\n    \"message\": \"String must contain at least 10 character(s)\",\n    \"code\": \"too_small\"\n  },\n  {\n    \"path\": \"checkoutId\",\n    \"message\": \"String must contain at least 10 character(s)\",\n    \"code\": \"too_small\"\n  }\n]"}

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mreturns Retry-After header on 429
[22m[39m[2026-02-15T19:52:21.960Z] [INFO] [save-order] [save-order] Guest checkout (no authentication)
[2026-02-15T19:52:21.960Z] [INFO] [save-order] API save-order: Solicitud recibida

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mreturns Retry-After header on 429
[22m[39m[2026-02-15T19:52:21.960Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{\n  \"idempotencyKey\": \"ra-key-3\",\n  \"checkoutId\": \"ra-key-3\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"usedWallet\": false\n}"

[90mstderr[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mreturns Retry-After header on 429
[22m[39m[2026-02-15T19:52:21.960Z] [ERROR] [save-order] API save-order: ValidaciÃ³n Zod fallÃ³: {"error":"[\n  {\n    \"path\": \"idempotencyKey\",\n    \"message\": \"String must contain at least 10 character(s)\",\n    \"code\": \"too_small\"\n  },\n  {\n    \"path\": \"checkoutId\",\n    \"message\": \"String must contain at least 10 character(s)\",\n    \"code\": \"too_small\"\n  }\n]"}

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mreturns Retry-After header on 429
[22m[39m[2026-02-15T19:52:21.961Z] [INFO] [save-order] [save-order] Guest checkout (no authentication)
[2026-02-15T19:52:21.961Z] [INFO] [save-order] API save-order: Solicitud recibida

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mreturns Retry-After header on 429
[22m[39m[2026-02-15T19:52:21.962Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{\n  \"idempotencyKey\": \"ra-key-4\",\n  \"checkoutId\": \"ra-key-4\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"usedWallet\": false\n}"

[90mstderr[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mreturns Retry-After header on 429
[22m[39m[2026-02-15T19:52:21.963Z] [ERROR] [save-order] API save-order: ValidaciÃ³n Zod fallÃ³: {"error":"[\n  {\n    \"path\": \"idempotencyKey\",\n    \"message\": \"String must contain at least 10 character(s)\",\n    \"code\": \"too_small\"\n  },\n  {\n    \"path\": \"checkoutId\",\n    \"message\": \"String must contain at least 10 character(s)\",\n    \"code\": \"too_small\"\n  }\n]"}

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mreturns Retry-After header on 429
[22m[39m[2026-02-15T19:52:21.963Z] [INFO] [save-order] [save-order] Guest checkout (no authentication)
[2026-02-15T19:52:21.963Z] [INFO] [save-order] API save-order: Solicitud recibida

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mreturns Retry-After header on 429
[22m[39m[2026-02-15T19:52:21.963Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{\n  \"idempotencyKey\": \"ra-key-5\",\n  \"checkoutId\": \"ra-key-5\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"usedWallet\": false\n}"

[90mstderr[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mreturns Retry-After header on 429
[22m[39m[2026-02-15T19:52:21.963Z] [ERROR] [save-order] API save-order: ValidaciÃ³n Zod fallÃ³: {"error":"[\n  {\n    \"path\": \"idempotencyKey\",\n    \"message\": \"String must contain at least 10 character(s)\",\n    \"code\": \"too_small\"\n  },\n  {\n    \"path\": \"checkoutId\",\n    \"message\": \"String must contain at least 10 character(s)\",\n    \"code\": \"too_small\"\n  }\n]"}

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mreturns Retry-After header on 429
[22m[39m[2026-02-15T19:52:21.964Z] [INFO] [save-order] [save-order] Guest checkout (no authentication)
[2026-02-15T19:52:21.964Z] [INFO] [save-order] API save-order: Solicitud recibida

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mreturns Retry-After header on 429
[22m[39m[2026-02-15T19:52:21.964Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{\n  \"idempotencyKey\": \"ra-key-6\",\n  \"checkoutId\": \"ra-key-6\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"usedWallet\": false\n}"

[90mstderr[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mreturns Retry-After header on 429
[22m[39m[2026-02-15T19:52:21.964Z] [ERROR] [save-order] API save-order: ValidaciÃ³n Zod fallÃ³: {"error":"[\n  {\n    \"path\": \"idempotencyKey\",\n    \"message\": \"String must contain at least 10 character(s)\",\n    \"code\": \"too_small\"\n  },\n  {\n    \"path\": \"checkoutId\",\n    \"message\": \"String must contain at least 10 character(s)\",\n    \"code\": \"too_small\"\n  }\n]"}

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mreturns Retry-After header on 429
[22m[39m[2026-02-15T19:52:21.964Z] [INFO] [save-order] [save-order] Guest checkout (no authentication)
[2026-02-15T19:52:21.964Z] [INFO] [save-order] API save-order: Solicitud recibida

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mreturns Retry-After header on 429
[22m[39m[2026-02-15T19:52:21.964Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{\n  \"idempotencyKey\": \"ra-key-7\",\n  \"checkoutId\": \"ra-key-7\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"usedWallet\": false\n}"

[90mstderr[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mreturns Retry-After header on 429
[22m[39m[2026-02-15T19:52:21.964Z] [ERROR] [save-order] API save-order: ValidaciÃ³n Zod fallÃ³: {"error":"[\n  {\n    \"path\": \"idempotencyKey\",\n    \"message\": \"String must contain at least 10 character(s)\",\n    \"code\": \"too_small\"\n  },\n  {\n    \"path\": \"checkoutId\",\n    \"message\": \"String must contain at least 10 character(s)\",\n    \"code\": \"too_small\"\n  }\n]"}

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mreturns Retry-After header on 429
[22m[39m[2026-02-15T19:52:21.965Z] [INFO] [save-order] [save-order] Guest checkout (no authentication)
[2026-02-15T19:52:21.965Z] [INFO] [save-order] API save-order: Solicitud recibida

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mreturns Retry-After header on 429
[22m[39m[2026-02-15T19:52:21.965Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{\n  \"idempotencyKey\": \"ra-key-8\",\n  \"checkoutId\": \"ra-key-8\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"usedWallet\": false\n}"

[90mstderr[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mreturns Retry-After header on 429
[22m[39m[2026-02-15T19:52:21.965Z] [ERROR] [save-order] API save-order: ValidaciÃ³n Zod fallÃ³: {"error":"[\n  {\n    \"path\": \"idempotencyKey\",\n    \"message\": \"String must contain at least 10 character(s)\",\n    \"code\": \"too_small\"\n  },\n  {\n    \"path\": \"checkoutId\",\n    \"message\": \"String must contain at least 10 character(s)\",\n    \"code\": \"too_small\"\n  }\n]"}

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mreturns Retry-After header on 429
[22m[39m[2026-02-15T19:52:21.965Z] [INFO] [save-order] [save-order] Guest checkout (no authentication)
[2026-02-15T19:52:21.965Z] [INFO] [save-order] API save-order: Solicitud recibida

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mreturns Retry-After header on 429
[22m[39m[2026-02-15T19:52:21.965Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{\n  \"idempotencyKey\": \"ra-key-9\",\n  \"checkoutId\": \"ra-key-9\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"usedWallet\": false\n}"

[90mstderr[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mreturns Retry-After header on 429
[22m[39m[2026-02-15T19:52:21.965Z] [ERROR] [save-order] API save-order: ValidaciÃ³n Zod fallÃ³: {"error":"[\n  {\n    \"path\": \"idempotencyKey\",\n    \"message\": \"String must contain at least 10 character(s)\",\n    \"code\": \"too_small\"\n  },\n  {\n    \"path\": \"checkoutId\",\n    \"message\": \"String must contain at least 10 character(s)\",\n    \"code\": \"too_small\"\n  }\n]"}

[90mstderr[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mreturns Retry-After header on 429
[22m[39m[2026-02-15T19:52:21.966Z] [WARN] [save-order] [save-order] Rate limit exceeded

[90mstderr[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mRate limiting (STRICT â€” 10 req/min)[2m > [22m[2mreturns Retry-After header on 429
[22m[39m[2026-02-15T19:52:21.966Z] [WARN] [save-order] [save-order] Rate limit exceeded

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mInput validation[2m > [22m[2mreturns 400 for an empty body
[22m[39m[2026-02-15T19:52:21.967Z] [INFO] [save-order] [save-order] Guest checkout (no authentication)
[2026-02-15T19:52:21.968Z] [INFO] [save-order] API save-order: Solicitud recibida

[90mstderr[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mInput validation[2m > [22m[2mreturns 400 for an empty body
[22m[39m[2026-02-15T19:52:21.968Z] [ERROR] [save-order] API save-order: ValidaciÃ³n Zod fallÃ³: {"error":"[\n  {\n    \"path\": \"idempotencyKey\",\n    \"message\": \"Required\",\n    \"code\": \"invalid_type\"\n  },\n  {\n    \"path\": \"checkoutId\",\n    \"message\": \"Required\",\n    \"code\": \"invalid_type\"\n  },\n  {\n    \"path\": \"items\",\n    \"message\": \"Required\",\n    \"code\": \"invalid_type\"\n  },\n  {\n    \"path\": \"shippingInfo\",\n    \"message\": \"Required\",\n    \"code\": \"invalid_type\"\n  }\n]"}

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mInput validation[2m > [22m[2mreturns 400 for an empty body
[22m[39m[2026-02-15T19:52:21.968Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{}"

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mInput validation[2m > [22m[2mreturns 400 when items array is missing
[22m[39m[2026-02-15T19:52:21.970Z] [INFO] [save-order] [save-order] Guest checkout (no authentication)
[2026-02-15T19:52:21.970Z] [INFO] [save-order] API save-order: Solicitud recibida

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mInput validation[2m > [22m[2mreturns 400 when items array is missing
[22m[39m[2026-02-15T19:52:21.970Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{\n  \"idempotencyKey\": \"ck-1771185141970-opbfcfioc5c\",\n  \"checkoutId\": \"ck-1771185141970-opbfcfioc5c\",\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"usedWallet\": false\n}"

[90mstderr[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mInput validation[2m > [22m[2mreturns 400 when items array is missing
[22m[39m[2026-02-15T19:52:21.970Z] [ERROR] [save-order] API save-order: ValidaciÃ³n Zod fallÃ³: {"error":"[\n  {\n    \"path\": \"items\",\n    \"message\": \"Required\",\n    \"code\": \"invalid_type\"\n  }\n]"}

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mInput validation[2m > [22m[2mreturns 400 when items array is empty
[22m[39m[2026-02-15T19:52:21.971Z] [INFO] [save-order] [save-order] Guest checkout (no authentication)
[2026-02-15T19:52:21.971Z] [INFO] [save-order] API save-order: Solicitud recibida

[90mstderr[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mInput validation[2m > [22m[2mreturns 400 when items array is empty
[22m[39m[2026-02-15T19:52:21.972Z] [ERROR] [save-order] API save-order: ValidaciÃ³n Zod fallÃ³: {"error":"[\n  {\n    \"path\": \"items\",\n    \"message\": \"Array must contain at least 1 element(s)\",\n    \"code\": \"too_small\"\n  }\n]"}

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mInput validation[2m > [22m[2mreturns 400 when items array is empty
[22m[39m[2026-02-15T19:52:21.972Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{\n  \"idempotencyKey\": \"ck-1771185141971-wchdl74onz9\",\n  \"checkoutId\": \"ck-1771185141971-wchdl74onz9\",\n  \"items\": [],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"usedWallet\": false\n}"

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mInput validation[2m > [22m[2mreturns 400 when shippingInfo is missing
[22m[39m[2026-02-15T19:52:21.973Z] [INFO] [save-order] [save-order] Guest checkout (no authentication)
[2026-02-15T19:52:21.973Z] [INFO] [save-order] API save-order: Solicitud recibida

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mInput validation[2m > [22m[2mreturns 400 when shippingInfo is missing
[22m[39m[2026-02-15T19:52:21.973Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{\n  \"idempotencyKey\": \"ck-1771185141973-ekwblruowa\",\n  \"checkoutId\": \"ck-1771185141973-ekwblruowa\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"usedWallet\": false\n}"

[90mstderr[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mInput validation[2m > [22m[2mreturns 400 when shippingInfo is missing
[22m[39m[2026-02-15T19:52:21.973Z] [ERROR] [save-order] API save-order: ValidaciÃ³n Zod fallÃ³: {"error":"[\n  {\n    \"path\": \"shippingInfo\",\n    \"message\": \"Required\",\n    \"code\": \"invalid_type\"\n  }\n]"}

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mInput validation[2m > [22m[2mreturns 400 when idempotencyKey is missing
[22m[39m[2026-02-15T19:52:21.974Z] [INFO] [save-order] [save-order] Guest checkout (no authentication)
[2026-02-15T19:52:21.974Z] [INFO] [save-order] API save-order: Solicitud recibida

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mInput validation[2m > [22m[2mreturns 400 when idempotencyKey is missing
[22m[39m[2026-02-15T19:52:21.974Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{\n  \"checkoutId\": \"ck-1771185141974-66811a0pta\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"usedWallet\": false\n}"

[90mstderr[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mInput validation[2m > [22m[2mreturns 400 when idempotencyKey is missing
[22m[39m[2026-02-15T19:52:21.974Z] [ERROR] [save-order] API save-order: ValidaciÃ³n Zod fallÃ³: {"error":"[\n  {\n    \"path\": \"idempotencyKey\",\n    \"message\": \"Required\",\n    \"code\": \"invalid_type\"\n  }\n]"}

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mInput validation[2m > [22m[2mreturns 400 when checkoutId does not match idempotencyKey
[22m[39m[2026-02-15T19:52:21.974Z] [INFO] [save-order] [save-order] Guest checkout (no authentication)
[2026-02-15T19:52:21.974Z] [INFO] [save-order] API save-order: Solicitud recibida

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mInput validation[2m > [22m[2mreturns 400 when checkoutId does not match idempotencyKey
[22m[39m[2026-02-15T19:52:21.975Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{\n  \"idempotencyKey\": \"ck-mismatch-1771185141974\",\n  \"checkoutId\": \"ck-mismatch-1771185141974-DIFFERENT\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"usedWallet\": false\n}"

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mInput validation[2m > [22m[2mreturns 400 when item quantity is zero
[22m[39m[2026-02-15T19:52:21.975Z] [INFO] [save-order] [save-order] Guest checkout (no authentication)
[2026-02-15T19:52:21.975Z] [INFO] [save-order] API save-order: Solicitud recibida

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mInput validation[2m > [22m[2mreturns 400 when item quantity is zero
[22m[39m[2026-02-15T19:52:21.975Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{\n  \"idempotencyKey\": \"ck-1771185141975-tijceoo94b9\",\n  \"checkoutId\": \"ck-1771185141975-tijceoo94b9\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 0\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"usedWallet\": false\n}"

[90mstderr[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mInput validation[2m > [22m[2mreturns 400 when item quantity is zero
[22m[39m[2026-02-15T19:52:21.975Z] [ERROR] [save-order] API save-order: ValidaciÃ³n Zod fallÃ³: {"error":"[\n  {\n    \"path\": \"items.0.quantity\",\n    \"message\": \"Number must be greater than or equal to 1\",\n    \"code\": \"too_small\"\n  }\n]"}

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mInput validation[2m > [22m[2mreturns 400 when shippingInfo email is malformed
[22m[39m[2026-02-15T19:52:21.976Z] [INFO] [save-order] [save-order] Guest checkout (no authentication)
[2026-02-15T19:52:21.976Z] [INFO] [save-order] API save-order: Solicitud recibida

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mInput validation[2m > [22m[2mreturns 400 when shippingInfo email is malformed
[22m[39m[2026-02-15T19:52:21.976Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{\n  \"idempotencyKey\": \"ck-1771185141976-o9js4j6pjej\",\n  \"checkoutId\": \"ck-1771185141976-o9js4j6pjej\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"not-an-email\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"usedWallet\": false\n}"

[90mstderr[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mInput validation[2m > [22m[2mreturns 400 when shippingInfo email is malformed
[22m[39m[2026-02-15T19:52:21.976Z] [ERROR] [save-order] API save-order: ValidaciÃ³n Zod fallÃ³: {"error":"[\n  {\n    \"path\": \"shippingInfo.email\",\n    \"message\": \"Invalid email\",\n    \"code\": \"invalid_string\"\n  }\n]"}

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mPrice integrity â€” server-side calculation[2m > [22m[2mignores client-supplied total and recalculates from DB prices
[22m[39m[2026-02-15T19:52:21.977Z] [INFO] [save-order] [save-order] Guest checkout (no authentication)
[2026-02-15T19:52:21.977Z] [INFO] [save-order] API save-order: Solicitud recibida

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mPrice integrity â€” server-side calculation[2m > [22m[2mignores client-supplied total and recalculates from DB prices
[22m[39m[2026-02-15T19:52:21.977Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{\n  \"idempotencyKey\": \"ck-1771185141977-rmz4ins4zhg\",\n  \"checkoutId\": \"ck-1771185141977-rmz4ins4zhg\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"usedWallet\": false,\n  \"subtotal\": 0.01,\n  \"total\": 0.01,\n  \"tax\": 0\n}"
[2026-02-15T19:52:21.977Z] [INFO] [save-order] API save-order: Datos validados: "{\n  \"idempotencyKey\": \"ck-1771185141977-rmz4ins4zhg\",\n  \"checkoutId\": \"ck-1771185141977-rmz4ins4zhg\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"paymentMethod\": \"card\",\n  \"usedWallet\": false\n}"
[2026-02-15T19:52:21.977Z] [INFO] [save-order] API save-order: Intentando guardar en Firestore con Admin SDK...

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mPrice integrity â€” server-side calculation[2m > [22m[2mignores client-supplied total and recalculates from DB prices
[22m[39m[2026-02-15T19:52:21.978Z] [INFO] [save-order] [reserve_stock_success] {"orderId":"auto_orders_12","itemsCount":1}
[2026-02-15T19:52:21.978Z] [INFO] [save-order] API save-order: Pedido guardado con ID: "auto_orders_12"
[2026-02-15T19:52:21.978Z] [INFO] [save-order] [save-order] Order auto_orders_12 created with status 'pending'. Post-payment actions will run after payment confirmation via webhook.

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mPrice integrity â€” server-side calculation[2m > [22m[2mcalculates totals from DB price regardless of client item price field
[22m[39m[2026-02-15T19:52:21.978Z] [INFO] [save-order] [save-order] Guest checkout (no authentication)
[2026-02-15T19:52:21.978Z] [INFO] [save-order] API save-order: Solicitud recibida

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mPrice integrity â€” server-side calculation[2m > [22m[2mcalculates totals from DB price regardless of client item price field
[22m[39m[2026-02-15T19:52:21.979Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{\n  \"idempotencyKey\": \"ck-1771185141978-pa8znvxbj6\",\n  \"checkoutId\": \"ck-1771185141978-pa8znvxbj6\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1,\n      \"price\": 0.001,\n      \"unitPrice\": 0.001\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"usedWallet\": false\n}"
[2026-02-15T19:52:21.979Z] [INFO] [save-order] API save-order: Datos validados: "{\n  \"idempotencyKey\": \"ck-1771185141978-pa8znvxbj6\",\n  \"checkoutId\": \"ck-1771185141978-pa8znvxbj6\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"paymentMethod\": \"card\",\n  \"usedWallet\": false\n}"
[2026-02-15T19:52:21.979Z] [INFO] [save-order] API save-order: Intentando guardar en Firestore con Admin SDK...

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mPrice integrity â€” server-side calculation[2m > [22m[2mcalculates totals from DB price regardless of client item price field
[22m[39m[2026-02-15T19:52:21.979Z] [INFO] [save-order] [reserve_stock_success] {"orderId":"auto_orders_13","itemsCount":1}
[2026-02-15T19:52:21.979Z] [INFO] [save-order] API save-order: Pedido guardado con ID: "auto_orders_13"
[2026-02-15T19:52:21.979Z] [INFO] [save-order] [save-order] Order auto_orders_13 created with status 'pending'. Post-payment actions will run after payment confirmation via webhook.

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mStatus integrity â€” always pending on creation[2m > [22m[2msaves order with status "pending" even if client sends "paid"
[22m[39m[2026-02-15T19:52:21.980Z] [INFO] [save-order] [save-order] Guest checkout (no authentication)
[2026-02-15T19:52:21.980Z] [INFO] [save-order] API save-order: Solicitud recibida

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mStatus integrity â€” always pending on creation[2m > [22m[2msaves order with status "pending" even if client sends "paid"
[22m[39m[2026-02-15T19:52:21.980Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{\n  \"idempotencyKey\": \"ck-1771185141980-zs1xoxm1ck8\",\n  \"checkoutId\": \"ck-1771185141980-zs1xoxm1ck8\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"usedWallet\": false,\n  \"status\": \"paid\",\n  \"paymentStatus\": \"paid\"\n}"
[2026-02-15T19:52:21.980Z] [INFO] [save-order] API save-order: Datos validados: "{\n  \"idempotencyKey\": \"ck-1771185141980-zs1xoxm1ck8\",\n  \"checkoutId\": \"ck-1771185141980-zs1xoxm1ck8\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"paymentMethod\": \"card\",\n  \"usedWallet\": false\n}"
[2026-02-15T19:52:21.980Z] [INFO] [save-order] API save-order: Intentando guardar en Firestore con Admin SDK...

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mStatus integrity â€” always pending on creation[2m > [22m[2msaves order with status "pending" even if client sends "paid"
[22m[39m[2026-02-15T19:52:21.980Z] [INFO] [save-order] [reserve_stock_success] {"orderId":"auto_orders_14","itemsCount":1}
[2026-02-15T19:52:21.980Z] [INFO] [save-order] API save-order: Pedido guardado con ID: "auto_orders_14"
[2026-02-15T19:52:21.980Z] [INFO] [save-order] [save-order] Order auto_orders_14 created with status 'pending'. Post-payment actions will run after payment confirmation via webhook.

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mStatus integrity â€” always pending on creation[2m > [22m[2msaves order with status "pending" even if client sends "processing"
[22m[39m[2026-02-15T19:52:21.981Z] [INFO] [save-order] [save-order] Guest checkout (no authentication)
[2026-02-15T19:52:21.981Z] [INFO] [save-order] API save-order: Solicitud recibida

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mStatus integrity â€” always pending on creation[2m > [22m[2msaves order with status "pending" even if client sends "processing"
[22m[39m[2026-02-15T19:52:21.981Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{\n  \"idempotencyKey\": \"ck-1771185141981-ofue1k70kro\",\n  \"checkoutId\": \"ck-1771185141981-ofue1k70kro\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"usedWallet\": false,\n  \"status\": \"processing\",\n  \"paymentStatus\": \"processing\"\n}"
[2026-02-15T19:52:21.981Z] [INFO] [save-order] API save-order: Datos validados: "{\n  \"idempotencyKey\": \"ck-1771185141981-ofue1k70kro\",\n  \"checkoutId\": \"ck-1771185141981-ofue1k70kro\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"paymentMethod\": \"card\",\n  \"usedWallet\": false\n}"
[2026-02-15T19:52:21.981Z] [INFO] [save-order] API save-order: Intentando guardar en Firestore con Admin SDK...

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mStatus integrity â€” always pending on creation[2m > [22m[2msaves order with status "pending" even if client sends "processing"
[22m[39m[2026-02-15T19:52:21.982Z] [INFO] [save-order] [reserve_stock_success] {"orderId":"auto_orders_15","itemsCount":1}
[2026-02-15T19:52:21.982Z] [INFO] [save-order] API save-order: Pedido guardado con ID: "auto_orders_15"
[2026-02-15T19:52:21.982Z] [INFO] [save-order] [save-order] Order auto_orders_15 created with status 'pending'. Post-payment actions will run after payment confirmation via webhook.

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2muserId integrity â€” must come from auth token, not client body[2m > [22m[2msets userId from the authenticated token, ignoring any userId in the body
[22m[39m[2026-02-15T19:52:21.982Z] [INFO] [save-order] [save-order] Authenticated user: {"uid":"user-123"}
[2026-02-15T19:52:21.982Z] [INFO] [save-order] API save-order: Solicitud recibida

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2muserId integrity â€” must come from auth token, not client body[2m > [22m[2msets userId from the authenticated token, ignoring any userId in the body
[22m[39m[2026-02-15T19:52:21.982Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{\n  \"idempotencyKey\": \"ck-1771185141982-yk3acu4muj\",\n  \"checkoutId\": \"ck-1771185141982-yk3acu4muj\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"usedWallet\": false,\n  \"userId\": \"fake-uid-from-client-body\"\n}"
[2026-02-15T19:52:21.983Z] [INFO] [save-order] API save-order: Datos validados: "{\n  \"idempotencyKey\": \"ck-1771185141982-yk3acu4muj\",\n  \"checkoutId\": \"ck-1771185141982-yk3acu4muj\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"paymentMethod\": \"card\",\n  \"usedWallet\": false\n}"
[2026-02-15T19:52:21.983Z] [INFO] [save-order] API save-order: Intentando guardar en Firestore con Admin SDK...

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2muserId integrity â€” must come from auth token, not client body[2m > [22m[2msets userId from the authenticated token, ignoring any userId in the body
[22m[39m[2026-02-15T19:52:21.983Z] [INFO] [save-order] [reserve_stock_success] {"orderId":"auto_orders_16","itemsCount":1}
[2026-02-15T19:52:21.983Z] [INFO] [save-order] API save-order: Pedido guardado con ID: "auto_orders_16"
[2026-02-15T19:52:21.983Z] [INFO] [save-order] [save-order] Order auto_orders_16 created with status 'pending'. Post-payment actions will run after payment confirmation via webhook.

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2muserId integrity â€” must come from auth token, not client body[2m > [22m[2msets userId from admin token when admin creates an order
[22m[39m[2026-02-15T19:52:21.984Z] [INFO] [save-order] [save-order] Authenticated user: {"uid":"admin-456"}
[2026-02-15T19:52:21.984Z] [INFO] [save-order] API save-order: Solicitud recibida

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2muserId integrity â€” must come from auth token, not client body[2m > [22m[2msets userId from admin token when admin creates an order
[22m[39m[2026-02-15T19:52:21.984Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{\n  \"idempotencyKey\": \"ck-1771185141984-kk2g1ooyxo\",\n  \"checkoutId\": \"ck-1771185141984-kk2g1ooyxo\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"usedWallet\": false\n}"
[2026-02-15T19:52:21.984Z] [INFO] [save-order] API save-order: Datos validados: "{\n  \"idempotencyKey\": \"ck-1771185141984-kk2g1ooyxo\",\n  \"checkoutId\": \"ck-1771185141984-kk2g1ooyxo\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"paymentMethod\": \"card\",\n  \"usedWallet\": false\n}"
[2026-02-15T19:52:21.984Z] [INFO] [save-order] API save-order: Intentando guardar en Firestore con Admin SDK...

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2muserId integrity â€” must come from auth token, not client body[2m > [22m[2msets userId from admin token when admin creates an order
[22m[39m[2026-02-15T19:52:21.984Z] [INFO] [save-order] [reserve_stock_success] {"orderId":"auto_orders_17","itemsCount":1}
[2026-02-15T19:52:21.984Z] [INFO] [save-order] API save-order: Pedido guardado con ID: "auto_orders_17"
[2026-02-15T19:52:21.984Z] [INFO] [save-order] [save-order] Order auto_orders_17 created with status 'pending'. Post-payment actions will run after payment confirmation via webhook.

 [32mâœ“[39m security-tests/integration/payments/create-payment-intent.security.test.ts[2m > [22mSecurity: POST /api/create-payment-intent[2m > [22mCSRF-1: rejects requests from an invalid origin with 403[32m 30[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/payments/create-payment-intent.security.test.ts[2m > [22mSecurity: POST /api/create-payment-intent[2m > [22mRATE-1: returns 429 after exhausting VERY_STRICT limit (5 requests/min)[32m 8[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/payments/create-payment-intent.security.test.ts[2m > [22mSecurity: POST /api/create-payment-intent[2m > [22mAUTH-1: authenticated user successfully creates a payment intent for their order[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/payments/create-payment-intent.security.test.ts[2m > [22mSecurity: POST /api/create-payment-intent[2m > [22mVALIDATION-1: returns 400 when body is empty JSON object (missing orderId)[32m 3[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/payments/create-payment-intent.security.test.ts[2m > [22mSecurity: POST /api/create-payment-intent[2m > [22mVALIDATION-2: returns 400 when orderId is an empty string[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/payments/create-payment-intent.security.test.ts[2m > [22mSecurity: POST /api/create-payment-intent[2m > [22mVALIDATION-3: returns 400 when orderId exceeds max length (256 chars)[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/payments/create-payment-intent.security.test.ts[2m > [22mSecurity: POST /api/create-payment-intent[2m > [22mVALIDATION-4: returns 400 when orderAccessToken is present but too short (< 16 chars)[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/payments/create-payment-intent.security.test.ts[2m > [22mSecurity: POST /api/create-payment-intent[2m > [22mIDOR-1: user cannot create payment intent for another user's order (returns 404)[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/payments/create-payment-intent.security.test.ts[2m > [22mSecurity: POST /api/create-payment-intent[2m > [22mIDOR-2: unauthenticated user cannot access an authenticated user's order (401)[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/orders/save-order.security.test.ts[2m > [22mCSRF protection[2m > [22mrejects request with invalid origin (403)[32m 33[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/orders/save-order.security.test.ts[2m > [22mCSRF protection[2m > [22mrejects request with missing Origin header (403)[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/orders/save-order.security.test.ts[2m > [22mCSRF protection[2m > [22mallows request that passes CSRF validation (200)[32m 13[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/orders/save-order.security.test.ts[2m > [22mRate limiting (STRICT â€” 10 req/min)[2m > [22mallows the first 10 requests and blocks the 11th (429)[32m 24[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/orders/save-order.security.test.ts[2m > [22mRate limiting (STRICT â€” 10 req/min)[2m > [22mreturns Retry-After header on 429[32m 10[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/orders/save-order.security.test.ts[2m > [22mInput validation[2m > [22mreturns 400 for an empty body[32m 3[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/orders/save-order.security.test.ts[2m > [22mInput validation[2m > [22mreturns 400 when items array is missing[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/orders/save-order.security.test.ts[2m > [22mInput validation[2m > [22mreturns 400 when items array is empty[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/orders/save-order.security.test.ts[2m > [22mInput validation[2m > [22mreturns 400 when shippingInfo is missing[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/orders/save-order.security.test.ts[2m > [22mInput validation[2m > [22mreturns 400 when idempotencyKey is missing[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/orders/save-order.security.test.ts[2m > [22mInput validation[2m > [22mreturns 400 when checkoutId does not match idempotencyKey[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/orders/save-order.security.test.ts[2m > [22mInput validation[2m > [22mreturns 400 when item quantity is zero[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/orders/save-order.security.test.ts[2m > [22mInput validation[2m > [22mreturns 400 when shippingInfo email is malformed[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/orders/save-order.security.test.ts[2m > [22mPrice integrity â€” server-side calculation[2m > [22mignores client-supplied total and recalculates from DB prices[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/orders/save-order.security.test.ts[2m > [22mPrice integrity â€” server-side calculation[2m > [22mcalculates totals from DB price regardless of client item price field[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/orders/save-order.security.test.ts[2m > [22mStatus integrity â€” always pending on creation[2m > [22msaves order with status "pending" even if client sends "paid"[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/orders/save-order.security.test.ts[2m > [22mStatus integrity â€” always pending on creation[2m > [22msaves order with status "pending" even if client sends "processing"[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/orders/save-order.security.test.ts[2m > [22muserId integrity â€” must come from auth token, not client body[2m > [22msets userId from the authenticated token, ignoring any userId in the body[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/orders/save-order.security.test.ts[2m > [22muserId integrity â€” must come from auth token, not client body[2m > [22msets userId from admin token when admin creates an order[32m 1[2mms[22m[39m
[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mGuest orders â€” no authentication required[2m > [22m[2mallows guest checkout and sets userId to null
[22m[39m[2026-02-15T19:52:21.986Z] [INFO] [save-order] [save-order] Guest checkout (no authentication)
[2026-02-15T19:52:21.986Z] [INFO] [save-order] API save-order: Solicitud recibida

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mGuest orders â€” no authentication required[2m > [22m[2mallows guest checkout and sets userId to null
[22m[39m[2026-02-15T19:52:21.986Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{\n  \"idempotencyKey\": \"ck-1771185141985-c8zqp0ln0j8\",\n  \"checkoutId\": \"ck-1771185141985-c8zqp0ln0j8\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"usedWallet\": false\n}"
[2026-02-15T19:52:21.986Z] [INFO] [save-order] API save-order: Datos validados: "{\n  \"idempotencyKey\": \"ck-1771185141985-c8zqp0ln0j8\",\n  \"checkoutId\": \"ck-1771185141985-c8zqp0ln0j8\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"paymentMethod\": \"card\",\n  \"usedWallet\": false\n}"
[2026-02-15T19:52:21.986Z] [INFO] [save-order] API save-order: Intentando guardar en Firestore con Admin SDK...

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mGuest orders â€” no authentication required[2m > [22m[2mallows guest checkout and sets userId to null
[22m[39m[2026-02-15T19:52:21.986Z] [INFO] [save-order] [reserve_stock_success] {"orderId":"auto_orders_18","itemsCount":1}
[2026-02-15T19:52:21.986Z] [INFO] [save-order] API save-order: Pedido guardado con ID: "auto_orders_18"
[2026-02-15T19:52:21.986Z] [INFO] [save-order] [save-order] Order auto_orders_18 created with status 'pending'. Post-payment actions will run after payment confirmation via webhook.

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mGuest orders â€” no authentication required[2m > [22m[2mreturns orderAccessToken for guest orders (allows tracking without account)
[22m[39m[2026-02-15T19:52:21.987Z] [INFO] [save-order] [save-order] Guest checkout (no authentication)
[2026-02-15T19:52:21.987Z] [INFO] [save-order] API save-order: Solicitud recibida

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mGuest orders â€” no authentication required[2m > [22m[2mreturns orderAccessToken for guest orders (allows tracking without account)
[22m[39m[2026-02-15T19:52:21.987Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{\n  \"idempotencyKey\": \"ck-1771185141987-wnorkits7r\",\n  \"checkoutId\": \"ck-1771185141987-wnorkits7r\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"usedWallet\": false\n}"
[2026-02-15T19:52:21.987Z] [INFO] [save-order] API save-order: Datos validados: "{\n  \"idempotencyKey\": \"ck-1771185141987-wnorkits7r\",\n  \"checkoutId\": \"ck-1771185141987-wnorkits7r\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"paymentMethod\": \"card\",\n  \"usedWallet\": false\n}"
[2026-02-15T19:52:21.987Z] [INFO] [save-order] API save-order: Intentando guardar en Firestore con Admin SDK...

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mGuest orders â€” no authentication required[2m > [22m[2mreturns orderAccessToken for guest orders (allows tracking without account)
[22m[39m[2026-02-15T19:52:21.988Z] [INFO] [save-order] [reserve_stock_success] {"orderId":"auto_orders_19","itemsCount":1}
[2026-02-15T19:52:21.988Z] [INFO] [save-order] API save-order: Pedido guardado con ID: "auto_orders_19"
[2026-02-15T19:52:21.988Z] [INFO] [save-order] [save-order] Order auto_orders_19 created with status 'pending'. Post-payment actions will run after payment confirmation via webhook.

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mGuest orders â€” no authentication required[2m > [22m[2mdoes NOT return orderAccessToken for authenticated orders
[22m[39m[2026-02-15T19:52:21.988Z] [INFO] [save-order] [save-order] Authenticated user: {"uid":"user-123"}
[2026-02-15T19:52:21.988Z] [INFO] [save-order] API save-order: Solicitud recibida

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mGuest orders â€” no authentication required[2m > [22m[2mdoes NOT return orderAccessToken for authenticated orders
[22m[39m[2026-02-15T19:52:21.989Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{\n  \"idempotencyKey\": \"ck-1771185141988-h5tv4r12ksv\",\n  \"checkoutId\": \"ck-1771185141988-h5tv4r12ksv\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"usedWallet\": false\n}"
[2026-02-15T19:52:21.989Z] [INFO] [save-order] API save-order: Datos validados: "{\n  \"idempotencyKey\": \"ck-1771185141988-h5tv4r12ksv\",\n  \"checkoutId\": \"ck-1771185141988-h5tv4r12ksv\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"paymentMethod\": \"card\",\n  \"usedWallet\": false\n}"
[2026-02-15T19:52:21.989Z] [INFO] [save-order] API save-order: Intentando guardar en Firestore con Admin SDK...

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mGuest orders â€” no authentication required[2m > [22m[2mdoes NOT return orderAccessToken for authenticated orders
[22m[39m[2026-02-15T19:52:21.989Z] [INFO] [save-order] [reserve_stock_success] {"orderId":"auto_orders_20","itemsCount":1}
[2026-02-15T19:52:21.989Z] [INFO] [save-order] API save-order: Pedido guardado con ID: "auto_orders_20"
[2026-02-15T19:52:21.989Z] [INFO] [save-order] [save-order] Order auto_orders_20 created with status 'pending'. Post-payment actions will run after payment confirmation via webhook.

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mGuest orders â€” no authentication required[2m > [22m[2mignores usedWallet for guests (wallet requires authentication)
[22m[39m[2026-02-15T19:52:21.989Z] [INFO] [save-order] [save-order] Guest checkout (no authentication)
[2026-02-15T19:52:21.989Z] [INFO] [save-order] API save-order: Solicitud recibida

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mGuest orders â€” no authentication required[2m > [22m[2mignores usedWallet for guests (wallet requires authentication)
[22m[39m[2026-02-15T19:52:21.990Z] [INFO] [save-order] API save-order: Datos recibidos (DEV only): "{\n  \"idempotencyKey\": \"ck-1771185141989-fxyln8dj05w\",\n  \"checkoutId\": \"ck-1771185141989-fxyln8dj05w\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"usedWallet\": true\n}"
[2026-02-15T19:52:21.990Z] [INFO] [save-order] API save-order: Datos validados: "{\n  \"idempotencyKey\": \"ck-1771185141989-fxyln8dj05w\",\n  \"checkoutId\": \"ck-1771185141989-fxyln8dj05w\",\n  \"items\": [\n    {\n      \"productId\": \"product-1\",\n      \"name\": \"Test Product\",\n      \"quantity\": 1\n    }\n  ],\n  \"shippingInfo\": {\n    \"fullName\": \"Ana GarcÃ­a\",\n    \"email\": \"ana@example.com\",\n    \"phone\": \"612345678\",\n    \"address\": \"Calle Seguridad 1\",\n    \"city\": \"Madrid\",\n    \"state\": \"Madrid\",\n    \"zipCode\": \"28001\",\n    \"country\": \"EspaÃ±a\",\n    \"shippingMethodId\": \"method-1\"\n  },\n  \"paymentMethod\": \"card\",\n  \"usedWallet\": true\n}"
[2026-02-15T19:52:21.990Z] [INFO] [save-order] API save-order: Intentando guardar en Firestore con Admin SDK...

[90mstdout[2m | security-tests/integration/orders/save-order.security.test.ts[2m > [22m[2mGuest orders â€” no authentication required[2m > [22m[2mignores usedWallet for guests (wallet requires authentication)
[22m[39m[2026-02-15T19:52:21.990Z] [INFO] [save-order] [reserve_stock_success] {"orderId":"auto_orders_21","itemsCount":1}
[2026-02-15T19:52:21.990Z] [INFO] [save-order] API save-order: Pedido guardado con ID: "auto_orders_21"
[2026-02-15T19:52:21.990Z] [INFO] [save-order] [save-order] Order auto_orders_21 created with status 'pending'. Post-payment actions will run after payment confirmation via webhook.

 [32mâœ“[39m security-tests/integration/orders/save-order.security.test.ts[2m > [22mGuest orders â€” no authentication required[2m > [22mallows guest checkout and sets userId to null[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/orders/save-order.security.test.ts[2m > [22mGuest orders â€” no authentication required[2m > [22mreturns orderAccessToken for guest orders (allows tracking without account)[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/orders/save-order.security.test.ts[2m > [22mGuest orders â€” no authentication required[2m > [22mdoes NOT return orderAccessToken for authenticated orders[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/orders/save-order.security.test.ts[2m > [22mGuest orders â€” no authentication required[2m > [22mignores usedWallet for guests (wallet requires authentication)[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/payments/create-payment-intent.security.test.ts[2m > [22mSecurity: POST /api/create-payment-intent[2m > [22mAMOUNT-1: payment amount is taken from Firestore order totalCents, not from client input[33m 368[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/payments/create-payment-intent.security.test.ts[2m > [22mSecurity: POST /api/create-payment-intent[2m > [22mAMOUNT-2: client-supplied amount fields in body are completely ignored[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/payments/create-payment-intent.security.test.ts[2m > [22mSecurity: POST /api/create-payment-intent[2m > [22mSTATUS-1: returns 400 when order paymentStatus is already "paid"[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/payments/create-payment-intent.security.test.ts[2m > [22mSecurity: POST /api/create-payment-intent[2m > [22mSTATUS-2: returns 409 when order status is not "pending" (e.g. "processing")[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/payments/create-payment-intent.security.test.ts[2m > [22mSecurity: POST /api/create-payment-intent[2m > [22mSTATUS-3: returns 409 when order paymentStatus is not "pending" (e.g. "processing")[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/payments/create-payment-intent.security.test.ts[2m > [22mSecurity: POST /api/create-payment-intent[2m > [22mSTATUS-4: returns 404 when orderId does not exist in Firestore[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/payments/create-payment-intent.security.test.ts[2m > [22mSecurity: POST /api/create-payment-intent[2m > [22mGUEST-1: guest user with correct orderAccessToken can create a payment intent[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/payments/create-payment-intent.security.test.ts[2m > [22mSecurity: POST /api/create-payment-intent[2m > [22mGUEST-2: guest user with incorrect orderAccessToken is rejected with 404[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/payments/create-payment-intent.security.test.ts[2m > [22mSecurity: POST /api/create-payment-intent[2m > [22mGUEST-3: guest order with no orderAccessToken provided is rejected with 404[32m 1[2mms[22m[39m
[90mstderr[2m | security-tests/integration/admin/admin-access.security.test.ts[2m > [22m[2mPOST /api/admin/set-admin-claim[2m > [22m[2mreturns 401 when no Authorization header is provided
[22m[39m[rateLimitPersistent] Firestore error, falling back to in-memory rate limiting: TypeError: db.runTransaction is not a function
    at rateLimitPersistent (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rateLimitPersistent.ts:111:29)
    at checkRateLimit (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rate-limiter.ts:166:26)
    at POST (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/admin/set-admin-claim.ts:20:33)
    at callEndpoint (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:390:12)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:401:17
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:20
[rateLimitPersistent] Using in-memory fallback for key: set-admin-claim:unknown { ok: [33mtrue[39m, remaining: [33m4[39m }

[90mstderr[2m | security-tests/integration/admin/admin-access.security.test.ts[2m > [22m[2mPOST /api/admin/set-admin-claim[2m > [22m[2mreturns 401 when Authorization header does not start with Bearer
[22m[39m[rateLimitPersistent] Firestore error, falling back to in-memory rate limiting: TypeError: db.runTransaction is not a function
    at rateLimitPersistent (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rateLimitPersistent.ts:111:29)
    at checkRateLimit (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rate-limiter.ts:166:26)
    at POST (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/admin/set-admin-claim.ts:20:33)
    at callEndpoint (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:390:12)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:414:17
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:20
[rateLimitPersistent] Using in-memory fallback for key: set-admin-claim:unknown { ok: [33mtrue[39m, remaining: [33m3[39m }

[90mstderr[2m | security-tests/integration/admin/admin-access.security.test.ts[2m > [22m[2mPOST /api/admin/set-admin-claim[2m > [22m[2mreturns 401 when token is invalid (not in TOKEN_MAP)
[22m[39m[rateLimitPersistent] Firestore error, falling back to in-memory rate limiting: TypeError: db.runTransaction is not a function
    at rateLimitPersistent (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rateLimitPersistent.ts:111:29)
    at checkRateLimit (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rate-limiter.ts:166:26)
    at POST (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/admin/set-admin-claim.ts:20:33)
    at callEndpoint (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:390:12)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:420:17
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:20
[rateLimitPersistent] Using in-memory fallback for key: set-admin-claim:unknown { ok: [33mtrue[39m, remaining: [33m2[39m }

[90mstderr[2m | security-tests/integration/admin/admin-access.security.test.ts[2m > [22m[2mPOST /api/admin/set-admin-claim[2m > [22m[2mreturns 401 when token is invalid (not in TOKEN_MAP)
[22m[39m[set-admin-claim] Error: Error: Firebase ID token has been revoked or is invalid
    at Object.<anonymous> (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:72:22)
    at Object.Mock [as verifyIdToken] [90m(file:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/spy/dist/index.js:274:34[90m)[39m
    at POST (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/admin/set-admin-claim.ts:41:42)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:420:17
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:20

[90mstderr[2m | security-tests/integration/admin/admin-access.security.test.ts[2m > [22m[2mPOST /api/admin/set-admin-claim[2m > [22m[2mreturns 401 when token is malformed
[22m[39m[rateLimitPersistent] Firestore error, falling back to in-memory rate limiting: TypeError: db.runTransaction is not a function
    at rateLimitPersistent (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rateLimitPersistent.ts:111:29)
    at checkRateLimit (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rate-limiter.ts:166:26)
    at POST (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/admin/set-admin-claim.ts:20:33)
    at callEndpoint (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:390:12)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:429:17
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:20
[rateLimitPersistent] Using in-memory fallback for key: set-admin-claim:unknown { ok: [33mtrue[39m, remaining: [33m1[39m }

[90mstderr[2m | security-tests/integration/admin/admin-access.security.test.ts[2m > [22m[2mPOST /api/admin/set-admin-claim[2m > [22m[2mreturns 401 when token is malformed
[22m[39m[set-admin-claim] Error: Error: Firebase ID token has been revoked or is invalid
    at Object.<anonymous> (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:72:22)
    at Object.Mock [as verifyIdToken] [90m(file:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/spy/dist/index.js:274:34[90m)[39m
    at POST (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/admin/set-admin-claim.ts:41:42)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:429:17
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:20

[90mstderr[2m | security-tests/integration/admin/admin-access.security.test.ts[2m > [22m[2mPOST /api/admin/set-admin-claim[2m > [22m[2mreturns 403 when authenticated user email is not in ADMIN_EMAILS
[22m[39m[rateLimitPersistent] Firestore error, falling back to in-memory rate limiting: TypeError: db.runTransaction is not a function
    at rateLimitPersistent (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rateLimitPersistent.ts:111:29)
    at checkRateLimit (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rate-limiter.ts:166:26)
    at POST (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/admin/set-admin-claim.ts:20:33)
    at callEndpoint (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:390:12)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:440:17
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:20
[rateLimitPersistent] Using in-memory fallback for key: set-admin-claim:unknown { ok: [33mtrue[39m, remaining: [33m0[39m }

[90mstderr[2m | security-tests/integration/admin/admin-access.security.test.ts[2m > [22m[2mPOST /api/admin/set-admin-claim[2m > [22m[2m403 error body does not expose the ADMIN_EMAILS list contents
[22m[39m[rateLimitPersistent] Firestore error, falling back to in-memory rate limiting: TypeError: db.runTransaction is not a function
    at rateLimitPersistent (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rateLimitPersistent.ts:111:29)
    at checkRateLimit (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rate-limiter.ts:166:26)
    at POST (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/admin/set-admin-claim.ts:20:33)
    at callEndpoint (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:390:12)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:448:17
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:20
[rateLimitPersistent] Using in-memory fallback for key: set-admin-claim:unknown { ok: [33mfalse[39m, remaining: [33m0[39m }

[90mstderr[2m | security-tests/integration/admin/admin-access.security.test.ts[2m > [22m[2mPOST /api/admin/set-admin-claim[2m > [22m[2mreturns 200 when admin user requests their own admin claim
[22m[39m[rateLimitPersistent] Firestore error, falling back to in-memory rate limiting: TypeError: db.runTransaction is not a function
    at rateLimitPersistent (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rateLimitPersistent.ts:111:29)
    at checkRateLimit (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rate-limiter.ts:166:26)
    at POST (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/admin/set-admin-claim.ts:20:33)
    at callEndpoint (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:390:12)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:461:17
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:20
[rateLimitPersistent] Using in-memory fallback for key: set-admin-claim:unknown { ok: [33mfalse[39m, remaining: [33m0[39m }

[90mstderr[2m | security-tests/integration/admin/admin-access.security.test.ts[2m > [22m[2mPOST /api/admin/set-admin-claim[2m > [22m[2mcalls setCustomUserClaims with { admin: true } for eligible users
[22m[39m[rateLimitPersistent] Firestore error, falling back to in-memory rate limiting: TypeError: db.runTransaction is not a function
    at rateLimitPersistent (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rateLimitPersistent.ts:111:29)
    at checkRateLimit (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rate-limiter.ts:166:26)
    at POST (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/admin/set-admin-claim.ts:20:33)
    at callEndpoint (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:390:12)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:481:5
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:20
[rateLimitPersistent] Using in-memory fallback for key: set-admin-claim:unknown { ok: [33mfalse[39m, remaining: [33m0[39m }

[90mstderr[2m | security-tests/integration/admin/admin-access.security.test.ts[2m > [22m[2mPOST /api/admin/set-admin-claim[2m > [22m[2mreturns 200 with informative message when user already has admin claim
[22m[39m[rateLimitPersistent] Firestore error, falling back to in-memory rate limiting: TypeError: db.runTransaction is not a function
    at rateLimitPersistent (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rateLimitPersistent.ts:111:29)
    at checkRateLimit (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rate-limiter.ts:166:26)
    at POST (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/admin/set-admin-claim.ts:20:33)
    at callEndpoint (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:390:12)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:492:17
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:20
[rateLimitPersistent] Using in-memory fallback for key: set-admin-claim:unknown { ok: [33mfalse[39m, remaining: [33m0[39m }

[90mstderr[2m | security-tests/integration/admin/admin-access.security.test.ts[2m > [22m[2mPOST /api/admin/set-admin-claim[2m > [22m[2mreturns 429 after VERY_STRICT limit (5 requests) is exceeded
[22m[39m[rateLimitPersistent] Firestore error, falling back to in-memory rate limiting: TypeError: db.runTransaction is not a function
    at rateLimitPersistent (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rateLimitPersistent.ts:111:29)
    at checkRateLimit (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rate-limiter.ts:166:26)
    at POST (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/admin/set-admin-claim.ts:20:33)
    at callEndpoint (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:390:12)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:517:22
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:20
[rateLimitPersistent] Using in-memory fallback for key: set-admin-claim:10.0.0.1 { ok: [33mtrue[39m, remaining: [33m4[39m }

[90mstderr[2m | security-tests/integration/admin/admin-access.security.test.ts[2m > [22m[2mPOST /api/admin/set-admin-claim[2m > [22m[2mreturns 429 after VERY_STRICT limit (5 requests) is exceeded
[22m[39m[rateLimitPersistent] Firestore error, falling back to in-memory rate limiting: TypeError: db.runTransaction is not a function
    at rateLimitPersistent (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rateLimitPersistent.ts:111:29)
    at checkRateLimit (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rate-limiter.ts:166:26)
    at POST (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/admin/set-admin-claim.ts:20:33)
    at callEndpoint (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:390:12)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:517:22
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:20
[rateLimitPersistent] Using in-memory fallback for key: set-admin-claim:10.0.0.1 { ok: [33mtrue[39m, remaining: [33m3[39m }

[90mstderr[2m | security-tests/integration/admin/admin-access.security.test.ts[2m > [22m[2mPOST /api/admin/set-admin-claim[2m > [22m[2mreturns 429 after VERY_STRICT limit (5 requests) is exceeded
[22m[39m[rateLimitPersistent] Firestore error, falling back to in-memory rate limiting: TypeError: db.runTransaction is not a function
    at rateLimitPersistent (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rateLimitPersistent.ts:111:29)
    at checkRateLimit (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rate-limiter.ts:166:26)
    at POST (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/admin/set-admin-claim.ts:20:33)
    at callEndpoint (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:390:12)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:517:22
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:20
[rateLimitPersistent] Using in-memory fallback for key: set-admin-claim:10.0.0.1 { ok: [33mtrue[39m, remaining: [33m2[39m }

[90mstderr[2m | security-tests/integration/admin/admin-access.security.test.ts[2m > [22m[2mPOST /api/admin/set-admin-claim[2m > [22m[2mreturns 429 after VERY_STRICT limit (5 requests) is exceeded
[22m[39m[rateLimitPersistent] Firestore error, falling back to in-memory rate limiting: TypeError: db.runTransaction is not a function
    at rateLimitPersistent (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rateLimitPersistent.ts:111:29)
    at checkRateLimit (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rate-limiter.ts:166:26)
    at POST (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/admin/set-admin-claim.ts:20:33)
    at callEndpoint (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:390:12)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:517:22
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:20
[rateLimitPersistent] Using in-memory fallback for key: set-admin-claim:10.0.0.1 { ok: [33mtrue[39m, remaining: [33m1[39m }

[90mstderr[2m | security-tests/integration/admin/admin-access.security.test.ts[2m > [22m[2mPOST /api/admin/set-admin-claim[2m > [22m[2mreturns 429 after VERY_STRICT limit (5 requests) is exceeded
[22m[39m[rateLimitPersistent] Firestore error, falling back to in-memory rate limiting: TypeError: db.runTransaction is not a function
    at rateLimitPersistent (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rateLimitPersistent.ts:111:29)
    at checkRateLimit (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rate-limiter.ts:166:26)
    at POST (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/admin/set-admin-claim.ts:20:33)
    at callEndpoint (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:390:12)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:517:22
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:20
[rateLimitPersistent] Using in-memory fallback for key: set-admin-claim:10.0.0.1 { ok: [33mtrue[39m, remaining: [33m0[39m }

[90mstderr[2m | security-tests/integration/admin/admin-access.security.test.ts[2m > [22m[2mPOST /api/admin/set-admin-claim[2m > [22m[2mreturns 429 after VERY_STRICT limit (5 requests) is exceeded
[22m[39m[rateLimitPersistent] Firestore error, falling back to in-memory rate limiting: TypeError: db.runTransaction is not a function
    at rateLimitPersistent (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rateLimitPersistent.ts:111:29)
    at checkRateLimit (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rate-limiter.ts:166:26)
    at POST (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/admin/set-admin-claim.ts:20:33)
    at callEndpoint (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:390:12)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:517:22
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:20
[rateLimitPersistent] Using in-memory fallback for key: set-admin-claim:10.0.0.1 { ok: [33mfalse[39m, remaining: [33m0[39m }

[90mstderr[2m | security-tests/integration/admin/admin-access.security.test.ts[2m > [22m[2mPOST /api/admin/set-admin-claim[2m > [22m[2mreturns 429 after VERY_STRICT limit (5 requests) is exceeded
[22m[39m[rateLimitPersistent] Firestore error, falling back to in-memory rate limiting: TypeError: db.runTransaction is not a function
    at rateLimitPersistent (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rateLimitPersistent.ts:111:29)
    at checkRateLimit (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rate-limiter.ts:166:26)
    at POST (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/admin/set-admin-claim.ts:20:33)
    at callEndpoint (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:390:12)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:517:22
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:20
[rateLimitPersistent] Using in-memory fallback for key: set-admin-claim:10.0.0.1 { ok: [33mfalse[39m, remaining: [33m0[39m }

[90mstderr[2m | security-tests/integration/admin/admin-access.security.test.ts[2m > [22m[2mPOST /api/admin/set-admin-claim[2m > [22m[2m429 response includes Retry-After header
[22m[39m[rateLimitPersistent] Firestore error, falling back to in-memory rate limiting: TypeError: db.runTransaction is not a function
    at rateLimitPersistent (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rateLimitPersistent.ts:111:29)
    at checkRateLimit (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rate-limiter.ts:166:26)
    at POST (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/admin/set-admin-claim.ts:20:33)
    at callEndpoint (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:390:12)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:537:7
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:20
[rateLimitPersistent] Using in-memory fallback for key: set-admin-claim:10.0.0.2 { ok: [33mtrue[39m, remaining: [33m4[39m }

[90mstderr[2m | security-tests/integration/admin/admin-access.security.test.ts[2m > [22m[2mPOST /api/admin/set-admin-claim[2m > [22m[2m429 response includes Retry-After header
[22m[39m[rateLimitPersistent] Firestore error, falling back to in-memory rate limiting: TypeError: db.runTransaction is not a function
    at rateLimitPersistent (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rateLimitPersistent.ts:111:29)
    at checkRateLimit (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rate-limiter.ts:166:26)
    at POST (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/admin/set-admin-claim.ts:20:33)
    at callEndpoint (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:390:12)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:537:7
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:20
[rateLimitPersistent] Using in-memory fallback for key: set-admin-claim:10.0.0.2 { ok: [33mtrue[39m, remaining: [33m3[39m }

[90mstderr[2m | security-tests/integration/admin/admin-access.security.test.ts[2m > [22m[2mPOST /api/admin/set-admin-claim[2m > [22m[2m429 response includes Retry-After header
[22m[39m[rateLimitPersistent] Firestore error, falling back to in-memory rate limiting: TypeError: db.runTransaction is not a function
    at rateLimitPersistent (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rateLimitPersistent.ts:111:29)
    at checkRateLimit (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rate-limiter.ts:166:26)
    at POST (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/admin/set-admin-claim.ts:20:33)
    at callEndpoint (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:390:12)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:537:7
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:20
[rateLimitPersistent] Using in-memory fallback for key: set-admin-claim:10.0.0.2 { ok: [33mtrue[39m, remaining: [33m2[39m }

[90mstderr[2m | security-tests/integration/admin/admin-access.security.test.ts[2m > [22m[2mPOST /api/admin/set-admin-claim[2m > [22m[2m429 response includes Retry-After header
[22m[39m[rateLimitPersistent] Firestore error, falling back to in-memory rate limiting: TypeError: db.runTransaction is not a function
    at rateLimitPersistent (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rateLimitPersistent.ts:111:29)
    at checkRateLimit (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rate-limiter.ts:166:26)
    at POST (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/admin/set-admin-claim.ts:20:33)
    at callEndpoint (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:390:12)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:537:7
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:20
[rateLimitPersistent] Using in-memory fallback for key: set-admin-claim:10.0.0.2 { ok: [33mtrue[39m, remaining: [33m1[39m }

[90mstderr[2m | security-tests/integration/admin/admin-access.security.test.ts[2m > [22m[2mPOST /api/admin/set-admin-claim[2m > [22m[2m429 response includes Retry-After header
[22m[39m[rateLimitPersistent] Firestore error, falling back to in-memory rate limiting: TypeError: db.runTransaction is not a function
    at rateLimitPersistent (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rateLimitPersistent.ts:111:29)
    at checkRateLimit (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rate-limiter.ts:166:26)
    at POST (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/admin/set-admin-claim.ts:20:33)
    at callEndpoint (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:390:12)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:537:7
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:20
[rateLimitPersistent] Using in-memory fallback for key: set-admin-claim:10.0.0.2 { ok: [33mtrue[39m, remaining: [33m0[39m }

[90mstderr[2m | security-tests/integration/admin/admin-access.security.test.ts[2m > [22m[2mPOST /api/admin/set-admin-claim[2m > [22m[2m429 response includes Retry-After header
[22m[39m[rateLimitPersistent] Firestore error, falling back to in-memory rate limiting: TypeError: db.runTransaction is not a function
    at rateLimitPersistent (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rateLimitPersistent.ts:111:29)
    at checkRateLimit (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rate-limiter.ts:166:26)
    at POST (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/admin/set-admin-claim.ts:20:33)
    at callEndpoint (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:390:12)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:537:7
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:20
[rateLimitPersistent] Using in-memory fallback for key: set-admin-claim:10.0.0.2 { ok: [33mfalse[39m, remaining: [33m0[39m }

[90mstderr[2m | security-tests/unit/sanitize.test.ts[2m > [22m[2mSanitization[2m > [22m[2msanitizeUrl[2m > [22m[2mblocks javascript: protocol
[22m[39m[sanitizeUrl] Blocked dangerous URL: javascript:alert(1)

[90mstderr[2m | security-tests/unit/sanitize.test.ts[2m > [22m[2mSanitization[2m > [22m[2msanitizeUrl[2m > [22m[2mblocks javascript: with mixed case
[22m[39m[sanitizeUrl] Blocked dangerous URL: JavaScript:alert(1)

[90mstderr[2m | security-tests/unit/sanitize.test.ts[2m > [22m[2mSanitization[2m > [22m[2msanitizeUrl[2m > [22m[2mblocks javascript: with spaces
[22m[39m[sanitizeUrl] Blocked dangerous URL:   javascript:alert(1)  

[90mstderr[2m | security-tests/unit/sanitize.test.ts[2m > [22m[2mSanitization[2m > [22m[2msanitizeUrl[2m > [22m[2mblocks data: protocol
[22m[39m[sanitizeUrl] Blocked dangerous URL: data:text/html,<script>alert(1)</script>

[90mstderr[2m | security-tests/unit/sanitize.test.ts[2m > [22m[2mSanitization[2m > [22m[2msanitizeUrl[2m > [22m[2mblocks vbscript: protocol
[22m[39m[sanitizeUrl] Blocked dangerous URL: vbscript:MsgBox("XSS")

[90mstderr[2m | security-tests/integration/admin/admin-access.security.test.ts[2m > [22m[2mPOST /api/admin/set-admin-claim[2m > [22m[2m429 response includes Retry-After header
[22m[39m[rateLimitPersistent] Firestore error, falling back to in-memory rate limiting: TypeError: db.runTransaction is not a function
    at rateLimitPersistent (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rateLimitPersistent.ts:111:29)
    at checkRateLimit (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rate-limiter.ts:166:26)
    at POST (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/admin/set-admin-claim.ts:20:33)
    at callEndpoint (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:390:12)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:549:17
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:20
[rateLimitPersistent] Using in-memory fallback for key: set-admin-claim:10.0.0.2 { ok: [33mfalse[39m, remaining: [33m0[39m }

[90mstderr[2m | security-tests/unit/sanitize.test.ts[2m > [22m[2mSanitization[2m > [22m[2msanitizeUrl[2m > [22m[2mrejects unknown protocols
[22m[39m[sanitizeUrl] Invalid URL protocol: ftp://files.example.com

[90mstderr[2m | security-tests/unit/sanitize.test.ts[2m > [22m[2mSanitization[2m > [22m[2msanitizeUrl[2m > [22m[2mrejects telnet protocol
[22m[39m[sanitizeUrl] Invalid URL protocol: telnet://server.com

[90mstderr[2m | security-tests/unit/sanitize.test.ts[2m > [22m[2mSanitization[2m > [22m[2msanitizeUrl[2m > [22m[2mhandles empty input
[22m[39m[sanitizeUrl] Invalid URL protocol: 

[90mstderr[2m | security-tests/integration/admin/admin-access.security.test.ts[2m > [22m[2mPOST /api/admin/set-admin-claim[2m > [22m[2mrate limiter is isolated per identifier - different IPs are tracked separately
[22m[39m[rateLimitPersistent] Firestore error, falling back to in-memory rate limiting: TypeError: db.runTransaction is not a function
    at rateLimitPersistent (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rateLimitPersistent.ts:111:29)
    at checkRateLimit (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rate-limiter.ts:166:26)
    at POST (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/admin/set-admin-claim.ts:20:33)
    at callEndpoint (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:390:12)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:569:7
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:20
[rateLimitPersistent] Using in-memory fallback for key: set-admin-claim:192.168.1.10 { ok: [33mtrue[39m, remaining: [33m4[39m }

[90mstderr[2m | security-tests/integration/admin/admin-access.security.test.ts[2m > [22m[2mPOST /api/admin/set-admin-claim[2m > [22m[2mrate limiter is isolated per identifier - different IPs are tracked separately
[22m[39m[rateLimitPersistent] Firestore error, falling back to in-memory rate limiting: TypeError: db.runTransaction is not a function
    at rateLimitPersistent (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rateLimitPersistent.ts:111:29)
    at checkRateLimit (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rate-limiter.ts:166:26)
    at POST (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/admin/set-admin-claim.ts:20:33)
    at callEndpoint (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:390:12)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:569:7
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:20
[rateLimitPersistent] Using in-memory fallback for key: set-admin-claim:192.168.1.10 { ok: [33mtrue[39m, remaining: [33m3[39m }

 [32mâœ“[39m security-tests/unit/sanitize.test.ts[2m > [22mSanitization[2m > [22mescapeHtml[2m > [22mescapes < and > characters[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/sanitize.test.ts[2m > [22mSanitization[2m > [22mescapeHtml[2m > [22mescapes & character[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/sanitize.test.ts[2m > [22mSanitization[2m > [22mescapeHtml[2m > [22mescapes double quotes[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/sanitize.test.ts[2m > [22mSanitization[2m > [22mescapeHtml[2m > [22mescapes single quotes[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/sanitize.test.ts[2m > [22mSanitization[2m > [22mescapeHtml[2m > [22mescapes forward slashes[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/sanitize.test.ts[2m > [22mSanitization[2m > [22mescapeHtml[2m > [22mescapes script tags completely[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/sanitize.test.ts[2m > [22mSanitization[2m > [22mescapeHtml[2m > [22mescapes img onerror XSS payload[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/sanitize.test.ts[2m > [22mSanitization[2m > [22mescapeHtml[2m > [22mescapes nested script tags[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/sanitize.test.ts[2m > [22mSanitization[2m > [22mescapeHtml[2m > [22mescapes event handler injection[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/sanitize.test.ts[2m > [22mSanitization[2m > [22mescapeHtml[2m > [22mhandles non-string input by converting to string[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/sanitize.test.ts[2m > [22mSanitization[2m > [22mescapeHtml[2m > [22mhandles empty string[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/sanitize.test.ts[2m > [22mSanitization[2m > [22mescapeHtml[2m > [22mescapes SVG XSS payloads[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/sanitize.test.ts[2m > [22mSanitization[2m > [22mescapeHtml[2m > [22mescapes body onload XSS payloads[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/sanitize.test.ts[2m > [22mSanitization[2m > [22msanitizeUrl[2m > [22mblocks javascript: protocol[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/sanitize.test.ts[2m > [22mSanitization[2m > [22msanitizeUrl[2m > [22mblocks javascript: with mixed case[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/sanitize.test.ts[2m > [22mSanitization[2m > [22msanitizeUrl[2m > [22mblocks javascript: with spaces[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/sanitize.test.ts[2m > [22mSanitization[2m > [22msanitizeUrl[2m > [22mblocks data: protocol[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/sanitize.test.ts[2m > [22mSanitization[2m > [22msanitizeUrl[2m > [22mblocks vbscript: protocol[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/sanitize.test.ts[2m > [22mSanitization[2m > [22msanitizeUrl[2m > [22mallows https:// URLs[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/sanitize.test.ts[2m > [22mSanitization[2m > [22msanitizeUrl[2m > [22mallows http:// URLs[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/sanitize.test.ts[2m > [22mSanitization[2m > [22msanitizeUrl[2m > [22mallows mailto: URLs[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/sanitize.test.ts[2m > [22mSanitization[2m > [22msanitizeUrl[2m > [22mallows relative paths starting with /[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/sanitize.test.ts[2m > [22mSanitization[2m > [22msanitizeUrl[2m > [22mrejects unknown protocols[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/sanitize.test.ts[2m > [22mSanitization[2m > [22msanitizeUrl[2m > [22mrejects telnet protocol[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/sanitize.test.ts[2m > [22mSanitization[2m > [22msanitizeUrl[2m > [22mhandles empty input[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/sanitize.test.ts[2m > [22mSanitization[2m > [22msanitizeUrl[2m > [22mhandles non-string input[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/sanitize.test.ts[2m > [22mSanitization[2m > [22msanitizeUrl[2m > [22mtrims whitespace from valid URLs[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/sanitize.test.ts[2m > [22mSanitization[2m > [22mstripHtml[2m > [22mremoves all HTML tags[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/sanitize.test.ts[2m > [22mSanitization[2m > [22mstripHtml[2m > [22mremoves script tags and content between[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/sanitize.test.ts[2m > [22mSanitization[2m > [22mstripHtml[2m > [22mremoves self-closing tags[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/sanitize.test.ts[2m > [22mSanitization[2m > [22mstripHtml[2m > [22mremoves nested tags[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/sanitize.test.ts[2m > [22mSanitization[2m > [22mstripHtml[2m > [22mhandles non-string input[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/sanitize.test.ts[2m > [22mSanitization[2m > [22mstripHtml[2m > [22mhandles empty string[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/sanitize.test.ts[2m > [22mSanitization[2m > [22mstripHtml[2m > [22mpreserves plain text without HTML[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/sanitize.test.ts[2m > [22mSanitization[2m > [22mstripHtml[2m > [22mremoves img tags[32m 0[2mms[22m[39m
[90mstderr[2m | security-tests/integration/admin/admin-access.security.test.ts[2m > [22m[2mPOST /api/admin/set-admin-claim[2m > [22m[2mrate limiter is isolated per identifier - different IPs are tracked separately
[22m[39m[rateLimitPersistent] Firestore error, falling back to in-memory rate limiting: TypeError: db.runTransaction is not a function
    at rateLimitPersistent (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rateLimitPersistent.ts:111:29)
    at checkRateLimit (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rate-limiter.ts:166:26)
    at POST (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/admin/set-admin-claim.ts:20:33)
    at callEndpoint (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:390:12)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:569:7
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:20
[rateLimitPersistent] Using in-memory fallback for key: set-admin-claim:192.168.1.10 { ok: [33mtrue[39m, remaining: [33m2[39m }

[90mstderr[2m | security-tests/unit/csrf.test.ts[2m > [22m[2mCSRF Protection[2m > [22m[2mvalidateCSRF[2m > [22m[2mrejects POST with no Origin and no Referer
[22m[39m[CSRF] Origin validation failed { origin: [1mnull[22m, referer: [1mnull[22m, host: [32m'localhost:4321'[39m, method: [32m'POST'[39m }

 [32mâœ“[39m security-tests/integration/admin/admin-access.security.test.ts[2m > [22mPOST /api/admin/set-admin-claim[2m > [22mreturns 401 when no Authorization header is provided[33m 502[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/admin/admin-access.security.test.ts[2m > [22mPOST /api/admin/set-admin-claim[2m > [22mreturns 401 when Authorization header does not start with Bearer[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/admin/admin-access.security.test.ts[2m > [22mPOST /api/admin/set-admin-claim[2m > [22mreturns 401 when token is invalid (not in TOKEN_MAP)[32m 4[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/admin/admin-access.security.test.ts[2m > [22mPOST /api/admin/set-admin-claim[2m > [22mreturns 401 when token is malformed[32m 5[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/admin/admin-access.security.test.ts[2m > [22mPOST /api/admin/set-admin-claim[2m > [22mreturns 403 when authenticated user email is not in ADMIN_EMAILS[32m 19[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/admin/admin-access.security.test.ts[2m > [22mPOST /api/admin/set-admin-claim[2m > [22m403 error body does not expose the ADMIN_EMAILS list contents[32m 8[2mms[22m[39m
 [31mÃ—[39m security-tests/integration/admin/admin-access.security.test.ts[2m > [22mPOST /api/admin/set-admin-claim[2m > [22mreturns 200 when admin user requests their own admin claim[32m 8[2mms[22m[39m
[31m   â†’ expected 429 to be 200 // Object.is equality[39m
 [31mÃ—[39m security-tests/integration/admin/admin-access.security.test.ts[2m > [22mPOST /api/admin/set-admin-claim[2m > [22mcalls setCustomUserClaims with { admin: true } for eligible users[32m 4[2mms[22m[39m
[31m   â†’ expected "vi.fn()" to be called with arguments: [ 'admin-456', { admin: true } ][90m

Number of calls: [1m0[22m
[31m[39m
 [31mÃ—[39m security-tests/integration/admin/admin-access.security.test.ts[2m > [22mPOST /api/admin/set-admin-claim[2m > [22mreturns 200 with informative message when user already has admin claim[32m 2[2mms[22m[39m
[31m   â†’ expected 429 to be 200 // Object.is equality[39m
 [32mâœ“[39m security-tests/integration/admin/admin-access.security.test.ts[2m > [22mPOST /api/admin/set-admin-claim[2m > [22mreturns 429 after VERY_STRICT limit (5 requests) is exceeded[32m 19[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/admin/admin-access.security.test.ts[2m > [22mPOST /api/admin/set-admin-claim[2m > [22m429 response includes Retry-After header[32m 20[2mms[22m[39m
[90mstderr[2m | security-tests/unit/csrf.test.ts[2m > [22m[2mCSRF Protection[2m > [22m[2mvalidateCSRF[2m > [22m[2mrejects POST with mismatched Origin (evil.com)
[22m[39m[CSRF] Origin validation failed {
  origin: [32m'https://evil.com'[39m,
  referer: [1mnull[22m,
  host: [32m'localhost:4321'[39m,
  method: [32m'POST'[39m
}

[90mstderr[2m | security-tests/unit/csrf.test.ts[2m > [22m[2mCSRF Protection[2m > [22m[2mvalidateCSRF[2m > [22m[2mrejects POST with mismatched Referer
[22m[39m[CSRF] Origin validation failed {
  origin: [1mnull[22m,
  referer: [32m'https://evil.com/steal-data'[39m,
  host: [32m'localhost:4321'[39m,
  method: [32m'POST'[39m
}

[90mstderr[2m | security-tests/unit/csrf.test.ts[2m > [22m[2mCSRF Protection[2m > [22m[2mvalidateCSRF[2m > [22m[2mrejects POST with valid Origin but no custom header (text/html)
[22m[39m[CSRF] Missing custom header for AJAX request { method: [32m'POST'[39m, contentType: [32m'text/html'[39m }

[90mstderr[2m | security-tests/unit/csrf.test.ts[2m > [22m[2mCSRF Protection[2m > [22m[2mvalidateCSRF[2m > [22m[2mrejects POST with valid Origin but Content-Type: application/x-www-form-urlencoded
[22m[39m[CSRF] Missing custom header for AJAX request { method: [32m'POST'[39m, contentType: [32m'application/x-www-form-urlencoded'[39m }

[90mstderr[2m | security-tests/unit/csrf.test.ts[2m > [22m[2mCSRF Protection[2m > [22m[2mvalidateCSRF[2m > [22m[2mrejects PUT with mismatched Origin
[22m[39m[CSRF] Origin validation failed {
  origin: [32m'https://attacker.com'[39m,
  referer: [1mnull[22m,
  host: [32m'localhost:4321'[39m,
  method: [32m'PUT'[39m
}

[90mstderr[2m | security-tests/unit/csrf.test.ts[2m > [22m[2mCSRF Protection[2m > [22m[2mvalidateCSRF[2m > [22m[2mrejects DELETE with mismatched Origin
[22m[39m[CSRF] Origin validation failed {
  origin: [32m'https://attacker.com'[39m,
  referer: [1mnull[22m,
  host: [32m'localhost:4321'[39m,
  method: [32m'DELETE'[39m
}

[90mstderr[2m | security-tests/integration/admin/admin-access.security.test.ts[2m > [22m[2mPOST /api/admin/set-admin-claim[2m > [22m[2mrate limiter is isolated per identifier - different IPs are tracked separately
[22m[39m[rateLimitPersistent] Firestore error, falling back to in-memory rate limiting: TypeError: db.runTransaction is not a function
    at rateLimitPersistent (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rateLimitPersistent.ts:111:29)
    at checkRateLimit (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rate-limiter.ts:166:26)
    at POST (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/admin/set-admin-claim.ts:20:33)
    at callEndpoint (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:390:12)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:569:7
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:20
[rateLimitPersistent] Using in-memory fallback for key: set-admin-claim:192.168.1.10 { ok: [33mtrue[39m, remaining: [33m1[39m }

 [32mâœ“[39m security-tests/unit/validation-schemas.test.ts[2m > [22mValidation Schemas - Security[2m > [22mshippingInfoSchema - XSS prevention[2m > [22mrejects firstName with script tag[32m 4[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/validation-schemas.test.ts[2m > [22mValidation Schemas - Security[2m > [22mshippingInfoSchema - XSS prevention[2m > [22mrejects firstName with 10,000 characters[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/validation-schemas.test.ts[2m > [22mValidation Schemas - Security[2m > [22mshippingInfoSchema - XSS prevention[2m > [22mrejects lastName with SQL injection[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/validation-schemas.test.ts[2m > [22mValidation Schemas - Security[2m > [22mshippingInfoSchema - XSS prevention[2m > [22mrejects email with XSS payload[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/validation-schemas.test.ts[2m > [22mValidation Schemas - Security[2m > [22mshippingInfoSchema - XSS prevention[2m > [22mrejects phone with non-numeric characters[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/validation-schemas.test.ts[2m > [22mValidation Schemas - Security[2m > [22mshippingInfoSchema - XSS prevention[2m > [22mrejects zipCode that is not exactly 5 digits[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/validation-schemas.test.ts[2m > [22mValidation Schemas - Security[2m > [22mshippingInfoSchema - XSS prevention[2m > [22mrejects city with numbers[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/validation-schemas.test.ts[2m > [22mValidation Schemas - Security[2m > [22mshippingInfoSchema - XSS prevention[2m > [22maccepts valid Spanish shipping data[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/validation-schemas.test.ts[2m > [22mValidation Schemas - Security[2m > [22mshippingInfoSchema - XSS prevention[2m > [22mrejects address with 300 characters (max 200)[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/validation-schemas.test.ts[2m > [22mValidation Schemas - Security[2m > [22mshippingInfoSchema - XSS prevention[2m > [22mrejects notes with 600 characters (max 500)[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/validation-schemas.test.ts[2m > [22mValidation Schemas - Security[2m > [22mcouponSchema - fraud prevention[2m > [22mrejects code with special characters[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/validation-schemas.test.ts[2m > [22mValidation Schemas - Security[2m > [22mcouponSchema - fraud prevention[2m > [22mrejects code longer than 20 characters[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/validation-schemas.test.ts[2m > [22mValidation Schemas - Security[2m > [22mcouponSchema - fraud prevention[2m > [22mrejects negative coupon value[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/validation-schemas.test.ts[2m > [22mValidation Schemas - Security[2m > [22mcouponSchema - fraud prevention[2m > [22mrejects percentage value over 100[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/validation-schemas.test.ts[2m > [22mValidation Schemas - Security[2m > [22mcouponSchema - fraud prevention[2m > [22mrejects coupon that has reached usage limit[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/validation-schemas.test.ts[2m > [22mValidation Schemas - Security[2m > [22mcouponSchema - fraud prevention[2m > [22mrejects free_shipping with non-zero value[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/validation-schemas.test.ts[2m > [22mValidation Schemas - Security[2m > [22mcouponSchema - fraud prevention[2m > [22maccepts valid coupon[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/validation-schemas.test.ts[2m > [22mValidation Schemas - Security[2m > [22mvalidateCouponCodeSchema[2m > [22mrejects empty code[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/validation-schemas.test.ts[2m > [22mValidation Schemas - Security[2m > [22mvalidateCouponCodeSchema[2m > [22mrejects negative cartTotal[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/validation-schemas.test.ts[2m > [22mValidation Schemas - Security[2m > [22mvalidateCouponCodeSchema[2m > [22mtransforms code to uppercase[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/validation-schemas.test.ts[2m > [22mValidation Schemas - Security[2m > [22mproductSchema - admin input security[2m > [22mrejects slug with path traversal[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/validation-schemas.test.ts[2m > [22mValidation Schemas - Security[2m > [22mproductSchema - admin input security[2m > [22mrejects slug with special characters[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/validation-schemas.test.ts[2m > [22mValidation Schemas - Security[2m > [22mproductSchema - admin input security[2m > [22mrejects negative basePrice[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/validation-schemas.test.ts[2m > [22mValidation Schemas - Security[2m > [22mproductSchema - admin input security[2m > [22mrejects basePrice of zero[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/validation-schemas.test.ts[2m > [22mValidation Schemas - Security[2m > [22mproductSchema - admin input security[2m > [22mrejects extremely high basePrice (>999999.99)[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/validation-schemas.test.ts[2m > [22mValidation Schemas - Security[2m > [22mproductSchema - admin input security[2m > [22mrejects name with 250 characters (max 200)[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/validation-schemas.test.ts[2m > [22mValidation Schemas - Security[2m > [22mproductSchema - admin input security[2m > [22mrejects description with 2500 characters (max 2000)[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/validation-schemas.test.ts[2m > [22mValidation Schemas - Security[2m > [22mproductSchema - admin input security[2m > [22mrejects salePrice >= basePrice when onSale[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/validation-schemas.test.ts[2m > [22mValidation Schemas - Security[2m > [22mproductSchema - admin input security[2m > [22maccepts valid product[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/validation-schemas.test.ts[2m > [22mValidation Schemas - Security[2m > [22mIndividual field schemas with attack payloads[2m > [22memailSchema rejects clearly invalid email[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/validation-schemas.test.ts[2m > [22mValidation Schemas - Security[2m > [22mIndividual field schemas with attack payloads[2m > [22memailSchema normalizes to lowercase[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/validation-schemas.test.ts[2m > [22mValidation Schemas - Security[2m > [22mIndividual field schemas with attack payloads[2m > [22mphoneSchema rejects alphabetic input[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/validation-schemas.test.ts[2m > [22mValidation Schemas - Security[2m > [22mIndividual field schemas with attack payloads[2m > [22mzipCodeSchema rejects non-5-digit input[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/validation-schemas.test.ts[2m > [22mValidation Schemas - Security[2m > [22mIndividual field schemas with attack payloads[2m > [22mzipCodeSchema rejects letters[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/validation-schemas.test.ts[2m > [22mValidation Schemas - Security[2m > [22mProto pollution and type confusion[2m > [22mshippingInfoSchema safely handles __proto__ key[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/validation-schemas.test.ts[2m > [22mValidation Schemas - Security[2m > [22mProto pollution and type confusion[2m > [22mshippingInfoSchema handles constructor pollution attempt[32m 0[2mms[22m[39m
[90mstderr[2m | security-tests/integration/admin/admin-access.security.test.ts[2m > [22m[2mPOST /api/admin/set-admin-claim[2m > [22m[2mrate limiter is isolated per identifier - different IPs are tracked separately
[22m[39m[rateLimitPersistent] Firestore error, falling back to in-memory rate limiting: TypeError: db.runTransaction is not a function
    at rateLimitPersistent (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rateLimitPersistent.ts:111:29)
    at checkRateLimit (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rate-limiter.ts:166:26)
    at POST (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/admin/set-admin-claim.ts:20:33)
    at callEndpoint (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:390:12)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:569:7
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:20
[rateLimitPersistent] Using in-memory fallback for key: set-admin-claim:192.168.1.10 { ok: [33mtrue[39m, remaining: [33m0[39m }

 [32mâœ“[39m security-tests/unit/csrf.test.ts[2m > [22mCSRF Protection[2m > [22mvalidateCSRF[2m > [22mallows GET requests regardless of origin[32m 28[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/csrf.test.ts[2m > [22mCSRF Protection[2m > [22mvalidateCSRF[2m > [22mallows HEAD requests regardless of origin[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/csrf.test.ts[2m > [22mCSRF Protection[2m > [22mvalidateCSRF[2m > [22mallows OPTIONS requests regardless of origin[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/csrf.test.ts[2m > [22mCSRF Protection[2m > [22mvalidateCSRF[2m > [22mrejects POST with no Origin and no Referer[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/csrf.test.ts[2m > [22mCSRF Protection[2m > [22mvalidateCSRF[2m > [22mrejects POST with mismatched Origin (evil.com)[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/csrf.test.ts[2m > [22mCSRF Protection[2m > [22mvalidateCSRF[2m > [22mrejects POST with mismatched Referer[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/csrf.test.ts[2m > [22mCSRF Protection[2m > [22mvalidateCSRF[2m > [22mrejects POST with valid Origin but no custom header (text/html)[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/csrf.test.ts[2m > [22mCSRF Protection[2m > [22mvalidateCSRF[2m > [22mrejects POST with valid Origin but Content-Type: application/x-www-form-urlencoded[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/csrf.test.ts[2m > [22mCSRF Protection[2m > [22mvalidateCSRF[2m > [22maccepts POST with matching Origin + Content-Type: application/json[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/csrf.test.ts[2m > [22mCSRF Protection[2m > [22mvalidateCSRF[2m > [22maccepts POST with matching Origin + X-Requested-With: XMLHttpRequest[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/csrf.test.ts[2m > [22mCSRF Protection[2m > [22mvalidateCSRF[2m > [22mrejects PUT with mismatched Origin[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/csrf.test.ts[2m > [22mCSRF Protection[2m > [22mvalidateCSRF[2m > [22mrejects DELETE with mismatched Origin[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/csrf.test.ts[2m > [22mCSRF Protection[2m > [22mvalidateCSRF[2m > [22maccepts POST with matching Referer when Origin is absent[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/csrf.test.ts[2m > [22mCSRF Protection[2m > [22mvalidateOrigin[2m > [22mreturns true when Origin host matches Host header[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/csrf.test.ts[2m > [22mCSRF Protection[2m > [22mvalidateOrigin[2m > [22mreturns false when Origin host does not match[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/csrf.test.ts[2m > [22mCSRF Protection[2m > [22mvalidateOrigin[2m > [22mhandles malformed URL in Origin header gracefully[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/csrf.test.ts[2m > [22mCSRF Protection[2m > [22mvalidateOrigin[2m > [22mfalls back to Referer when Origin is absent[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/csrf.test.ts[2m > [22mCSRF Protection[2m > [22mvalidateOrigin[2m > [22mallows GET when no Origin or Referer present[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/csrf.test.ts[2m > [22mCSRF Protection[2m > [22mvalidateOrigin[2m > [22mrejects POST when no Origin or Referer present[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/csrf.test.ts[2m > [22mCSRF Protection[2m > [22mhasCustomHeader[2m > [22mreturns true with X-Requested-With: XMLHttpRequest[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/csrf.test.ts[2m > [22mCSRF Protection[2m > [22mhasCustomHeader[2m > [22mreturns true with Content-Type: application/json[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/csrf.test.ts[2m > [22mCSRF Protection[2m > [22mhasCustomHeader[2m > [22mreturns true with Content-Type: application/json; charset=utf-8[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/csrf.test.ts[2m > [22mCSRF Protection[2m > [22mhasCustomHeader[2m > [22mrejects text/html Content-Type[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/csrf.test.ts[2m > [22mCSRF Protection[2m > [22mhasCustomHeader[2m > [22mrejects form-urlencoded Content-Type[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/csrf.test.ts[2m > [22mCSRF Protection[2m > [22mhasCustomHeader[2m > [22mrejects when no relevant headers are present[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/csrf.test.ts[2m > [22mCSRF Protection[2m > [22mcreateCSRFErrorResponse[2m > [22mreturns 403 status[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/csrf.test.ts[2m > [22mCSRF Protection[2m > [22mcreateCSRFErrorResponse[2m > [22mreturns JSON body with error message[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/csrf.test.ts[2m > [22mCSRF Protection[2m > [22mcreateCSRFErrorResponse[2m > [22mhas Content-Type: application/json header[32m 0[2mms[22m[39m
[90mstderr[2m | security-tests/integration/admin/admin-access.security.test.ts[2m > [22m[2mPOST /api/admin/set-admin-claim[2m > [22m[2mrate limiter is isolated per identifier - different IPs are tracked separately
[22m[39m[rateLimitPersistent] Firestore error, falling back to in-memory rate limiting: TypeError: db.runTransaction is not a function
    at rateLimitPersistent (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rateLimitPersistent.ts:111:29)
    at checkRateLimit (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rate-limiter.ts:166:26)
    at POST (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/admin/set-admin-claim.ts:20:33)
    at callEndpoint (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:390:12)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:569:7
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:20
[rateLimitPersistent] Using in-memory fallback for key: set-admin-claim:192.168.1.10 { ok: [33mfalse[39m, remaining: [33m0[39m }

[90mstderr[2m | security-tests/integration/admin/admin-access.security.test.ts[2m > [22m[2mPOST /api/admin/set-admin-claim[2m > [22m[2mrate limiter is isolated per identifier - different IPs are tracked separately
[22m[39m[rateLimitPersistent] Firestore error, falling back to in-memory rate limiting: TypeError: db.runTransaction is not a function
    at rateLimitPersistent (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rateLimitPersistent.ts:111:29)
    at checkRateLimit (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rate-limiter.ts:166:26)
    at POST (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/admin/set-admin-claim.ts:20:33)
    at callEndpoint (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:390:12)
[90m    at processTicksAndRejections (node:internal/process/task_queues:105:5)[39m
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/integration/admin/admin-access.security.test.ts:582:18
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:20
[rateLimitPersistent] Using in-memory fallback for key: set-admin-claim:192.168.1.20 { ok: [33mtrue[39m, remaining: [33m4[39m }

 [32mâœ“[39m security-tests/integration/admin/admin-access.security.test.ts[2m > [22mPOST /api/admin/set-admin-claim[2m > [22mrate limiter is isolated per identifier - different IPs are tracked separately[32m 73[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/cron/cron.security.test.ts[2m > [22mAUTH â€” cron secret enforcement[2m > [22mAUTH-1: returns 401 when no Authorization header is present[32m 22[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/cron/cron.security.test.ts[2m > [22mAUTH â€” cron secret enforcement[2m > [22mAUTH-2: returns 401 when the Authorization header carries the wrong secret[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/cron/cron.security.test.ts[2m > [22mAUTH â€” cron secret enforcement[2m > [22mAUTH-3: returns 200 and processes reservations when the correct CRON_SECRET is supplied[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/cron/cron.security.test.ts[2m > [22mPOST â€” delegates to GET handler[2m > [22mPOST-1: returns 200 via POST with the correct CRON_SECRET[32m 1[2mms[22m[39m
[90mstderr[2m | security-tests/unit/rate-limiter.test.ts[2m > [22m[2mRate Limiter[2m > [22m[2mVERY_STRICT tier (5 req/min)[2m > [22m[2mallows first 5 requests
[22m[39m[WARN] Intentando usar Application Default Credentials 

 [32mâœ“[39m security-tests/integration/digital/download-file.security.test.ts[2m > [22mAUTH â€” authentication enforcement[2m > [22mAUTH-1: returns 401 when no Authorization header is present[32m 29[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/digital/download-file.security.test.ts[2m > [22mINPUT â€” request body validation[2m > [22mINPUT-1: returns 400 when digitalAccessId is missing from the body[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/digital/download-file.security.test.ts[2m > [22mINPUT â€” request body validation[2m > [22mINPUT-2: returns 400 when fileId is missing from the body[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/digital/download-file.security.test.ts[2m > [22mIDOR â€” insecure direct object reference protection[2m > [22mIDOR-1: returns 403 when a user attempts to access another user's digital access record[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/digital/download-file.security.test.ts[2m > [22mTRAVERSAL â€” path traversal protection[2m > [22mTRAVERSAL-1: returns 403 for a storagePath containing path traversal sequences[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/digital/download-file.security.test.ts[2m > [22mTRAVERSAL â€” path traversal protection[2m > [22mTRAVERSAL-2: returns 403 for a storagePath that is outside the allowed prefixes[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/digital/download-file.security.test.ts[2m > [22mACCESS â€” authorised file download[2m > [22mACCESS-1: returns 200 with file content for a valid, authorised request[32m 1[2mms[22m[39m
[90mstderr[2m | security-tests/error-leakage/error-responses.test.ts[2m > [22m[2mError Leakage: API responses must not expose internal details[2m > [22m[2mvalidate-coupon 500 error field does not leak internal error details
[22m[39m[rateLimitPersistent] Firestore error, falling back to in-memory rate limiting: Error: ECONNREFUSED 10.0.0.1:8080 at /home/user/node_modules/grpc/src/client.js:42
    at Object.__firebase.db.collection (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/error-leakage/error-responses.test.ts:107:13)
    at rateLimitPersistent (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rateLimitPersistent.ts:108:29)
    at checkRateLimit (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rate-limiter.ts:166:26)
    at Module.POST (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/validate-coupon.ts:36:33)
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/error-leakage/error-responses.test.ts:114:23
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:157:11
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:26
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1636:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1602:10[90m)[39m
[rateLimitPersistent] Using in-memory fallback for key: validate-coupon:unknown { ok: [33mtrue[39m, remaining: [33m59[39m }

 [32mâœ“[39m security-tests/integration/storage/get-signed-url.security.test.ts[2m > [22mAUTH â€” authentication enforcement[2m > [22mAUTH-1: returns 401 when no Authorization header is present[32m 35[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/storage/get-signed-url.security.test.ts[2m > [22mAUTH â€” authentication enforcement[2m > [22mAUTH-2: returns error when the Bearer token is invalid[32m 3[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/storage/get-signed-url.security.test.ts[2m > [22mPATH â€” path access control[2m > [22mPATH-1: returns 200 when a user requests a signed URL for their own file path[32m 3[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/storage/get-signed-url.security.test.ts[2m > [22mPATH â€” path access control[2m > [22mPATH-2: returns 403 when a user requests a signed URL for another user's file path[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/storage/get-signed-url.security.test.ts[2m > [22mPATH â€” path access control[2m > [22mPATH-3: returns 403 when a user requests an arbitrary path outside allowed prefixes[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/storage/get-signed-url.security.test.ts[2m > [22mTRAVERSAL â€” path traversal protection[2m > [22mTRAVERSAL-1: returns 403 when path contains traversal sequences[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/storage/get-signed-url.security.test.ts[2m > [22mADMIN â€” elevated access control[2m > [22mADMIN-1: returns 200 when an admin requests a signed URL for another user's path[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/storage/get-signed-url.security.test.ts[2m > [22mINPUT â€” request body validation[2m > [22mINPUT-1: returns 400 when the path field is an empty string[32m 1[2mms[22m[39m
 [31mÃ—[39m security-tests/unit/rate-limiter.test.ts[2m > [22mRate Limiter[2m > [22mVERY_STRICT tier (5 req/min)[2m > [22mallows first 5 requests[32m 32[2mms[22m[39m
[31m   â†’ expected undefined to be true // Object.is equality[39m
 [31mÃ—[39m security-tests/unit/rate-limiter.test.ts[2m > [22mRate Limiter[2m > [22mVERY_STRICT tier (5 req/min)[2m > [22mblocks 6th request with 429[32m 2[2mms[22m[39m
[31m   â†’ expected undefined to be false // Object.is equality[39m
 [31mÃ—[39m security-tests/unit/rate-limiter.test.ts[2m > [22mRate Limiter[2m > [22mSTRICT tier (10 req/min)[2m > [22mallows first 10 requests[32m 1[2mms[22m[39m
[31m   â†’ expected undefined to be true // Object.is equality[39m
 [31mÃ—[39m security-tests/unit/rate-limiter.test.ts[2m > [22mRate Limiter[2m > [22mSTRICT tier (10 req/min)[2m > [22mblocks 11th request[32m 2[2mms[22m[39m
[31m   â†’ expected undefined to be false // Object.is equality[39m
 [31mÃ—[39m security-tests/unit/rate-limiter.test.ts[2m > [22mRate Limiter[2m > [22mSTANDARD tier (60 req/min)[2m > [22mallows first 60 requests[32m 2[2mms[22m[39m
[31m   â†’ expected undefined to be true // Object.is equality[39m
 [31mÃ—[39m security-tests/unit/rate-limiter.test.ts[2m > [22mRate Limiter[2m > [22mSTANDARD tier (60 req/min)[2m > [22mblocks 61st request[32m 4[2mms[22m[39m
[31m   â†’ expected undefined to be false // Object.is equality[39m
 [31mÃ—[39m security-tests/unit/rate-limiter.test.ts[2m > [22mRate Limiter[2m > [22mGENEROUS tier (120 req/min)[2m > [22mallows first 120 requests[32m 1[2mms[22m[39m
[31m   â†’ expected undefined to be true // Object.is equality[39m
 [31mÃ—[39m security-tests/unit/rate-limiter.test.ts[2m > [22mRate Limiter[2m > [22mGENEROUS tier (120 req/min)[2m > [22mblocks 121st request[32m 5[2mms[22m[39m
[31m   â†’ expected undefined to be false // Object.is equality[39m
 [31mÃ—[39m security-tests/unit/rate-limiter.test.ts[2m > [22mRate Limiter[2m > [22mResponse headers[2m > [22mreturns Retry-After header when rate limited[32m 2[2mms[22m[39m
[31m   â†’ expected undefined to be false // Object.is equality[39m
 [31mÃ—[39m security-tests/unit/rate-limiter.test.ts[2m > [22mRate Limiter[2m > [22mResponse headers[2m > [22mreturns remaining count correctly[32m 1[2mms[22m[39m
[31m   â†’ expected undefined to be 4 // Object.is equality[39m
 [31mÃ—[39m security-tests/unit/rate-limiter.test.ts[2m > [22mRate Limiter[2m > [22mResponse headers[2m > [22mreturns resetAt timestamp[32m 1[2mms[22m[39m
[31m   â†’ expected undefined to be defined[39m
 [31mÃ—[39m security-tests/unit/rate-limiter.test.ts[2m > [22mRate Limiter[2m > [22mNamespace isolation[2m > [22mdifferent namespaces track independently[32m 1[2mms[22m[39m
[31m   â†’ expected undefined to be false // Object.is equality[39m
 [31mÃ—[39m security-tests/unit/rate-limiter.test.ts[2m > [22mRate Limiter[2m > [22mIdentifier isolation[2m > [22mdifferent users (Bearer tokens) track independently[32m 1[2mms[22m[39m
[31m   â†’ expected undefined to be false // Object.is equality[39m
 [32mâœ“[39m security-tests/unit/rate-limiter.test.ts[2m > [22mRate Limiter[2m > [22mIdentifier isolation[2m > [22mfalls back to X-Forwarded-For when no auth header[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/rate-limiter.test.ts[2m > [22mRate Limiter[2m > [22mIdentifier isolation[2m > [22muses first 16 chars of Bearer token as identifier[32m 0[2mms[22m[39m
 [31mÃ—[39m security-tests/unit/rate-limiter.test.ts[2m > [22mRate Limiter[2m > [22mclearAllRateLimits[2m > [22mresets all counters[32m 1[2mms[22m[39m
[31m   â†’ expected undefined to be false // Object.is equality[39m
 [31mÃ—[39m security-tests/unit/rate-limiter.test.ts[2m > [22mRate Limiter[2m > [22mclearRateLimit[2m > [22mclears a specific identifier[32m 1[2mms[22m[39m
[31m   â†’ expected undefined to be false // Object.is equality[39m
 [32mâœ“[39m security-tests/unit/rate-limiter.test.ts[2m > [22mRate Limiter[2m > [22mcreateRateLimitResponse[2m > [22mreturns 429 status[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/rate-limiter.test.ts[2m > [22mRate Limiter[2m > [22mcreateRateLimitResponse[2m > [22mincludes Retry-After header[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/rate-limiter.test.ts[2m > [22mRate Limiter[2m > [22mcreateRateLimitResponse[2m > [22mincludes X-RateLimit-Limit header[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/rate-limiter.test.ts[2m > [22mRate Limiter[2m > [22mcreateRateLimitResponse[2m > [22mincludes X-RateLimit-Remaining header[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/unit/rate-limiter.test.ts[2m > [22mRate Limiter[2m > [22mcreateRateLimitResponse[2m > [22mreturns JSON body with error message[32m 2[2mms[22m[39m
[90mstderr[2m | security-tests/error-leakage/error-responses.test.ts[2m > [22m[2mError Leakage: API responses must not expose internal details[2m > [22m[2m500 error responses have Content-Type: application/json
[22m[39m[rateLimitPersistent] Firestore error, falling back to in-memory rate limiting: Error: DB down
    at Object.__firebase.db.collection (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/error-leakage/error-responses.test.ts:207:13)
    at rateLimitPersistent (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rateLimitPersistent.ts:108:29)
    at checkRateLimit (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/lib/rate-limiter.ts:166:26)
    at Module.POST (C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/src/pages/api/validate-coupon.ts:36:33)
    at C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/security-tests/error-leakage/error-responses.test.ts:214:23
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:157:11
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:753:26
    at [90mfile:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1636:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///C:/Users/Usuario/Desktop/ecommerce-personalizado-nuevo/[39mnode_modules/[4m@vitest[24m/runner/dist/index.js:1602:10[90m)[39m
[rateLimitPersistent] Using in-memory fallback for key: validate-coupon:unknown { ok: [33mtrue[39m, remaining: [33m58[39m }

 [32mâœ“[39m security-tests/error-leakage/error-responses.test.ts[2m > [22mError Leakage: API responses must not expose internal details[2m > [22mvalidate-coupon 500 error field does not leak internal error details[32m 29[2mms[22m[39m
 [32mâœ“[39m security-tests/error-leakage/error-responses.test.ts[2m > [22mError Leakage: API responses must not expose internal details[2m > [22mcreate-payment-intent 500 does not leak Stripe keys or paths[32m 3[2mms[22m[39m
 [32mâœ“[39m security-tests/error-leakage/error-responses.test.ts[2m > [22mError Leakage: API responses must not expose internal details[2m > [22m401 responses do not reveal authentication mechanism details[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/error-leakage/error-responses.test.ts[2m > [22mError Leakage: API responses must not expose internal details[2m > [22m400 validation errors do not expose Zod internal structure in production[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/error-leakage/error-responses.test.ts[2m > [22mError Leakage: API responses must not expose internal details[2m > [22merror responses have Content-Type: application/json[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/error-leakage/error-responses.test.ts[2m > [22mError Leakage: API responses must not expose internal details[2m > [22m500 error responses have Content-Type: application/json[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/designs/designs.security.test.ts[2m > [22mAuthentication[2m > [22mAUTH-1: POST /designs/save returns 401 without auth token[32m 26[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/designs/designs.security.test.ts[2m > [22mAuthentication[2m > [22mAUTH-2: GET /designs/get-user-designs returns 401 without auth token[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/designs/designs.security.test.ts[2m > [22mInput validation[2m > [22mINPUT-1: POST /designs/save returns 400 for invalid or missing required fields[32m 8[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/designs/designs.security.test.ts[2m > [22mSave design[2m > [22mSAVE-1: POST /designs/save sets userId from the auth token, not from the request body[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/designs/designs.security.test.ts[2m > [22mSave design[2m > [22mSAVE-2: POST /designs/save returns designId on success[32m 1[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/designs/designs.security.test.ts[2m > [22mIDOR protection[2m > [22mIDOR-1: GET /designs/get-user-designs returns only designs belonging to the authenticated user[32m 2[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/designs/designs.security.test.ts[2m > [22mIDOR protection[2m > [22mIDOR-2: User A cannot see User B's designs[32m 0[2mms[22m[39m
 [32mâœ“[39m security-tests/integration/designs/designs.security.test.ts[2m > [22mCSRF protection[2m > [22mCSRF-1: POST /designs/save rejects requests that fail CSRF validation (403)[32m 1[2mms[22m[39m

[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m[1m[41m Failed Tests 18 [49m[22m[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m

[41m[1m FAIL [22m[49m security-tests/unit/rate-limiter.test.ts[2m > [22mRate Limiter[2m > [22mVERY_STRICT tier (5 req/min)[2m > [22mallows first 5 requests
[31m[1mAssertionError[22m: expected undefined to be true // Object.is equality[39m

[32m- Expected:[39m 
true

[31m+ Received:[39m 
undefined

[36m [2mâ¯[22m security-tests/unit/rate-limiter.test.ts:[2m48:32[22m[39m
    [90m 46| [39m      [35mfor[39m ([35mlet[39m i [33m=[39m [34m0[39m[33m;[39m i [33m<[39m [34m5[39m[33m;[39m i[33m++[39m) {
    [90m 47| [39m        const result = checkRateLimit(req, RATE_LIMIT_CONFIGS.VERY_STRâ€¦
    [90m 48| [39m        [34mexpect[39m(result[33m.[39mallowed)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
    [90m   | [39m                               [31m^[39m
    [90m 49| [39m      }
    [90m 50| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[1/18]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m security-tests/unit/rate-limiter.test.ts[2m > [22mRate Limiter[2m > [22mVERY_STRICT tier (5 req/min)[2m > [22mblocks 6th request with 429
[31m[1mAssertionError[22m: expected undefined to be false // Object.is equality[39m

[32m- Expected:[39m 
false

[31m+ Received:[39m 
undefined

[36m [2mâ¯[22m security-tests/unit/rate-limiter.test.ts:[2m58:30[22m[39m
    [90m 56| [39m      }
    [90m 57| [39m      const result = checkRateLimit(req, RATE_LIMIT_CONFIGS.VERY_STRICâ€¦
    [90m 58| [39m      [34mexpect[39m(result[33m.[39mallowed)[33m.[39m[34mtoBe[39m([35mfalse[39m)[33m;[39m
    [90m   | [39m                             [31m^[39m
    [90m 59| [39m      [34mexpect[39m(result[33m.[39mretryAfter)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m 60| [39m      [34mexpect[39m(result[33m.[39mretryAfter[33m![39m)[33m.[39m[34mtoBeGreaterThan[39m([34m0[39m)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[2/18]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m security-tests/unit/rate-limiter.test.ts[2m > [22mRate Limiter[2m > [22mSTRICT tier (10 req/min)[2m > [22mallows first 10 requests
[31m[1mAssertionError[22m: expected undefined to be true // Object.is equality[39m

[32m- Expected:[39m 
true

[31m+ Received:[39m 
undefined

[36m [2mâ¯[22m security-tests/unit/rate-limiter.test.ts:[2m69:32[22m[39m
    [90m 67| [39m      [35mfor[39m ([35mlet[39m i [33m=[39m [34m0[39m[33m;[39m i [33m<[39m [34m10[39m[33m;[39m i[33m++[39m) {
    [90m 68| [39m        const result = checkRateLimit(req, RATE_LIMIT_CONFIGS.STRICT, â€¦
    [90m 69| [39m        [34mexpect[39m(result[33m.[39mallowed)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
    [90m   | [39m                               [31m^[39m
    [90m 70| [39m      }
    [90m 71| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[3/18]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m security-tests/unit/rate-limiter.test.ts[2m > [22mRate Limiter[2m > [22mSTRICT tier (10 req/min)[2m > [22mblocks 11th request
[31m[1mAssertionError[22m: expected undefined to be false // Object.is equality[39m

[32m- Expected:[39m 
false

[31m+ Received:[39m 
undefined

[36m [2mâ¯[22m security-tests/unit/rate-limiter.test.ts:[2m79:30[22m[39m
    [90m 77| [39m      }
    [90m 78| [39m      const result = checkRateLimit(req, RATE_LIMIT_CONFIGS.STRICT, 'aâ€¦
    [90m 79| [39m      [34mexpect[39m(result[33m.[39mallowed)[33m.[39m[34mtoBe[39m([35mfalse[39m)[33m;[39m
    [90m   | [39m                             [31m^[39m
    [90m 80| [39m    })[33m;[39m
    [90m 81| [39m  })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[4/18]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m security-tests/unit/rate-limiter.test.ts[2m > [22mRate Limiter[2m > [22mSTANDARD tier (60 req/min)[2m > [22mallows first 60 requests
[31m[1mAssertionError[22m: expected undefined to be true // Object.is equality[39m

[32m- Expected:[39m 
true

[31m+ Received:[39m 
undefined

[36m [2mâ¯[22m security-tests/unit/rate-limiter.test.ts:[2m88:32[22m[39m
    [90m 86| [39m      [35mfor[39m ([35mlet[39m i [33m=[39m [34m0[39m[33m;[39m i [33m<[39m [34m60[39m[33m;[39m i[33m++[39m) {
    [90m 87| [39m        const result = checkRateLimit(req, RATE_LIMIT_CONFIGS.STANDARDâ€¦
    [90m 88| [39m        [34mexpect[39m(result[33m.[39mallowed)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
    [90m   | [39m                               [31m^[39m
    [90m 89| [39m      }
    [90m 90| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[5/18]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m security-tests/unit/rate-limiter.test.ts[2m > [22mRate Limiter[2m > [22mSTANDARD tier (60 req/min)[2m > [22mblocks 61st request
[31m[1mAssertionError[22m: expected undefined to be false // Object.is equality[39m

[32m- Expected:[39m 
false

[31m+ Received:[39m 
undefined

[36m [2mâ¯[22m security-tests/unit/rate-limiter.test.ts:[2m98:30[22m[39m
    [90m 96| [39m      }
    [90m 97| [39m      const result = checkRateLimit(req, RATE_LIMIT_CONFIGS.STANDARD, â€¦
    [90m 98| [39m      [34mexpect[39m(result[33m.[39mallowed)[33m.[39m[34mtoBe[39m([35mfalse[39m)[33m;[39m
    [90m   | [39m                             [31m^[39m
    [90m 99| [39m    })[33m;[39m
    [90m100| [39m  })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[6/18]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m security-tests/unit/rate-limiter.test.ts[2m > [22mRate Limiter[2m > [22mGENEROUS tier (120 req/min)[2m > [22mallows first 120 requests
[31m[1mAssertionError[22m: expected undefined to be true // Object.is equality[39m

[32m- Expected:[39m 
true

[31m+ Received:[39m 
undefined

[36m [2mâ¯[22m security-tests/unit/rate-limiter.test.ts:[2m107:32[22m[39m
    [90m105| [39m      [35mfor[39m ([35mlet[39m i [33m=[39m [34m0[39m[33m;[39m i [33m<[39m [34m120[39m[33m;[39m i[33m++[39m) {
    [90m106| [39m        const result = checkRateLimit(req, RATE_LIMIT_CONFIGS.GENEROUSâ€¦
    [90m107| [39m        [34mexpect[39m(result[33m.[39mallowed)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
    [90m   | [39m                               [31m^[39m
    [90m108| [39m      }
    [90m109| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[7/18]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m security-tests/unit/rate-limiter.test.ts[2m > [22mRate Limiter[2m > [22mGENEROUS tier (120 req/min)[2m > [22mblocks 121st request
[31m[1mAssertionError[22m: expected undefined to be false // Object.is equality[39m

[32m- Expected:[39m 
false

[31m+ Received:[39m 
undefined

[36m [2mâ¯[22m security-tests/unit/rate-limiter.test.ts:[2m117:30[22m[39m
    [90m115| [39m      }
    [90m116| [39m      const result = checkRateLimit(req, RATE_LIMIT_CONFIGS.GENEROUS, â€¦
    [90m117| [39m      [34mexpect[39m(result[33m.[39mallowed)[33m.[39m[34mtoBe[39m([35mfalse[39m)[33m;[39m
    [90m   | [39m                             [31m^[39m
    [90m118| [39m    })[33m;[39m
    [90m119| [39m  })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[8/18]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m security-tests/unit/rate-limiter.test.ts[2m > [22mRate Limiter[2m > [22mResponse headers[2m > [22mreturns Retry-After header when rate limited
[31m[1mAssertionError[22m: expected undefined to be false // Object.is equality[39m

[32m- Expected:[39m 
false

[31m+ Received:[39m 
undefined

[36m [2mâ¯[22m security-tests/unit/rate-limiter.test.ts:[2m128:30[22m[39m
    [90m126| [39m      }
    [90m127| [39m      const result = checkRateLimit(req, RATE_LIMIT_CONFIGS.VERY_STRICâ€¦
    [90m128| [39m      [34mexpect[39m(result[33m.[39mallowed)[33m.[39m[34mtoBe[39m([35mfalse[39m)[33m;[39m
    [90m   | [39m                             [31m^[39m
    [90m129| [39m      [34mexpect[39m(result[33m.[39mretryAfter)[33m.[39m[34mtoBeGreaterThan[39m([34m0[39m)[33m;[39m
    [90m130| [39m      [34mexpect[39m(result[33m.[39mretryAfter[33m![39m)[33m.[39m[34mtoBeLessThanOrEqual[39m([34m60[39m)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[9/18]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m security-tests/unit/rate-limiter.test.ts[2m > [22mRate Limiter[2m > [22mResponse headers[2m > [22mreturns remaining count correctly
[31m[1mAssertionError[22m: expected undefined to be 4 // Object.is equality[39m

[32m- Expected:[39m 
4

[31m+ Received:[39m 
undefined

[36m [2mâ¯[22m security-tests/unit/rate-limiter.test.ts:[2m136:32[22m[39m
    [90m134| [39m      const req = makeRequest({ Authorization: 'Bearer test-token-remaâ€¦
    [90m135| [39m      const result = checkRateLimit(req, RATE_LIMIT_CONFIGS.VERY_STRICâ€¦
    [90m136| [39m      [34mexpect[39m(result[33m.[39mremaining)[33m.[39m[34mtoBe[39m([34m4[39m)[33m;[39m [90m// 5 max - 1 used[39m
    [90m   | [39m                               [31m^[39m
    [90m137| [39m      [34mexpect[39m(result[33m.[39mlimit)[33m.[39m[34mtoBe[39m([34m5[39m)[33m;[39m
    [90m138| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[10/18]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m security-tests/unit/rate-limiter.test.ts[2m > [22mRate Limiter[2m > [22mResponse headers[2m > [22mreturns resetAt timestamp
[31m[1mAssertionError[22m: expected undefined to be defined[39m
[36m [2mâ¯[22m security-tests/unit/rate-limiter.test.ts:[2m143:30[22m[39m
    [90m141| [39m      const req = makeRequest({ Authorization: 'Bearer test-token-reseâ€¦
    [90m142| [39m      const result = checkRateLimit(req, RATE_LIMIT_CONFIGS.VERY_STRICâ€¦
    [90m143| [39m      [34mexpect[39m(result[33m.[39mresetAt)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m   | [39m                             [31m^[39m
    [90m144| [39m      [34mexpect[39m(result[33m.[39mresetAt[33m![39m)[33m.[39m[34mtoBeGreaterThan[39m([33mDate[39m[33m.[39m[34mnow[39m())[33m;[39m
    [90m145| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[11/18]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m security-tests/unit/rate-limiter.test.ts[2m > [22mRate Limiter[2m > [22mNamespace isolation[2m > [22mdifferent namespaces track independently
[31m[1mAssertionError[22m: expected undefined to be false // Object.is equality[39m

[32m- Expected:[39m 
false

[31m+ Received:[39m 
undefined

[36m [2mâ¯[22m security-tests/unit/rate-limiter.test.ts:[2m157:31[22m[39m
    [90m155| [39m      }
    [90m156| [39m      const resultA = checkRateLimit(req, RATE_LIMIT_CONFIGS.VERY_STRIâ€¦
    [90m157| [39m      [34mexpect[39m(resultA[33m.[39mallowed)[33m.[39m[34mtoBe[39m([35mfalse[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m158| [39m
    [90m159| [39m      [90m// Namespace B should still work[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[12/18]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m security-tests/unit/rate-limiter.test.ts[2m > [22mRate Limiter[2m > [22mIdentifier isolation[2m > [22mdifferent users (Bearer tokens) track independently
[31m[1mAssertionError[22m: expected undefined to be false // Object.is equality[39m

[32m- Expected:[39m 
false

[31m+ Received:[39m 
undefined

[36m [2mâ¯[22m security-tests/unit/rate-limiter.test.ts:[2m175:31[22m[39m
    [90m173| [39m      }
    [90m174| [39m      const result1 = checkRateLimit(req1, RATE_LIMIT_CONFIGS.VERY_STRâ€¦
    [90m175| [39m      [34mexpect[39m(result1[33m.[39mallowed)[33m.[39m[34mtoBe[39m([35mfalse[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m176| [39m
    [90m177| [39m      [90m// User B should still work[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[13/18]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m security-tests/unit/rate-limiter.test.ts[2m > [22mRate Limiter[2m > [22mclearAllRateLimits[2m > [22mresets all counters
[31m[1mAssertionError[22m: expected undefined to be false // Object.is equality[39m

[32m- Expected:[39m 
false

[31m+ Received:[39m 
undefined

[36m [2mâ¯[22m security-tests/unit/rate-limiter.test.ts:[2m204:31[22m[39m
    [90m202| [39m      }
    [90m203| [39m      const blocked = checkRateLimit(req, RATE_LIMIT_CONFIGS.VERY_STRIâ€¦
    [90m204| [39m      [34mexpect[39m(blocked[33m.[39mallowed)[33m.[39m[34mtoBe[39m([35mfalse[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m205| [39m
    [90m206| [39m      [34mclearAllRateLimits[39m()[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[14/18]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m security-tests/unit/rate-limiter.test.ts[2m > [22mRate Limiter[2m > [22mclearRateLimit[2m > [22mclears a specific identifier
[31m[1mAssertionError[22m: expected undefined to be false // Object.is equality[39m

[32m- Expected:[39m 
false

[31m+ Received:[39m 
undefined

[36m [2mâ¯[22m security-tests/unit/rate-limiter.test.ts:[2m220:31[22m[39m
    [90m218| [39m      }
    [90m219| [39m      const blocked = checkRateLimit(req, RATE_LIMIT_CONFIGS.VERY_STRIâ€¦
    [90m220| [39m      [34mexpect[39m(blocked[33m.[39mallowed)[33m.[39m[34mtoBe[39m([35mfalse[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m221| [39m
    [90m222| [39m      [34mclearRateLimit[39m([32m'user_test-clear-one'[39m[33m,[39m [32m'clear-one'[39m)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[15/18]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m security-tests/integration/admin/admin-access.security.test.ts[2m > [22mPOST /api/admin/set-admin-claim[2m > [22mreturns 200 when admin user requests their own admin claim
[31m[1mAssertionError[22m: expected 429 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 429[39m

[36m [2mâ¯[22m security-tests/integration/admin/admin-access.security.test.ts:[2m462:24[22m[39m
    [90m460| [39m    })[33m;[39m
    [90m461| [39m    [35mconst[39m res [33m=[39m [35mawait[39m [34mcallEndpoint[39m(req)[33m;[39m
    [90m462| [39m    [34mexpect[39m(res[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m463| [39m    [35mconst[39m body [33m=[39m [35mawait[39m res[33m.[39m[34mjson[39m()[33m;[39m
    [90m464| [39m    [34mexpect[39m(body[33m.[39msuccess)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[16/18]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m security-tests/integration/admin/admin-access.security.test.ts[2m > [22mPOST /api/admin/set-admin-claim[2m > [22mcalls setCustomUserClaims with { admin: true } for eligible users
[31m[1mAssertionError[22m: expected "vi.fn()" to be called with arguments: [ 'admin-456', { admin: true } ][90m

Number of calls: [1m0[22m
[31m[39m
[36m [2mâ¯[22m security-tests/integration/admin/admin-access.security.test.ts:[2m482:47[22m[39m
    [90m480| [39m    })[33m;[39m
    [90m481| [39m    [35mawait[39m [34mcallEndpoint[39m(req)[33m;[39m
    [90m482| [39m    expect(mockAdminAuth.setCustomUserClaims).toHaveBeenCalledWith(USEâ€¦
    [90m   | [39m                                              [31m^[39m
    [90m483| [39m      admin[33m:[39m [35mtrue[39m[33m,[39m
    [90m484| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[17/18]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m security-tests/integration/admin/admin-access.security.test.ts[2m > [22mPOST /api/admin/set-admin-claim[2m > [22mreturns 200 with informative message when user already has admin claim
[31m[1mAssertionError[22m: expected 429 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 429[39m

[36m [2mâ¯[22m security-tests/integration/admin/admin-access.security.test.ts:[2m493:24[22m[39m
    [90m491| [39m    })[33m;[39m
    [90m492| [39m    [35mconst[39m res [33m=[39m [35mawait[39m [34mcallEndpoint[39m(req)[33m;[39m
    [90m493| [39m    [34mexpect[39m(res[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m494| [39m    [35mconst[39m body [33m=[39m [35mawait[39m res[33m.[39m[34mjson[39m()[33m;[39m
    [90m495| [39m    [34mexpect[39m(body[33m.[39msuccess)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[18/18]âŽ¯[22m[39m

[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m[1m[41m Unhandled Errors [49m[22m[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m
[31m[1m
Vitest caught 2 unhandled errors during the test run.
This might cause false positive tests. Resolve unhandled errors to make sure your tests are not affected.[22m[39m

[31mâŽ¯âŽ¯âŽ¯âŽ¯[39m[1m[41m Unhandled Rejection [49m[22m[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m
[31m[1mError[22m: Could not load the default credentials. Browse to https://cloud.google.com/docs/authentication/getting-started for more information.[39m
[90m [2mâ¯[22m GoogleAuth.getApplicationDefaultAsync node_modules/google-auth-library/build/src/auth/googleauth.js:[2m287:15[22m[39m
[90m [2mâ¯[22m processTicksAndRejections node:internal/process/task_queues:[2m105:5[22m[39m
[90m [2mâ¯[22m GoogleAuth._GoogleAuth_determineClient node_modules/google-auth-library/build/src/auth/googleauth.js:[2m834:32[22m[39m
[90m [2mâ¯[22m GoogleAuth.getClient node_modules/google-auth-library/build/src/auth/googleauth.js:[2m698:20[22m[39m
[90m [2mâ¯[22m GrpcClient._getCredentials node_modules/google-gax/build/src/grpc.js:[2m145:24[22m[39m
[90m [2mâ¯[22m GrpcClient.createStub node_modules/google-gax/build/src/grpc.js:[2m318:23[22m[39m

[31mThis error originated in "[1msecurity-tests/unit/rate-limiter.test.ts[22m" test file. It doesn't mean the error was thrown inside the file itself, but while it was running.[39m

[31mâŽ¯âŽ¯âŽ¯âŽ¯[39m[1m[41m Unhandled Rejection [49m[22m[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m
[31m[1mError[22m: Could not load the default credentials. Browse to https://cloud.google.com/docs/authentication/getting-started for more information.[39m
[90m [2mâ¯[22m GoogleAuth.getApplicationDefaultAsync node_modules/google-auth-library/build/src/auth/googleauth.js:[2m287:15[22m[39m
[90m [2mâ¯[22m processTicksAndRejections node:internal/process/task_queues:[2m105:5[22m[39m
[90m [2mâ¯[22m GoogleAuth._GoogleAuth_determineClient node_modules/google-auth-library/build/src/auth/googleauth.js:[2m834:32[22m[39m
[90m [2mâ¯[22m GoogleAuth.getClient node_modules/google-auth-library/build/src/auth/googleauth.js:[2m698:20[22m[39m
[90m [2mâ¯[22m GrpcClient._getCredentials node_modules/google-gax/build/src/grpc.js:[2m145:24[22m[39m
[90m [2mâ¯[22m GrpcClient.createStub node_modules/google-gax/build/src/grpc.js:[2m318:23[22m[39m

[31mThis error originated in "[1msecurity-tests/unit/rate-limiter.test.ts[22m" test file. It doesn't mean the error was thrown inside the file itself, but while it was running.[39m
[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m


[2m Test Files [22m [1m[31m2 failed[39m[22m[2m | [22m[1m[32m21 passed[39m[22m[90m (23)[39m
[2m      Tests [22m [1m[31m18 failed[39m[22m[2m | [22m[1m[32m340 passed[39m[22m[90m (358)[39m
[2m     Errors [22m [1m[31m2 errors[39m[22m
[2m   Start at [22m 19:52:20
[2m   Duration [22m 1.70s[2m (transform 5.23s, setup 0ms, collect 8.61s, tests 2.46s, environment 5ms, prepare 450ms)[22m

