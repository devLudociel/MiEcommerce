rules_version = '2';

// Firebase Storage Security Rules
service firebase.storage {
  match /b/{bucket}/o {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() &&
             (request.auth.token.admin == true ||
              request.auth.token.email in [
                // Add admin emails here from your PUBLIC_ADMIN_EMAILS env variable
                // Example: 'admin@example.com'
              ]);
    }

    // Helper function to check file size (max 100MB)
    function isValidSize() {
      return request.resource.size < 100 * 1024 * 1024;
    }

    // Helper function to check if file is an image
    function isImage() {
      return request.resource.contentType.matches('image/.*');
    }

    // Helper function to check if file is allowed type
    function isAllowedFileType() {
      return request.resource.contentType.matches('image/.*') ||
             request.resource.contentType.matches('application/pdf') ||
             request.resource.contentType.matches('application/zip') ||
             request.resource.contentType.matches('application/x-zip-compressed') ||
             request.resource.contentType.matches('image/svg\\+xml');
    }

    // ==========================================================================
    // DIGITAL PRODUCTS: Admin can upload, authenticated users can read
    // ==========================================================================
    match /digital-products/{userId}/{fileName} {
      // Only admins can manage digital product source files
      allow create, update: if isAdmin() &&
                              request.auth.uid == userId &&
                              isValidSize() &&
                              isAllowedFileType();

      // Only admins can read (downloads use signed URLs via server)
      allow read: if isAdmin();

      // Only admins can delete
      allow delete: if isAdmin();
    }

    // ==========================================================================
    // PRODUCT PREVIEWS: Admin can upload, everyone can read
    // ==========================================================================
    match /product-previews/{userId}/{fileName} {
      // Authenticated users can create/update their own folder
      allow create, update: if isAuthenticated() &&
                              request.auth.uid == userId &&
                              isValidSize() &&
                              isImage();

      // Anyone can read (public product images)
      allow read: if true;

      // Only file owner or admin can delete
      allow delete: if isAuthenticated() &&
                      (request.auth.uid == userId || isAdmin());
    }

    // ==========================================================================
    // CLIPARTS: Admin can upload, everyone can read
    // ==========================================================================
    match /cliparts/{fileName} {
      // SECURITY FIX: Only ADMINS can create/update cliparts
      allow create, update: if isAdmin() && isValidSize() && isImage();

      // Anyone can read (public cliparts)
      allow read: if true;

      // Only admins can delete
      allow delete: if isAdmin();
    }

    // ==========================================================================
    // USER UPLOADS: Customization images
    // ==========================================================================
    match /uploads/{userId}/{fileName} {
      // Users can only upload to their own folder
      allow create, update: if isAuthenticated() &&
                              request.auth.uid == userId &&
                              isValidSize() &&
                              isImage();

      // Anyone can read (for product previews)
      allow read: if true;

      // Users can only delete their own files
      allow delete: if isAuthenticated() && request.auth.uid == userId;
    }

    // ==========================================================================
    // CUSTOMIZATION IMAGES: Product customization uploads
    // ==========================================================================
    match /customization/{fileName} {
      // Authenticated users can upload
      allow create, update: if isAuthenticated() && isValidSize() && isImage();

      // Anyone can read
      allow read: if true;

      // SECURITY FIX: Only admins can delete customization files
      // (Cannot verify ownership without userId in path, so restrict to admin)
      allow delete: if isAdmin();
    }

    // ==========================================================================
    // PERSONALIZACIONES: User customization images organized by user and product type
    // ==========================================================================
    match /personalizaciones/{userId}/{productType}/{fileName} {
      // Users can upload to their own folder
      allow create, update: if isAuthenticated() &&
                              request.auth.uid == userId &&
                              isValidSize() &&
                              isImage();

      // Anyone can read (for order fulfillment and previews)
      allow read: if true;

      // Only file owner or admin can delete
      allow delete: if isAuthenticated() &&
                      (request.auth.uid == userId || isAdmin());
    }

    // ==========================================================================
    // PROFILE IMAGES: User avatars
    // ==========================================================================
    match /profiles/{userId}/{fileName} {
      // Users can only upload to their own profile
      allow create, update: if isAuthenticated() &&
                              request.auth.uid == userId &&
                              isValidSize() &&
                              isImage();

      // Anyone can read
      allow read: if true;

      // Only owner can delete
      allow delete: if isAuthenticated() && request.auth.uid == userId;
    }

    // ==========================================================================
    // PRODUCTS: Admin product images
    // ==========================================================================
    match /products/{fileName} {
      // SECURITY FIX: Only ADMINS can upload product images
      allow create, update: if isAdmin() &&
                              isValidSize() &&
                              isImage();

      // Anyone can read (public product images)
      allow read: if true;

      // SECURITY FIX: Only admins can delete
      allow delete: if isAdmin();
    }

    // ==========================================================================
    // USER CUSTOMIZER DESIGNS: Saved designs from customizer
    // ==========================================================================
    match /users/{userId}/customizer-designs/{fileName} {
      // Users can only upload to their own folder
      allow create, update: if isAuthenticated() &&
                              request.auth.uid == userId &&
                              isValidSize() &&
                              isImage();

      // Anyone can read (for previews and order processing)
      allow read: if true;

      // Users can only delete their own files or admin
      allow delete: if isAuthenticated() &&
                      (request.auth.uid == userId || isAdmin());
    }

    // ==========================================================================
    // USER FILES: General user uploaded files
    // ==========================================================================
    match /users/{userId}/files/{fileName} {
      // Users can only upload to their own folder
      allow create, update: if isAuthenticated() &&
                              request.auth.uid == userId &&
                              isValidSize() &&
                              isAllowedFileType();

      // Anyone can read (for order processing)
      allow read: if true;

      // Users can only delete their own files or admin
      allow delete: if isAuthenticated() &&
                      (request.auth.uid == userId || isAdmin());
    }

    // ==========================================================================
    // PAGES IMAGES: Images for blog posts and pages
    // ==========================================================================
    match /pages/{fileName} {
      // SECURITY FIX: Only ADMINS can upload page images
      allow create, update: if isAdmin() &&
                              isValidSize() &&
                              isImage();

      // Anyone can read (public images for pages/blog)
      allow read: if true;

      // SECURITY FIX: Only admins can delete
      allow delete: if isAdmin();
    }

    // ==========================================================================
    // CARD OPTIONS: Theme/design images for card_selector fields
    // ==========================================================================
    match /card-options/{userId}/{fileName} {
      // Authenticated users can upload to their own folder
      allow create, update: if isAuthenticated() &&
                              request.auth.uid == userId &&
                              isValidSize() &&
                              isImage();

      // Anyone can read (public theme images)
      allow read: if true;

      // Only file owner or admin can delete
      allow delete: if isAuthenticated() &&
                      (request.auth.uid == userId || isAdmin());
    }

    // ==========================================================================
    // VARIANTS: Product variant preview images (colors, sizes, etc.)
    // ==========================================================================
    match /variants/{variantType}/{variantKey}/{fileName} {
      // SECURITY FIX: Only ADMINS can upload variant images
      allow create, update: if isAdmin() &&
                              isValidSize() &&
                              isImage();

      // Anyone can read (public variant images)
      allow read: if true;

      // SECURITY FIX: Only admins can delete
      allow delete: if isAdmin();
    }

    // ==========================================================================
    // THEMES: Centralized theme images for product customization
    // ==========================================================================
    match /themes/{userId}/{themeId}/{fileName} {
      // Authenticated users can upload to their own folder
      allow create, update: if isAuthenticated() &&
                              request.auth.uid == userId &&
                              isValidSize() &&
                              isImage();

      // Anyone can read (public theme images)
      allow read: if true;

      // Only file owner or admin can delete
      allow delete: if isAuthenticated() &&
                      (request.auth.uid == userId || isAdmin());
    }

    // ==========================================================================
    // HERO BANNERS: Banner images for the main carousel
    // ==========================================================================
    match /banners/{fileName} {
      // SECURITY FIX: Only ADMINS can upload banner images
      allow create, update: if isAdmin() &&
                              isValidSize() &&
                              isImage();

      // Anyone can read (public banner images)
      allow read: if true;

      // SECURITY FIX: Only admins can delete
      allow delete: if isAdmin();
    }

    // ==========================================================================
    // TESTIMONIALS: Avatar images for testimonials
    // ==========================================================================
    match /testimonials/{fileName} {
      // SECURITY FIX: Only ADMINS can upload testimonial images
      allow create, update: if isAdmin() &&
                              isValidSize() &&
                              isImage();

      // Anyone can read (public testimonial avatars)
      allow read: if true;

      // SECURITY FIX: Only admins can delete
      allow delete: if isAdmin();
    }

    // ==========================================================================
    // DENY ALL OTHER PATHS
    // ==========================================================================
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
